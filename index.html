<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NM COMPENSADOS - Controle de Produ√ß√£o</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìã</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
      const SUPABASE_URL = 'https://lhjipwizdefpkwndbhfq.supabase.co';      // <<====== COPIE E COLE SUA URL DO SUPABASE AQUI
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxoamlwd2l6ZGVmcGt3bmRiaGZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NjUyMzksImV4cCI6MjA3NTM0MTIzOX0.maycHg5S6xf2AynM3ECFVEcMxMIY6VzlQAwbnbFrvWg'; // <<====== COPIE E COLE SUA CHAVE 'anon public' AQUI
    
      // Inicializa o cliente do Supabase
      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    </script>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --success-color: #16a34a;
            --warning-color: #d97706;
            --danger-color: #dc2626;
            --info-color: #0891b2;
            --dark-color: #1f2937;
            --light-color: #f8fafc;
            --border-color: #e2e8f0;
            --forest-green: #22c55e;
            --nature-brown: #8b5a3c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Tahoma', sans-serif;
            background: linear-gradient(135deg, var(--forest-green), var(--primary-color));
            color: var(--dark-color);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .company-logo-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .company-logo {
            width: 120px;
            height: 120px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .company-info h1 {
            font-size: 2.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.4);
            letter-spacing: 2px;
        }

        .company-info p {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 500;
        }

        /* O antigo .nav-tabs √© agora o menu lateral, estilizado abaixo */
        .tab-content {
            display: none;
            background: white;
            padding: 2rem;
            border-radius: 15px;
            /* Arredondado em todos os cantos */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            min-height: 600px;
        }

        .tab-content.active {
            display: block;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 0.25rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-info {
            background: var(--info-color);
            color: white;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .table th,
        .table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
        }

        .table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .table tbody tr:hover {
            background-color: var(--light-color);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--dark-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .input-group select,
        .input-group input {
            flex-grow: 1;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid var(--info-color);
        }

        .alert-success {
            background: #dcfce7;
            color: #16a34a;
            border-left: 4px solid var(--success-color);
        }

        .alert-warning {
            background: #fef3c7;
            color: #d97706;
            border-left: 4px solid var(--warning-color);
        }

        .alert-danger {
            background: #fee2e2;
            color: #dc2626;
            border-left: 4px solid var(--danger-color);
        }

        .card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            border-top: 4px solid var(--primary-color);
        }

        .card h3 {
            margin-bottom: 1rem;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 2rem 0;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            background: var(--success-color);
            color: white;
        }

        .connection-status.disconnected {
            background: var(--danger-color);
            color: white;
        }

        .connection-status.connecting {
            background: var(--warning-color);
            color: white;
        }

        .db-config {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .db-config label {
            color: white;
            margin-bottom: 0.5rem;
            display: block;
            font-weight: 600;
        }

        .db-config input,
        .db-config select {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: var(--dark-color);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            background: var(--success-color);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.2s ease-in-out;
        }

        .modal.show .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: var(--danger-color);
        }

        .codigo-input-group {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .codigo-input-group input {
            flex: 1;
        }

        .codigo-input-group button {
            white-space: nowrap;
        }

        .gerencial-header {
            background: linear-gradient(135deg, var(--forest-green), var(--primary-color));
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .gerencial-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 2px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .gerencial-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        .gerencial-main-panel {
            flex: 3;
            min-width: 500px;
        }

        .gerencial-side-panel {
            flex: 2;
            min-width: 300px;
        }

        .turno-title {
            background: linear-gradient(135deg, var(--warning-color), #f59e0b);
            color: white;
            text-align: center;
            padding: 1rem;
            border-radius: 8px;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .mesa-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .mesa-card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }

        .mesa-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .mesa-header {
            background: #ffc107;
            color: #000;
            padding: 0.5rem;
            margin: -1rem -1rem 0.5rem -1rem;
            border-radius: 6px 6px 0 0;
            font-weight: bold;
            font-size: 0.875rem;
        }

        .mesa-value {
            font-weight: 800;
            font-size: 1.25rem;
        }

        .valor-azul {
            color: #1d4ed8;
            font-weight: 800;
            font-size: 28px;
            line-height: 1.1;
        }

        .card-topo-amarelo {
            background: #f59e0b;
            color: #000;
            font-weight: 700;
            text-align: center;
            padding: 8px 10px;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            letter-spacing: 0.2px;
        }

        .total-turno .mesa-header {
            background: #1f2937;
            color: #fff;
        }

        .produto-selecionado-display {
            background-color: #eef2ff;
            color: var(--secondary-color);
            padding: 0.75rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            font-weight: 600;
            min-height: 45px;
            border: 1px solid #c7d2fe;
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 1.5rem;
            gap: 0.5rem;
        }

        tr.is-editing td {
            background-color: #fffbeb !important;
        }

        #esqGerencialTbody tr {
            cursor: pointer;
        }

        #esqGerencialTbody tr.selected-day {
            background-color: #dbeafe !important;
            font-weight: bold;
        }

        .perc-list {
            list-style: none;
            padding: 0;
        }

        .perc-list li {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0.25rem;
            border-bottom: 1px solid var(--border-color);
        }

        .perc-list li:last-child {
            border-bottom: none;
        }

        .perc-list .tamanho {
            font-size: 0.9rem;
        }

        .perc-list .valor {
            font-weight: 600;
        }

        .perc-list .percentual {
            color: var(--primary-color);
            font-weight: bold;
        }

        .table td input,
        .table td select {
            padding: 0.5rem;
            font-size: 0.9rem;
        }

        /* IN√çCIO: ESTILOS DO MENU LATERAL */
        .main-layout {
            /* display: flex; removido para que o menu possa sobrepor o conte√∫do */
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100%;
            z-index: 1002;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            width: 280px;
            flex-shrink: 0;
            background: white;
            border-radius: 0 15px 15px 0;
            /* Arredondado s√≥ na direita */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            padding: 10px;
        }

        .sidebar.is-open {
            transform: translateX(0);
        }

        .sidebar .nav-tabs {
            flex-direction: column;
            justify-content: flex-start;
            padding: 0.5rem;
            list-style: none;
            overflow: visible;
            /* Remover o overflow hidden do original */
        }

        .sidebar .nav-tab {
            display: flex;
            align-items: center;
            width: 100%;
            text-align: left;
            padding: 0.9rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            border: 1px solid transparent;
            font-size: 0.9rem;
            background: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--dark-color);
        }

        .sidebar .nav-tab:hover {
            background-color: var(--light-color);
            transform: none;
            /* Sobrescreve o efeito hover do menu horizontal */
        }

        .sidebar .nav-tab.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .sidebar .nav-tab .icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            opacity: 0.6;
            transition: all 0.3s ease;
            stroke-width: 2;
        }

        .sidebar .nav-tab:hover .icon {
            opacity: 1;
        }

        .sidebar .nav-tab.active .icon {
            opacity: 1;
            /* A cor do √≠cone (stroke) √© alterada para branco via CSS filter */
            filter: brightness(0) invert(1);
        }

        .main-content {
            width: 100%;
            min-width: 0;
        }

        .mobile-menu-toggle {
            display: flex;
            /* Sempre vis√≠vel */
            align-items: center;
            justify-content: center;
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
        }

        .mobile-menu-toggle svg {
            width: 24px;
            height: 24px;
            margin: auto;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            /* Fica abaixo do menu e acima do conte√∫do */
        }

        .sidebar-header {
            display: flex;
            /* Sempre vis√≠vel para conter o bot√£o de fechar */
            justify-content: flex-end;
            padding-bottom: 10px;
        }

        .sidebar-close-button {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }

        .sidebar-close-button:hover {
            background-color: var(--border-color);
        }

        .sidebar-close-button svg {
            width: 22px;
            height: 22px;
            color: var(--dark-color);
            opacity: 0.7;
        }

        /* FIM: ESTILOS DO MENU LATERAL */


        /* IN√çCIO: RESPONSIVIDADE */
        /* Media queries foram simplificadas, pois o comportamento principal agora √© global */

        @media (max-width: 992px) {
            .sidebar-overlay.is-open {
                display: block;
            }

            .connection-status {
                display: none;
                /* Ocultar para n√£o sobrepor o menu mobile */
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                padding: 1.5rem;
            }

            .company-info h1 {
                font-size: 2rem;
            }

            .company-logo {
                width: 80px;
                height: 80px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* FIM: RESPONSIVIDADE */
    </style>
</head>

<body>
    <div class="connection-status disconnected" id="connectionStatus">Desconectado</div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
    <div class="notification" id="notification"></div>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="container">
        <div class="header">
            <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Abrir menu">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <div class="company-logo-section">
                <img alt="COMPENSADOS NM" class="company-logo"
                    src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxkZWZzPgo8bGluZWFyR3JhZGllbnQgaWQ9ImZvcmVzdEdyYWRpZW50IiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj4KPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6IzIyYzU1ZTtzdG9wLW9wYWNpdHk6MSIgLz4KPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojMTZhMzRhO3N0b3Atb3BhY2l0eToxIiAvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiByeD0iMTUiIGZpbGw9InVybCgjZm9yZXN0R3JhZGllbnQpIiAvPgo8dGV4dCB4PSI2MCIgeT0iNDUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5OTTwvdGV4dD4KPHRleHQgeD0iNjAiIHk9IjgwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iOCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkNPTVBFTlNBRE9TPC90ZXh0Pgo8cG9seWdvbiBwb2ludHM9IjIwLDMwIDQwLDQwIDYwLDQ1IDgwLDQwIDEwMCwzMCAxMDAsOTUgMjAsOTUiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4xKSIgLz4KPHBvbHlnb24gcG9pbnRzPSIzMCwzNSA1MCw0MCA3MCw0MiA5MCw0MCAxMTAsMzUgMTEwLDgwIDMwLDgwIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMDUpIi8+Cjwvc3ZnPg==" />
                <div class="company-info">
                    <h1>COMPENSADOS NM</h1>
                    <p>Sistema Completo de Controle de Produ√ß√£o Industrial</p>
                </div>
            </div>
        </div>

        <div class="db-config">
            <h3 style="color: white; margin-bottom: 1rem;">Configura√ß√£o do Servidor</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="dbHost">Host/Servidor</label>
                    <input id="dbHost" placeholder="localhost ou IP do servidor" type="text" value="localhost" />
                </div>
                <div class="form-group">
                    <label for="dbPort">Porta</label>
                    <input id="dbPort" placeholder="3001" type="number" value="3001" />
                </div>
            </div>
            <div style="text-align: center;">
                <button class="btn btn-success" id="btnConectar">Conectar ao Servidor</button>
                <button class="btn btn-info" onclick="testarConexao()">Testar Conex√£o</button>
            </div>
        </div>

        <div class="main-layout">
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <button class="sidebar-close-button" id="sidebarCloseButton" aria-label="Recolher menu">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <nav>
                    <!-- O ID navTabs √© mantido para compatibilidade com o JS existente -->
                    <ul class="nav-tabs" id="navTabs">
                        <li><button class="nav-tab active" data-tab="dashboard"><svg class="icon"
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="3" width="7" height="7"></rect>
                                    <rect x="14" y="3" width="7" height="7"></rect>
                                    <rect x="14" y="14" width="7" height="7"></rect>
                                    <rect x="3" y="14" width="7" height="7"></rect>
                                </svg><span>Dashboard</span></button></li>
                        <li><button class="nav-tab" data-tab="gerencial"><svg class="icon"
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M2.5 2v6h6M2.66 15.57a10 10 0 1 0 .57-8.38" />
                                </svg><span>Gerencial</span></button></li>
                        <li><button class="nav-tab" data-tab="gerencial-acabamento"><svg class="icon"
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 20V10M18 20V4M6 20v-4" />
                                </svg><span>Gerencial Acabamento</span></button></li>
                        <li><button class="nav-tab" data-tab="importar"><svg class="icon"
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" />
                                </svg><span>Importar</span></button></li>
                        <li><button class="nav-tab" data-tab="produtos"><svg class="icon"
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                    <path
                                        d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
                                    <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
                                    <line x1="12" y1="22.08" x2="12" y2="12" />
                                </svg><span>Produtos</span></button></li>
                        <li><button class="nav-tab" data-tab="turnos"><svg class="icon"
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg><span>Turnos</span></button></li>
                        <li><button class="nav-tab" data-tab="producao"><svg class="icon"
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                    <path
                                        d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41" />
                                    <circle cx="12" cy="12" r="5" />
                                    <path d="M12 1v1M23 12h-1M12 23v-1M1 12H0" />
                                </svg><span>Produ√ß√£o</span></button></li>
                        <li><button class="nav-tab" data-tab="esquadrejadeira"><svg class="icon"
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                    <path
                                        d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" />
                                    <path d="M12 9v4" />
                                </svg><span>Esquadrejadeira</span></button></li>
                        <li>
                            <button class="nav-tab" data-tab="prensa">
                                <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="3" width="18" height="6"></rect>
                                    <rect x="3" y="15" width="18" height="6"></rect>
                                    <line x1="3" y1="9" x2="21" y2="9"></line>
                                    <line x1="3" y1="15" x2="21" y2="15"></line>
                                </svg>
                                <span>Prensa</span>
                            </button>
                        </li>
                        <li><button class="nav-tab" data-tab="descarte"><svg class="icon"
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path
                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                    </path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg><span>Descarte</span></button></li>
                        <li><button class="nav-tab" data-tab="consulta"><svg class="icon"
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg><span>Consulta</span></button></li>
                        <li><button class="nav-tab" data-tab="relatorios"><svg class="icon"
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                    <polyline points="10 9 9 9 8 9"></polyline>
                                </svg><span>Relat√≥rios</span></button></li>
                        <li><button class="nav-tab" data-tab="secador"><svg class="icon"
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M6 2v12M18 2v12M4 14h16M2 21h20M4 2h16" />
                                </svg><span>Secador</span></button></li>
                        <li><button class="nav-tab" data-tab="estoque"><svg class="icon"
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="3" y1="9" x2="21" y2="9"></line>
                                    <line x1="9" y1="21" x2="9" y2="9"></line>
                                </svg><span>Sistema Estoque</span></button></li>
                        <li><button class="nav-tab" data-tab="torno"><svg class="icon"
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="8"></circle>
                                    <line x1="12" y1="8" x2="12" y2="16"></line>
                                    <line x1="8" y1="12" x2="16" y2="12"></line>
                                </svg><span>Torno</span></button></li>
                        <li><button class="nav-tab" data-tab="detalhes-turno"><svg class="icon"
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                    <polyline points="10 9 9 9 8 9"></polyline>
                                </svg><span>Detalhes por Turno</span></button></li>
                    </ul>

                </nav>
            </aside>
            <main class="main-content">
                <!-- Dashboard -->
                <div class="tab-content active" id="dashboard">
                    <h2>Dashboard de Produ√ß√£o</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalProdutos">0</div>
                            <div>Produtos Cadastrados</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalProducao">0</div>
                            <div>Total Produzido (m¬≥)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalDescarte">0</div>
                            <div>Total Descarte (Chapas)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="eficiencia">0%</div>
                            <div>Efici√™ncia</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Produ√ß√£o por Turno (m¬≥)</h3>
                        <div class="chart-container">
                            <canvas id="chartProducaoTurno"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Evolu√ß√£o da Produ√ß√£o nos √öltimos 30 Dias (m¬≥)</h3>
                        <div class="chart-container">
                            <canvas id="chartEvolucaoProducao"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Gerencial -->
                <div class="tab-content" id="gerencial">
                    <div class="gerencial-header"
                        style="margin-bottom: 12px; display: flex; align-items: center; flex-wrap: wrap;">
                        <label for="filtroDataGerencial" style="font-weight:600; margin-right: 0.5rem;">Selecione a
                            data:</label>
                        <input id="filtroDataGerencial" type="date" style="margin-right: 1rem;" />
                        <button class="btn btn-success" onclick="App.logic.sync.updateGerencial()">Atualizar</button>
                        <button class="btn btn-info" onclick="exportarPrintGerencial()">üì∏ Exportar Prints
                            Gerenciais</button>
                    </div>

                    <div class="gerencial-section" id="totaisGeraisDia">
                        <div class="turno-title">Totais gerais do dia</div>
                        <div class="mesa-grid" id="cardsTotaisDia"></div>
                    </div>

                    <div class="gerencial-section" id="mediasMes">
                        <div class="turno-title">Resumo do M√™s</div>
                        <div class="mesa-grid" id="cardsMediasMes"></div>
                    </div>

                    <div class="gerencial-section" id="secao1T">
                        <div class="turno-title">1¬∫ TURNO</div>
                        <div class="mesa-grid" id="grid1T"></div>
                    </div>

                    <div class="gerencial-section" id="secao2T">
                        <div class="turno-title">2¬∫ TURNO</div>
                        <div class="mesa-grid" id="grid2T"></div>
                    </div>

                    <div class="gerencial-section" id="secao3ElevEsteira" data-tabela="turno3-elevada-esteira">
                        <div class="turno-title">3¬∫ TURNO ‚Ä¢ MESA ELEVADA ‚Ä¢ ESTEIRA</div>
                        <div class="mesa-grid" id="grid3ElevEsteira"></div>
                    </div>

                    <div class="gerencial-section">
                        <div class="turno-title">Produ√ß√£o Semanal por Fam√≠lia (m¬≥)</div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Exporta√ß√£o</th>
                                        <th>Plastificado</th>
                                        <th>Resinado</th>
                                        <th>Moveleiro</th>
                                        <th>T. Di√°rio</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodySemanal"></tbody>
                                <tfoot>
                                    <tr style="font-weight:bold; background:#fff7ed;">
                                        <td>M√©dia Semanal</td>
                                        <td id="mediaSemanalExportacao">0.000</td>
                                        <td id="mediaSemanalPlastificado">0.000</td>
                                        <td id="mediaSemanalResinado">0.000</td>
                                        <td id="mediaSemanalMoveleiro">0.000</td>
                                        <td id="mediaSemanalGeral">0.000</td>
                                    </tr>
                                    <tr style="font-weight:bold; background:#dcfce7;">
                                        <td>Acumulado Semanal</td>
                                        <td id="totalSemanalExportacao">0.000</td>
                                        <td id="totalSemanalPlastificado">0.000</td>
                                        <td id="totalSemanalResinado">0.000</td>
                                        <td id="totalSemanalMoveleiro">0.000</td>
                                        <td id="totalSemanalGeral">0.000</td>
                                    </tr>
                                    <tr style="font-weight: bold; background:#e0f7fa;">
                                        <td>M√©dia Acumulada Mensal</td>
                                        <td id="mediaMensalExportacao">0.000</td>
                                        <td id="mediaMensalPlastificado">0.000</td>
                                        <td id="mediaMensalResinado">0.000</td>
                                        <td id="mediaMensalMoveleiro">0.000</td>
                                        <td id="mediaMensalGeral">0.000</td>
                                    </tr>
                                    <tr style="font-weight: bold; background-color: #cff4fc;">
                                        <td>Acumulado Mensal</td>
                                        <td id="totalMensalExportacao">0.000</td>
                                        <td id="totalMensalPlastificado">0.000</td>
                                        <td id="totalMensalResinado">0.000</td>
                                        <td id="totalMensalMoveleiro">0.000</td>
                                        <td id="totalMensalGeral">0.000</td>
                                    </tr>
                                    <tr style="font-weight: bold; background:#eef2ff;">
                                        <td>% no m√™s</td>
                                        <td id="percentMensalExportacao">0,0%</td>
                                        <td id="percentMensalPlastificado">0,0%</td>
                                        <td id="percentMensalResinado">0,0%</td>
                                        <td id="percentMensalMoveleiro">0,0%</td>
                                        <td id="percentMensalGeral">100,0%</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Gerencial Acabamento -->
                <div class="tab-content" id="gerencial-acabamento">
                    <div class="card">
                        <div class="form-row" style="align-items: center; justify-content: space-between;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="esqGerencialDataRef">Data de Refer√™ncia</label>
                                <input type="date" id="esqGerencialDataRef" />
                            </div>
                            <h3 id="esqGerencialTituloSemana"
                                style="margin-bottom: 0; border: none; text-align: center;"></h3>
                            <div>
                                <button id="btnSemanaAnterior" class="btn btn-secondary">‚üµ Semana Anterior</button>
                                <button id="btnSemanaSeguinte" class="btn btn-secondary">Semana Seguinte ‚ü∂</button>
                                <button class="btn btn-info" onclick="exportarPrintGerencialAcabamento()">üì∏ Exportar
                                    Print</button>
                            </div>
                        </div>
                    </div>

                    <div class="gerencial-container">
                        <div class="gerencial-main-panel">
                            <div class="card">
                                <h3>Produ√ß√£o Semanal por Turno (Esquadrejadeira)</h3>
                                <div class="table-container">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Dia da Semana</th>
                                                <th>1¬∫ Turno (chapas | m¬≥)</th>
                                                <th>2¬∫ Turno (chapas | m¬≥)</th>
                                                <th>Total Dia (chapas | m¬≥)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="esqGerencialTbody">
                                            <!-- 7 Linhas ser√£o geradas aqui via JS -->
                                        </tbody>
                                        <tfoot>
                                            <tr style="font-weight:bold; background:#fff7ed;">
                                                <td>M√©dia Semanal</td>
                                                <td id="esqGerencialMedia1T">0 | 0.000</td>
                                                <td id="esqGerencialMedia2T">0 | 0.000</td>
                                                <td id="esqGerencialMediaTotal">0 | 0.000</td>
                                            </tr>
                                            <tr style="font-weight:bold; background:#dcfce7;">
                                                <td>Acumulado Semanal</td>
                                                <td id="esqGerencialAcumulado1T">0 | 0.000</td>
                                                <td id="esqGerencialAcumulado2T">0 | 0.000</td>
                                                <td id="esqGerencialAcumuladoTotal">0 | 0.000</td>
                                            </tr>
                                            <tr style="font-weight: bold; background-color: #cff4fc;">
                                                <td>Acumulado Mensal (MTD)</td>
                                                <td id="esqGerencialMtd1T">0 | 0.000</td>
                                                <td id="esqGerencialMtd2T">0 | 0.000</td>
                                                <td id="esqGerencialMtdTotal">0 | 0.000</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="gerencial-side-panel">
                            <div class="card" id="esqGerencialPercentuais">
                                <h3>Percentual por Tamanho (m¬≥)</h3>
                                <div class="card" style="border-top-color: var(--info-color);">
                                    <h4 id="percDiaTitulo" style="font-size: 1rem; color: var(--info-color);">% do Dia
                                        (DD/MM/YYYY)</h4>
                                    <ul id="percDiaContainer" class="perc-list">
                                        <li>Nenhum dia selecionado.</li>
                                    </ul>
                                </div>
                                <div class="card" style="margin-bottom: 0; border-top-color: var(--success-color);">
                                    <h4 style="font-size: 1rem; color: var(--success-color);">% no M√™s (Acumulado)</h4>
                                    <ul id="percMesContainer" class="perc-list">
                                        <li>Nenhum dado no m√™s.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-content" id="detalhes-turno">
                    <div class="card">
                        <h3>Detalhes de Produ√ß√£o e Descarte por Turno</h3>

                        <div id="detalhesTurnoToolbar" class="detalhes-turno-toolbar">
                            <div class="toolbar-filters">
                                <div class="form-group">
                                    <label for="filtroDataDetalhesTurno">Data de Refer√™ncia</label>
                                    <input type="date" id="filtroDataDetalhesTurno" />
                                </div>
                                <div class="form-group">
                                    <label for="buscaDetalhesAba">Buscar Produto</label>
                                    <input type="text" id="buscaDetalhesAba" placeholder="C√≥digo/Descri√ß√£o..." />
                                </div>
                                <div class="form-group">
                                    <label for="filtroFamiliaDetalhes">Filtrar Fam√≠lia</label>
                                    <select id="filtroFamiliaDetalhes" multiple style="height: 58px;"></select>
                                </div>
                            </div>
                            <div class="toolbar-actions">
                                <div class="form-group">
                                    <button class="btn btn-primary" id="btnBuscarDetalhesAba">Buscar</button>
                                </div>
                                <div class="form-group">
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                        <button id="btnExportarCsvDetalhes" class="btn btn-success btn-sm">Exportar
                                            CSV</button>
                                        <button id="btnGerarPngs" class="btn btn-info btn-sm">Salvar Imagens
                                            (PNG)</button>
                                        <button id="btnCopiarResumo" class="btn btn-secondary btn-sm">Copiar
                                            Resumo</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="detalhesTurnoContent" style="margin-top: 1.5rem;">
                            <div class="alert alert-info">Selecione uma data e clique em "Buscar" para ver os detalhes.
                            </div>
                        </div>

                        <div id="detalhesTurnoTotals" class="card"
                            style="margin-top: 1.5rem; background: var(--dark-color); color: white;">
                        </div>

                    </div>
                </div>


                <!-- Importar -->
                <div class="tab-content" id="importar">
                    <div class="card">
                        <h3>Importar Produtos</h3>
                        <div class="alert alert-info">
                            <strong>Instru√ß√µes:</strong> Selecione um arquivo Excel (.xlsx ou .xls).
                            As colunas necess√°rias s√£o: CODIGO, DESCRI√á√ÉO PRODUTO, COMPRIMENTO, LARGURA, BITOLA.
                        </div>
                        <input accept=".xlsx,.xls" class="form-group" id="fileInput" type="file" />
                        <button class="btn btn-primary" onclick="importarArquivo()">Processar Arquivo</button>
                        <div class="alert" id="importStatus" style="display: none;"></div>
                    </div>
                </div>

                <!-- Produtos -->
                <div class="tab-content" id="produtos">
                    <div class="card">
                        <h3>Cat√°logo de Produtos</h3>
                        <button class="btn btn-primary" onclick="abrirModalProduto()">Novo Produto</button>
                        <button class="btn btn-success" onclick="exportarProdutos()">Exportar Produtos</button>

                        <div class="form-group">
                            <label for="buscarProduto">Buscar Produto</label>
                            <input id="buscarProduto" placeholder="Digite para buscar..." type="text" />
                        </div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th data-sort="Codigo" style="cursor: pointer;">C√≥digo</th>
                                        <th data-sort="Descricao" style="cursor: pointer;">Descri√ß√£o</th>
                                        <th data-sort="Comprimento_m" style="cursor: pointer;">Comprimento</th>
                                        <th data-sort="Largura_m" style="cursor: pointer;">Largura</th>
                                        <th data-sort="Bitola_m" style="cursor: pointer;">Bitola</th>
                                        <th data-sort="FamiliaID" style="cursor: pointer;">Fam√≠lia</th>
                                        <th data-sort="Cubagem_m3" style="cursor: pointer;">Cubagem (m¬≥)</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="produtosTbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Turnos -->
                <div class="tab-content" id="turnos">
                    <div class="card">
                        <h3>Gest√£o de Turnos</h3>
                        <button class="btn btn-primary" onclick="abrirModalTurno()">Novo Turno</button>
                        <button class="btn btn-success" onclick="exportarTurnos()">Exportar Turnos</button>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nome do Turno</th>
                                        <th>Status</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="turnosTbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Produ√ß√£o -->
                <div class="tab-content" id="producao">
                    <!-- PAINEL DE CONTROLE DE DATA E TOTAIS -->
                    <div class="card" style="background-color: #f1f5f9; border-top-color: var(--info-color);">
                        <div class="form-row" style="align-items: flex-end; margin-bottom: 0;">
                            <div class="form-group">
                                <label for="dataReferencia" style="font-weight: bold;">üìÖ Data de Refer√™ncia</label>
                                <input id="dataReferencia" type="date" />
                            </div>
                            <div class="form-group">
                                <div class="stat-card" style="padding: 1rem; background: var(--secondary-color);">
                                    <div style="font-size: 0.9rem; opacity: 0.8;">Total Chapas (dia)</div>
                                    <div class="stat-value" id="totalChapasDia"
                                        style="font-size: 1.5rem; margin-bottom: 0;">0</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="stat-card" style="padding: 1rem; background: var(--success-color);">
                                    <div style="font-size: 0.9rem; opacity: 0.8;">Total Volume (dia)</div>
                                    <div class="stat-value" id="totalVolumeDia"
                                        style="font-size: 1.5rem; margin-bottom: 0;">0.000 m¬≥</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Registro de Produ√ß√£o</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="codigoInput">C√≥digo do Produto *</label>
                                <div class="codigo-input-group">
                                    <input id="codigoInput" placeholder="Digite o c√≥digo e tecle Enter" type="text" />
                                    <button class="btn btn-info btn-sm" onclick="toggleSelect('produtoCodigo')"
                                        type="button">Ver Lista</button>
                                </div>
                                <select id="produtoCodigo" style="margin-top: 0.5rem; display: none;"></select>
                                <div id="descricaoProdutoPreview"
                                    style="margin-top: 0.5rem; font-weight: 600; color: #1e40af;"></div>
                            </div>
                            <div class="form-group">
                                <label for="quantidade">Quantidade (chapas) *</label>
                                <input id="quantidade" min="1" required step="1" type="number" />
                            </div>
                            <div class="form-group">
                                <label for="turnoDetalhado">Turno *</label>
                                <select id="turnoDetalhado" required></select>
                            </div>
                            <div class="form-group">
                                <label for="dataProducao">Data da Produ√ß√£o *</label>
                                <input id="dataProducao" required type="date" />
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="obsProducao">Observa√ß√µes</label>
                                <textarea id="obsProducao" rows="1" placeholder="Opcional"></textarea>
                            </div>
                        </div>
                        <button class="btn btn-success" id="btnRegistrarProducao"
                            onclick="registrarProducao()">Registrar Produ√ß√£o (Ctrl+Enter)</button>
                    </div>

                    <div class="card">
                        <h3>Lan√ßamentos do Dia</h3>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>C√≥digo</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Qtd.</th>
                                        <th>Turno</th>
                                        <th>Obs</th>
                                        <th>Lan√ßamento</th>
                                        <th>Cubagem (m¬≥)</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="producaoDiaTbody">
                                    <!-- Linhas inseridas via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Esquadrejadeira -->
                <div class="tab-content" id="esquadrejadeira">
                    <!-- PAINEL DE CONTROLE DE DATA E TOTAIS -->
                    <div class="card" style="background-color: #f1f5f9; border-top-color: var(--info-color);">
                        <div class="form-row" style="align-items: flex-end; margin-bottom: 0;">
                            <div class="form-group">
                                <label for="dataRefEsq" style="font-weight: bold;">üìÖ Data de Refer√™ncia</label>
                                <input id="dataRefEsq" type="date" />
                            </div>
                            <div class="form-group">
                                <div class="stat-card" style="padding: 1rem; background: var(--secondary-color);">
                                    <div style="font-size: 0.9rem; opacity: 0.8;">Total Chapas (dia)</div>
                                    <div class="stat-value" id="totalChapasEsqDia"
                                        style="font-size: 1.5rem; margin-bottom: 0;">0</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="stat-card" style="padding: 1rem; background: var(--success-color);">
                                    <div style="font-size: 0.9rem; opacity: 0.8;">Total Volume (dia)</div>
                                    <div class="stat-value" id="totalVolumeEsqDia"
                                        style="font-size: 1.5rem; margin-bottom: 0;">0.000 m¬≥</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CARD REGISTRO -->
                    <div class="card">
                        <h3>Registro de Produ√ß√£o (Esquadrejadeira)</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="codigoEsqInput">C√≥digo do Produto *</label>
                                <div class="codigo-input-group">
                                    <input id="codigoEsqInput" placeholder="Digite o c√≥digo e tecle Enter"
                                        type="text" />
                                    <button class="btn btn-info btn-sm" onclick="toggleSelect('produtoCodigoEsq')"
                                        type="button">Ver Lista</button>
                                </div>
                                <select id="produtoCodigoEsq" style="margin-top: 0.5rem; display: none;"></select>
                                <div id="descricaoProdutoEsqPreview"
                                    style="margin-top: 0.5rem; font-weight: 600; color: #1e40af;"></div>
                            </div>
                            <div class="form-group">
                                <label for="quantidadeEsq">Quantidade (chapas) *</label>
                                <input id="quantidadeEsq" min="1" required step="1" type="number" />
                            </div>
                            <div class="form-group">
                                <label for="turnoEsq">Turno *</label>
                                <select id="turnoEsq" required></select>
                            </div>
                            <div class="form-group">
                                <label for="dataEsq">Data da Produ√ß√£o *</label>
                                <input id="dataEsq" required type="date" />
                            </div>
                        </div>
                        <button class="btn btn-success" id="btnRegistrarEsq">Registrar (Ctrl+Enter)</button>
                    </div>

                    <!-- CARD LAN√áAMENTOS -->
                    <div class="card">
                        <h3>Lan√ßamentos do Dia (Esquadrejadeira)</h3>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>C√≥digo</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Qtd.</th>
                                        <th>Turno</th>
                                        <th>Cubagem (m¬≥)</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="esqDiaTbody">
                                    <!-- Linhas inseridas via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="tab-content" id="prensa">
                    <div class="card" style="background-color: #f1f5f9; border-top-color: var(--info-color);">
                        <div class="form-row" style="align-items: flex-end; margin-bottom: 0;">
                            <div class="form-group">
                                <label for="dataRefPrensa" style="font-weight: bold;">üìÖ Data de Refer√™ncia</label>
                                <input id="dataRefPrensa" type="date" />
                            </div>
                            <div class="form-group">
                                <div class="stat-card" style="padding: 1rem; background: var(--secondary-color);">
                                    <div style="font-size: 0.9rem; opacity: 0.8;">Total Chapas (dia)</div>
                                    <div class="stat-value" id="totalChapasPrensaDia"
                                        style="font-size: 1.5rem; margin-bottom: 0;">0</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="stat-card" style="padding: 1rem; background: var(--success-color);">
                                    <div style="font-size: 0.9rem; opacity: 0.8;">Total Prensadas (dia)</div>
                                    <div class="stat-value" id="totalPrensadasDia"
                                        style="font-size: 1.5rem; margin-bottom: 0;">0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Registro de Produ√ß√£o (Prensa)</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="codigoPrensaInput">C√≥digo do Produto *</label>
                                <div class="codigo-input-group">
                                    <input id="codigoPrensaInput" placeholder="Digite o c√≥digo e tecle Enter"
                                        type="text" />
                                    <button class="btn btn-info btn-sm" onclick="toggleSelect('produtoCodigoPrensa')"
                                        type="button">Ver Lista</button>
                                </div>
                                <select id="produtoCodigoPrensa" style="margin-top: 0.5rem; display: none;"></select>
                                <div id="descricaoProdutoPrensaPreview"
                                    style="margin-top: 0.5rem; font-weight: 600; color: #1e40af;"></div>
                            </div>

                            <div class="form-group">
                                <label for="quantidadePrensa">Quantidade (chapas) *</label>
                                <input id="quantidadePrensa" min="1" required step="1" type="number" />
                            </div>

                            <div class="form-group">
                                <label for="turnoPrensa">Turno *</label>
                                <select id="turnoPrensa" required></select>
                            </div>

                            <div class="form-group">
                                <label for="dataPrensa">Data da Produ√ß√£o *</label>
                                <input id="dataPrensa" required type="date" />
                            </div>

                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="obsPrensa">Observa√ß√µes</label>
                                <textarea id="obsPrensa" rows="1" placeholder="Opcional"></textarea>
                            </div>

                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="cargaPrensaSelect">Carga (chapas/prensada) *</label>
                                <select id="cargaPrensaSelect" required>
                                    <option value="">Selecione ou digite um produto para sugerir</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="prensadasPreview">Prensadas (estimado)</label>
                                <input id="prensadasPreview" type="text" disabled placeholder="‚Äî"
                                    style="background-color: #e9ecef; font-weight: bold; text-align: center;" />
                            </div>
                        </div>

                        <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
                            <button class="btn btn-success" id="btnRegistrarPrensa" disabled>Registrar
                                (Ctrl+Enter)</button>
                            <button class="btn btn-secondary" id="btnLimparPrensa">Limpar</button>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Lan√ßamentos do Dia (Prensa)</h3>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>C√≥digo</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Qtd. (chapas)</th>
                                        <th>Carga</th>
                                        <th>Prensadas</th>
                                        <th>Turno</th>
                                        <th>Obs</th>
                                        <th>Lan√ßamento</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="prensaDiaTbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- Descarte -->
                <div class="tab-content" id="descarte">
                    <div class="card">
                        <h3>Registrar Descarte</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="codigoDescarteInput">Produto para Descarte *</label>
                                <div class="codigo-input-group">
                                    <input id="codigoDescarteInput" placeholder="Digite o c√≥digo ou descri√ß√£o"
                                        type="text" autocomplete="off" />
                                    <datalist id="produtosDescarteDataList"></datalist>
                                </div>
                                <div id="produtoSelecionadoDescarte" class="produto-selecionado-display">Nenhum produto
                                    selecionado.</div>
                            </div>
                            <div class="form-group">
                                <label for="tipoDescarte">Tipo de Descarte *</label>
                                <input id="tipoDescarte" list="tiposDescarteDataList" required
                                    placeholder="Selecione ou digite um tipo" />
                                <datalist id="tiposDescarteDataList">
                                    <!-- Preenchido via JS -->
                                </datalist>
                            </div>
                            <div class="form-group">
                                <label for="quantidadeDescarte">Quantidade (chapas) *</label>
                                <input id="quantidadeDescarte" min="1" required step="1" type="number" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="turnoDescarte">Turno *</label>
                                <select id="turnoDescarte" required></select>
                            </div>
                            <div class="form-group">
                                <label for="dataDescarte">Data do Descarte *</label>
                                <input id="dataDescarte" required type="date" />
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label for="descarteObs">Observa√ß√µes</label>
                                <textarea id="descarteObs" rows="1"></textarea>
                            </div>
                        </div>
                        <button class="btn btn-danger" id="btnRegistrarDescarte" onclick="registrarDescarte()">Registrar
                            Descarte (Ctrl+Enter)</button>
                    </div>

                    <div
                        style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <h3>Descartes do Dia</h3>
                        <div style="display: flex; align-items: flex-end; gap: 0.5rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="dataTabelaDescartes" style="margin-bottom: 0.25rem;">Data da Tabela</label>
                                <input id="dataTabelaDescartes" type="date" />
                            </div>
                            <button id="btnCopiarResumoDescarte" class="btn btn-secondary btn-sm">Copiar Resumo</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table" id="tabelaDescartesDia">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>C√≥digo</th>
                                    <th>Produto</th>
                                    <th>Tipo de Descarte</th>
                                    <th>Qtd.</th>
                                    <th>Turno</th>
                                    <th>Obs</th>
                                    <th>Lan√ßamento</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="descartesDiaTbody"></tbody>
                        </table>
                    </div>
                    <div id="paginationDescartes" class="pagination-controls"></div>
                </div>
        </div>

        <!-- Consulta -->
        <div class="tab-content" id="consulta">
            <div class="card">
                <h3>Consulta e Filtros</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="tipoConsulta">Tipo de Consulta</label>
                        <select id="tipoConsulta">
                            <option value="producao">Produ√ß√£o</option>
                            <option value="descarte">Descarte</option>
                            <option value="secador">Secador</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filtroDataInicio">Data In√≠cio</label>
                        <input id="filtroDataInicio" type="date" />
                    </div>
                    <div class="form-group">
                        <label for="filtroDataFim">Data Fim</label>
                        <input id="filtroDataFim" type="date" />
                    </div>
                    <div class="form-group">
                        <label for="filtroTurno">Turno(s) (Ctrl+Click para v√°rios)</label>
                        <select id="filtroTurno" multiple style="height: 120px;">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                </div>

                <!-- Filtros condicionais para Produ√ß√£o -->
                <div id="filtrosProducao" class="form-row">
                    <div class="form-group">
                        <label for="filtroProduto">Produto</label>
                        <select id="filtroProduto">
                            <option value="">Todos os produtos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filtroMesa">Mesa</label>
                        <select id="filtroMesa">
                            <option value="">Todas as mesas</option>
                            <option value="MESA 1">Mesa 1</option>
                            <option value="MESA 2">Mesa 2</option>
                            <option value="MESA 3">Mesa 3</option>
                            <option value="MESA 4">Mesa 4</option>
                            <option value="ESTEIRA">Esteira</option>
                            <option value="MESA ELEVADA">Mesa Elevada</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filtroFamilia">Fam√≠lia</label>
                        <select id="filtroFamilia">
                            <option value="">Todas as fam√≠lias</option>
                        </select>
                    </div>
                </div>

                <!-- Filtros condicionais para Descarte -->
                <div id="filtrosDescarte" class="form-row" style="display: none;">
                    <div class="form-group">
                        <label for="filtroTipoDescarte">Tipo de Descarte</label>
                        <select id="filtroTipoDescarte">
                            <option value="">Todos os tipos</option>
                            <option value="FALHA PRENSA">Falha Prensa</option>
                            <option value="FALHA MIOLO">Falha Miolo</option>
                        </select>
                    </div>
                </div>

                <!-- Incluir Secador na consulta -->
                <div class="form-group">
                    <input type="checkbox" id="incluirSecador" style="width: auto; margin-right: 0.5rem;">
                    <label for="incluirSecador" style="display: inline;">Incluir dados do Secador (quando consultar
                        Produ√ß√£o)</label>
                </div>

                <button class="btn btn-primary" onclick="aplicarFiltros()">Aplicar Filtros</button>
                <button class="btn btn-secondary" onclick="limparFiltros()">Limpar Filtros</button>
            </div>

            <div class="card">
                <h3>Resultados da Consulta</h3>
                <div id="resultadosConsulta">
                    <p style="text-align: center; color: #666;">Aplique os filtros para ver os resultados.</p>
                </div>
            </div>
        </div>

        <!-- Relat√≥rios -->
        <div class="tab-content" id="relatorios">
            <div class="card">
                <h3>Exportar Relat√≥rios</h3>
                <p>Exporte os dados de produ√ß√£o e descarte para um arquivo Excel.</p>
                <div style="margin-top: 1.5rem;">
                    <button class="btn btn-success" onclick="exportarRelatorio('producao')">Exportar Produ√ß√£o</button>
                    <button class="btn btn-danger" onclick="exportarRelatorio('descarte')">Exportar Descarte</button>
                    <button class="btn btn-info" onclick="exportarRelatorio('completo')">Relat√≥rio Completo</button>
                </div>
            </div>
        </div>

        <!-- Secador -->
        <div class="tab-content" id="secador">
            <div class="card">
                <h3>Registro de Produ√ß√£o - Secador</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="sec_codigo">C√≥digo do Produto *</label>
                        <div class="codigo-input-group">
                            <input id="sec_codigo" placeholder="Digite o c√≥digo" type="text" autocomplete="off" />
                        </div>
                        <div id="sec_preview" class="produto-selecionado-display">Nenhum produto selecionado.</div>
                    </div>
                    <div class="form-group">
                        <label for="sec_cubagem">Cubagem (m¬≥) *</label>
                        <input id="sec_cubagem" min="0.001" required step="0.001" type="number" />
                    </div>
                    <div class="form-group">
                        <label for="sec_especie">Esp√©cie *</label>
                        <select id="sec_especie" required>
                            <option value="Pinus">Pinus</option>
                            <option value="Eucalipto">Eucalipto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sec_turno">Turno *</label>
                        <select id="sec_turno" required></select>
                    </div>
                    <div class="form-group">
                        <label for="sec_data">Data *</label>
                        <input id="sec_data" required type="date" />
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="sec_obs">Observa√ß√µes</label>
                        <textarea id="sec_obs" rows="2" placeholder="Opcional"></textarea>
                    </div>
                </div>
                <button class="btn btn-success" id="sec_confirm">Registrar Produ√ß√£o (Ctrl+Enter)</button>
                <button class="btn btn-secondary" id="sec_limpar">Limpar Campos</button>
            </div>

            <div class="card" style="margin-top: 1rem;">
                <h3>Lan√ßamentos do Dia (Secador)</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>C√≥digo</th>
                                <th>Descri√ß√£o</th>
                                <th>Dimens√µes</th>
                                <th>Qualidade</th>
                                <th>Esp√©cie</th>
                                <th>Cubagem (m¬≥)</th>
                                <th>Turno</th>
                                <th>Obs</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="sec_grid_body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        </main>
    </div>
    </div>

    <!-- Modal para Produto -->
    <div class="modal" id="modalProduto">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('modalProduto')">√ó</span>
            <h3 id="tituloModalProduto">Novo Produto</h3>
            <div class="form-group">
                <label for="modalCodigo">C√≥digo *</label>
                <input id="modalCodigo" required type="text" />
            </div>
            <div class="form-group">
                <label for="modalDescricao">Descri√ß√£o *</label>
                <input id="modalDescricao" required type="text" />
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="modalComprimento">Comprimento (m)</label>
                    <input id="modalComprimento" step="0.01" type="number" />
                </div>
                <div class="form-group">
                    <label for="modalLargura">Largura (m)</label>
                    <input id="modalLargura" step="0.01" type="number" />
                </div>
                <div class="form-group">
                    <label for="modalBitola">Bitola (m)</label>
                    <input id="modalBitola" step="0.001" type="number" />
                </div>
            </div>
            <div class="form-group">
                <label for="modalFamiliaID">Fam√≠lia</label>
                <select id="modalFamiliaID"></select>
            </div>
            <div style="text-align: right; margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="fecharModal('modalProduto')">Cancelar</button>
                <button class="btn btn-success" onclick="salvarProduto()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Turno -->
    <div class="modal" id="modalTurno">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('modalTurno')">√ó</span>
            <h3 id="tituloModalTurno">Novo Turno</h3>
            <div class="form-group">
                <label for="modalNomeTurno">Nome do Turno *</label>
                <input id="modalNomeTurno" required type="text" />
            </div>
            <div style="text-align: right; margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="fecharModal('modalTurno')">Cancelar</button>
                <button class="btn btn-success" onclick="salvarTurno()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Produ√ß√£o -->
    <div class="modal" id="modalEditarProducao">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('modalEditarProducao')">√ó</span>
            <h3 id="tituloModalEditarProducao">Editar Lan√ßamento de Produ√ß√£o</h3>
            <div class="form-group">
                <label>Produto</label>
                <p id="modalEditarProducaoDescricao"
                    style="font-weight: bold; color: var(--dark-color); padding: 0.5rem; background: #f1f5f9; border-radius: 8px;">
                </p>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="modalEditarQuantidade">Quantidade (chapas) *</label>
                    <input id="modalEditarQuantidade" min="1" required step="1" type="number" />
                </div>
                <div class="form-group">
                    <label for="modalEditarTurno">Turno *</label>
                    <select id="modalEditarTurno" required></select>
                </div>
                <div class="form-group">
                    <label for="modalEditarData">Data da Produ√ß√£o *</label>
                    <input id="modalEditarData" required type="date" />
                </div>
            </div>
            <div style="text-align: right; margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="fecharModal('modalEditarProducao')">Cancelar</button>
                <button class="btn btn-success" onclick="salvarProducaoEditada()">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>
    <!-- Torno -->
    <!-- Torno -->
    <div class="tab-content" id="torno">
        <div class="card">
            <h3>Registro de Produ√ß√£o - Torno</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="torno_data">Data *</label>
                    <input id="torno_data" required type="date" />
                </div>
                <div class="form-group">
                    <label for="torno_torno">Torno *</label>
                    <select id="torno_torno" required>
                        <option value="PETKOMAQ">PETKOMAQ</option>
                        <option value="ZICO">ZICO</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="torno_especie">Esp√©cie *</label>
                    <select id="torno_especie" required>
                        <option value="Pinus">Pinus</option>
                        <option value="Eucalipto">Eucalipto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="torno_diametro">Di√¢metro da Tora *</label>
                    <select id="torno_diametro" required>
                        <option value="18A25">18A25</option>
                        <option value="25ACIMA">25ACIMA</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="torno_comp">Comprimento da L√¢mina (m) *</label>
                    <input id="torno_comp" min="0.001" required step="0.001" type="number" />
                </div>
                <div class="form-group">
                    <label for="torno_larg">Largura da L√¢mina (m) *</label>
                    <input id="torno_larg" min="0.001" required step="0.001" type="number" />
                </div>
                <div class="form-group">
                    <label for="torno_esp">Espessura da L√¢mina (mm) *</label>
                    <input id="torno_esp" min="0.001" required step="0.001" type="number" />
                </div>
                <div class="form-group">
                    <label for="torno_m3">m¬≥ da L√¢mina *</label>
                    <input id="torno_m3" min="0.001" required step="0.001" type="number" />
                </div>
                <div class="form-group" style="display: flex; align-items: center;">
                    <input type="checkbox" id="torno_parada" style="width: auto; margin-right: 0.5rem;">
                    <label for="torno_parada" style="display: inline;">Teve tempo de parada?</label>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label for="torno_obs">Observa√ß√µes</label>
                    <textarea id="torno_obs" rows="2" placeholder="Opcional"></textarea>
                </div>
            </div>
            <button class="btn btn-success" id="torno_confirm">Registrar Produ√ß√£o (Ctrl+Enter)</button>
            <button class="btn btn-secondary" id="torno_limpar">Limpar Campos</button>
        </div>

        <div class="card" style="margin-top: 1rem;">
            <h3>Lan√ßamentos do Dia (Torno)</h3>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Data</th>
                            <th>Torno</th>
                            <th>Esp√©cie</th>
                            <th>Comp. LAMINA (m)</th>
                            <th>LARGURA LAMINA</th>
                            <th>Esp. l√¢mina (mm)</th>
                            <th>Qtd. l√¢minas m¬≥</th>
                            <th>Di√¢metro Tora</th>
                            <th>Teve Parada</th>
                            <th>Obs</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="torno_grid_body"></tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- IN√çCIO: Nova Aba Sistema Estoque -->
    <div class="tab-content" id="estoque">
        <div class="card">
            <h3>Sistema de Controle de Estoque - Avan√ßado</h3>
            <p>Selecione uma das op√ß√µes abaixo para gerenciar o estoque.</p>
        </div>
        <!-- O conte√∫do detalhado do estoque ser√° gerenciado pelo JavaScript. -->
        <!-- Esta div servir√° como container principal. -->
        <div id="estoque-container">
            <!-- O React ser√° renderizado aqui -->
        </div>
    </div>
    <!-- FIM: Nova Aba Sistema Estoque -->


    <!-- Modal de Confirma√ß√£o -->
    <div class="modal" id="confirmModal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <h4 id="confirmModalTitle" style="margin-bottom: 1.5rem;">Voc√™ tem certeza?</h4>
            <p id="confirmModalText" style="margin-bottom: 2rem;"></p>
            <div>
                <button class="btn btn-secondary" onclick="fecharModal('confirmModal')">Cancelar</button>
                <button class="btn btn-danger" id="confirmOk">Confirmar</button>
            </div>
        </div>
    </div>
    <div class="modal" id="modalResumoDescarte">
        <div class="modal-content" style="max-width: 450px;">
            <span class="close" onclick="fecharModal('modalResumoDescarte')">√ó</span>
            <h3 id="tituloModalResumoDescarte">Incluir sugest√µes no resumo?</h3>
            <p style="margin-bottom: 1.5rem; font-size: 0.9rem; color: #555;">Marque as an√°lises adicionais que deseja
                incluir na mensagem a ser copiada.</p>

            <div class="form-group">
                <label style="display: flex; align-items: center; font-weight: normal;">
                    <input type="checkbox" id="sugestaoTop3" style="width: auto; margin-right: 0.75rem;">
                    Top 3 tipos de descarte do dia
                </label>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; font-weight: normal;">
                    <input type="checkbox" id="sugestaoFamiliaMaior" style="width: auto; margin-right: 0.75rem;">
                    Destacar fam√≠lia com maior % de descarte (alerta se > 5%)
                </label>
            </div>
            <div class="form-group">
                <label
                    style="display: flex; align-items: center; font-weight: normal; opacity: 0.5; cursor: not-allowed;">
                    <input type="checkbox" id="sugestaoTendencia" style="width: auto; margin-right: 0.75rem;" disabled>
                    <i>Tend√™ncia vs. m√©dia da semana (em desenvolvimento)</i>
                </label>
            </div>
            <div class="form-group">
                <label
                    style="display: flex; align-items: center; font-weight: normal; opacity: 0.5; cursor: not-allowed;">
                    <input type="checkbox" id="sugestaoMeta" style="width: auto; margin-right: 0.75rem;" disabled>
                    <i>Meta vs. realizado (em desenvolvimento)</i>
                </label>
            </div>

            <div style="text-align: right; margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="fecharModal('modalResumoDescarte')">Cancelar</button>
                <button class="btn btn-success" id="btnConfirmarCopiaResumo">Copiar Resumo</button>
            </div>
        </div>
    </div>

    <script>
        // Sistema Principal
        window.App = window.App || {};
        const App = window.App;
        Object.assign(App, {
            state: {
                API_BASE_URL: 'http://localhost:3001',
                isConnected: false,
                dataReferencia: null,
                dataRefEsq: null,
                setorEsquadrejadeiraId: null,
                esqGerencial: {
                    currentDate: null,
                    selectedDay: null,
                    turno1Id: null,
                    turno2Id: null,
                },
                dataTabelaDescartes: null,
                descarteCurrentPage: 1,
                descarteRowsPerPage: 50,
                charts: {
                    producaoTurno: null,
                    evolucaoProducao: null
                },
                cache: {
                    produtos: [],
                    turnos: [],
                    setores: [],
                    familias: [],
                    tiposDescarte: [],
                    producao: [],
                    descarte: [],
                    descartesDoDia: [],
                },
                editingProduct: null,
                editingTurno: null,
                editingProducao: null,
                produtos: {
                    master: [],
                    view: [],
                    filterText: "",
                    sort: {
                        key: 'Codigo',
                        dir: 'asc'
                    }
                },
                initializedTabs: {}, // ‚Üê ADICIONADO: Controla quais abas j√° foram inicializadas
                _listeners: { prensa: false } // ‚Üê ADICIONADO: Controla listeners j√° configurados
            },
            utils: {
                formatLaunchDate(createdAtIso, fallbackDate) {
                    if (createdAtIso) {
                        try {
                            const date = new Date(createdAtIso);
                            if (!isNaN(date.getTime())) {
                                return new Intl.DateTimeFormat('pt-BR', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    timeZone: 'America/Sao_Paulo'
                                }).format(date).replace(',', '');
                            }
                        } catch (e) {
                            console.warn("Erro ao formatar createdAt, usando fallback:", createdAtIso, e);
                        }
                    }
                    if (fallbackDate) {
                        try {
                            const date = new Date(fallbackDate + 'T12:00:00');
                            if (!isNaN(date.getTime())) {
                                return new Intl.DateTimeFormat('pt-BR', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit'
                                }).format(date);
                            }
                        } catch (e) {
                            console.error("Erro ao formatar data de fallback:", fallbackDate, e);
                            return '‚Äî';
                        }
                    }
                    return '‚Äî';
                },
                async apiCall(endpoint, options = {}) {
                    App.ui.showLoading(true);
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000);

                    try {
                        const response = await fetch(`${App.state.API_BASE_URL}${endpoint}`, {
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            signal: controller.signal,
                            ...options
                        });
                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            throw new Error(`Erro ${response.status}: ${response.statusText}`);
                        }

                        const contentType = response.headers.get("content-type");
                        if (contentType && contentType.indexOf("application/json") !== -1) {
                            return await response.json();
                        } else {
                            const textResponse = await response.text();
                            console.warn("Resposta n√£o-JSON do servidor:", textResponse);
                            return { message: textResponse };
                        }
                    } catch (error) {
                        console.error(`API call to ${endpoint} failed:`, error);
                        const userMessage = error.name === 'AbortError'
                            ? "Timeout: Servidor n√£o respondeu em 10 segundos"
                            : error.message;
                        App.ui.showNotification(`Erro: ${userMessage}`, 'error');
                        throw error;
                    } finally {
                        clearTimeout(timeoutId);
                        App.ui.showLoading(false);
                    }
                },
                $(selector, silent = false) {
                    const el = document.querySelector(selector);
                    if (!el && !silent) console.warn(`Elemento n√£o encontrado: ${selector}`);
                    return el;
                },


                getValue(selector) {
                    const el = this.$(selector);
                    return el ? el.value : '';
                },
                setText(selector, text) {
                    const el = this.$(selector);
                    if (el) el.textContent = text;
                },
                getTodayDateString() {
                    return new Date().toISOString().split('T')[0];
                },
                getYesterdayDateString() {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    return yesterday.toISOString().split('T')[0];
                },

                getLocalDateISO() {

                    const now = new Date();
                    const tz = now.getTimezoneOffset() * 60000;
                    const local = new Date(now.getTime() - tz);
                    return local.toISOString().split('T')[0];
                },

                debounce(func, delay) {
                    let timeout;
                    return function (...args) {
                        const context = this;
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(context, args), delay);
                    };
                },
                normalizeText(text = '') {
                    return String(text)
                        .normalize('NFD')
                        .replace(/[\u0300-\u036f]/g, '')
                        .toUpperCase();
                }
            },
            ui: {
                showLoading(show) {
                    const overlay = App.utils.$('#loadingOverlay');
                    if (overlay) overlay.style.display = show ? 'flex' : 'none';
                },
                showNotification(message, type = 'success') {
                    const notification = App.utils.$('#notification');
                    if (notification) {
                        notification.textContent = message;
                        notification.className = `notification show ${type}`;
                        setTimeout(() => notification.classList.remove('show'), 4000);
                    }
                },
                updateConnectionStatus(status) {
                    const statusEl = App.utils.$('#connectionStatus');
                    if (!statusEl) return;
                    statusEl.className = 'connection-status';
                    switch (status) {
                        case 'connected':
                            App.state.isConnected = true;
                            statusEl.textContent = 'Conectado';
                            statusEl.classList.add('connected');
                            break;
                        case 'disconnected':
                            App.state.isConnected = false;
                            statusEl.textContent = 'Desconectado';
                            statusEl.classList.add('disconnected');
                            break;
                        case 'connecting':
                            App.state.isConnected = false;
                            statusEl.textContent = 'Conectando...';
                            statusEl.classList.add('connecting');
                            break;
                    }
                },
                toggleModal(modalId, show) {
                    const modal = App.utils.$(`#${modalId}`);
                    if (modal) modal.classList.toggle('show', show);
                },
                populateSelect(selectId, data, valueField, textField) {
                    const select = App.utils.$(`#${selectId}`);
                    if (!select) return;
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Selecione...</option>';
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item[valueField];
                        option.textContent = item[textField];
                        select.appendChild(option);
                    });
                    if (currentValue) select.value = currentValue;
                }
            },
            logic: {
                async loadAllData() {
                    try {
                        await Promise.all([
                            this.loadProdutos(),
                            this.loadTurnos(),
                            this.loadFamilias(),
                            this.loadSetores(),
                            this.loadProducao(),
                            this.loadDescarte(),
                            this.loadTiposDescarte()
                        ]);
                        this.loadDashboard();
                        this.populateFiltrosConsulta();
                        this.populateProdutosDataList();
                    } catch (error) {
                        console.error('Erro ao carregar dados:', error);
                    }
                },
                async loadProdutos() {
                    const produtosData = await App.utils.apiCall('/produtos');
                    App.state.produtos.master = produtosData;
                    App.state.cache.produtos = produtosData;
                    this.renderProdutos();
                },
                normalizeProducaoData(producaoArray) {
                    return (producaoArray || []).map(p => ({
                        ProducaoID: p.ProducaoID || p.producao_id,
                        ProdutoID: p.ProdutoID || p.produto_id,
                        TurnoID: p.TurnoID || p.turno_id,
                        SetorID: p.SetorID || p.setor_id,
                        Quantidade_Chapas: p.Quantidade_Chapas || p.quantidade_chapas,
                        Observacoes: p.Observacoes || p.observacoes || p.Obs || p.obs,
                        Data: p.Data || p.data,
                        createdAt: p.createdAt || p.created_at,
                        updatedAt: p.updatedAt || p.updated_at
                    }));
                },
                async loadProducao() {
                    const producaoData = await App.utils.apiCall('/producao');
                    App.state.cache.producao = this.normalizeProducaoData(producaoData);
                },
                async loadTurnos() {
                    App.state.cache.turnos = await App.utils.apiCall('/turnos');
                    this.renderTurnos();
                },
                async loadFamilias() {
                    App.state.cache.familias = await App.utils.apiCall('/familias');
                    App.ui.populateSelect('modalFamiliaID', App.state.cache.familias, 'FamiliaID', 'FamiliaNome');
                },
                async loadTiposDescarte() {
                    try {
                        App.state.cache.tiposDescarte = await App.utils.apiCall('/tipos-descarte');
                        this.populateTiposDescarteDataList();
                    } catch (error) {
                        console.error("Erro ao carregar tipos de descarte:", error);
                        App.ui.showNotification("N√£o foi poss√≠vel carregar os tipos de descarte.", "warning");
                        App.state.cache.tiposDescarte = [];
                        this.populateTiposDescarteDataList();
                    }
                },
                populateTiposDescarteDataList() {
                    const dataList = App.utils.$('#tiposDescarteDataList');
                    if (!dataList) return;
                    dataList.innerHTML = '';
                    const tipos = new Set(App.state.cache.tiposDescarte.map(tipo => tipo.Nome));
                    const defaultTipos = ["FALHA PRENSA", "FALHA MIOLO", "ESTOURADA", "PR√â CURA", "CAPA VAZADA", "LAMINA DESBITOLADA", "SERRA", "DESCOLADA", "CAPA DOBRADA", "FALHA CORTE", "ERRO CAMADA", "EMPENO", "QUEBRADA", "FALHA CAPA", "EMPILHADEIRA", "CAPA CURTA", "FALHA LIXADEIRA", "DEFEITO DE CAPA", "FALHA FILME", "RECORTE", "MOTIVO N√ÉO ESPECIFICADO", "FALHA CABECEIRA", "TORTA"];
                    defaultTipos.forEach(defaultTipo => tipos.add(defaultTipo));
                    tipos.forEach(nome => {
                        const option = document.createElement('option');
                        option.value = nome;
                        dataList.appendChild(option);
                    });
                },
                async loadSetores() {
                    App.state.cache.setores = await App.utils.apiCall('/setores');
                    const setorEsq = App.state.cache.setores.find(s => s.SetorNome.toUpperCase() === 'ESQUADREJADEIRA');
                    App.state.setorEsquadrejadeiraId = setorEsq ? setorEsq.SetorID : 3; // Fallback para 3
                },
                async loadDescarte() {
                    App.state.cache.descarte = await App.utils.apiCall('/descarte');
                },
                async loadDashboard() {
                    // Garante que os dados mais recentes de produ√ß√£o e descarte est√£o no cache.
                    // Se a conex√£o estiver ativa, busca os dados mais recentes do servidor.
                    if (App.state.isConnected) {
                        try {
                            await Promise.all([
                                this.loadProducao(),
                                this.loadDescarte()
                            ]);
                        } catch (error) {
                            console.error("Falha ao recarregar dados para o dashboard:", error);
                            // Continua com os dados em cache, se houver.
                        }
                    }

                    const { producao = [], descarte = [], produtos = [] } = App.state.cache;

                    // 1. Calcula o total de produtos cadastrados.
                    const totalProdutos = produtos.length;
                    App.utils.setText('#totalProdutos', totalProdutos.toString());

                    // 2. Calcula o total de m¬≥ produzidos.
                    const totalProducaoM3 = producao.reduce((sum, p) => {
                        const produto = produtos.find(prod => prod.ProdutoID === p.ProdutoID);
                        const volume = produto ? (produto.Cubagem_m3 || 0) * (p.Quantidade_Chapas || 0) : 0;
                        return sum + volume;
                    }, 0);
                    App.utils.setText('#totalProducao', totalProducaoM3.toFixed(3));

                    // 3. Calcula o total de chapas descartadas.
                    const totalDescarteChapas = descarte.reduce((sum, d) => sum + (d.Quantidade_Chapas || 0), 0);
                    App.utils.setText('#totalDescarte', totalDescarteChapas.toString());

                    // 4. Calcula a efici√™ncia (Produ√ß√£o / (Produ√ß√£o + Descarte em m¬≥)).
                    const totalDescarteM3 = descarte.reduce((sum, d) => {
                        const produto = produtos.find(prod => prod.ProdutoID === d.ProdutoID);
                        const volume = produto ? (produto.Cubagem_m3 || 0) * (d.Quantidade_Chapas || 0) : 0;
                        return sum + volume;
                    }, 0);

                    const totalGeralM3 = totalProducaoM3 + totalDescarteM3;
                    const eficiencia = totalGeralM3 > 0 ? (totalProducaoM3 / totalGeralM3) * 100 : 0;
                    App.utils.setText('#eficiencia', `${eficiencia.toFixed(1)}%`);

                    // 5. Atualiza os gr√°ficos com os dados de produ√ß√£o.
                    // A fun√ß√£o updateCharts j√° existe, s√≥ precisamos cham√°-la.
                    this.sync.updateCharts(producao);
                },

                renderProdutos() {
                    const tbody = App.utils.$('#produtosTbody');
                    if (!tbody) return;

                    // 1. Pega os dados mestre e aplica o filtro de busca
                    const { master, filterText, sort } = App.state.produtos;
                    let view = master;

                    if (filterText) {
                        view = master.filter(p => {
                            const normalizedTerm = App.utils.normalizeText(filterText);
                            return App.utils.normalizeText(p.Descricao).includes(normalizedTerm) ||
                                App.utils.normalizeText(p.Codigo).includes(normalizedTerm);
                        });
                    }

                    // 2. Aplica a ordena√ß√£o (sort)
                    view.sort((a, b) => {
                        let valA = a[sort.key];
                        let valB = b[sort.key];

                        // Tratamento para diferentes tipos de dados
                        if (typeof valA === 'string') {
                            valA = App.utils.normalizeText(valA);
                            valB = App.utils.normalizeText(valB);
                        }

                        if (valA < valB) return sort.dir === 'asc' ? -1 : 1;
                        if (valA > valB) return sort.dir === 'asc' ? 1 : -1;
                        return 0;
                    });

                    // 3. Renderiza o HTML da tabela
                    if (view.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;">Nenhum produto encontrado.</td></tr>`;
                    } else {
                        tbody.innerHTML = view.map(p => {
                            const familiaNome = App.logic.getFamiliaNome(p.FamiliaID);
                            return `
                                <tr id="produto-row-${p.ProdutoID}">
                                    <td>${p.Codigo}</td>
                                    <td>${p.Descricao}</td>
                                    <td>${(p.Comprimento_m || 0).toFixed(3)} m</td>
                                    <td>${(p.Largura_m || 0).toFixed(3)} m</td>
                                    <td>${(p.Bitola_m || 0).toFixed(3)} m</td>
                                    <td>${familiaNome}</td>
                                    <td><strong>${(p.Cubagem_m3 || 0).toFixed(6)} m¬≥</strong></td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" onclick="editarProduto(${p.ProdutoID})">Editar</button>
                                        <button class="btn btn-sm btn-danger" onclick="excluirProduto(${p.ProdutoID})">Excluir</button>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    }
                },
                populateProdutosDataList() {
                    // Encontra o <datalist> na aba de Descarte
                    const dataList = App.utils.$('#produtosDescarteDataList');
                    if (!dataList) return; // Se n√£o encontrar o elemento, encerra a fun√ß√£o

                    // Limpa quaisquer op√ß√µes antigas que possam existir
                    dataList.innerHTML = '';

                    // Pega a lista de produtos do cache do sistema
                    const produtos = App.state.cache.produtos || [];

                    // Cria um <option> para cada produto e o adiciona ao <datalist>
                    produtos.forEach(produto => {
                        // Adiciona uma op√ß√£o baseada no C√≥digo do produto
                        const optionCodigo = document.createElement('option');
                        optionCodigo.value = produto.Codigo;
                        optionCodigo.textContent = `${produto.Descricao}`; // Texto que pode aparecer em alguns navegadores
                        dataList.appendChild(optionCodigo);

                        // Adiciona uma op√ß√£o tamb√©m pela Descri√ß√£o, para que o usu√°rio possa buscar pelo nome
                        const optionDescricao = document.createElement('option');
                        optionDescricao.value = produto.Descricao;
                        optionDescricao.textContent = `C√≥digo: ${produto.Codigo}`;
                        dataList.appendChild(optionDescricao);
                    });
                },

                async loadConsultaData() {
                    this.initConsulta();
                    this.populateFiltrosConsulta();
                },
                renderTurnos() {
                    // ... (c√≥digo original da fun√ß√£o)
                },
                getFamiliaNome(familiaID) {
                    const familia = App.state.cache.familias.find(f => f.FamiliaID === familiaID);
                    return familia ? familia.FamiliaNome : 'N/A';
                },
                initProducaoTab() {
                    App.utils.$('#dataProducao').value = App.state.dataReferencia;
                    App.ui.populateSelect('turnoDetalhado', App.state.cache.turnos, 'TurnoID', 'TurnoNome');
                    this.renderProducaoDoDia();
                },
                setDataReferencia() {
                    const novaData = App.utils.getValue('#dataReferencia');
                    App.state.dataReferencia = novaData;
                    localStorage.setItem('producao.dataReferencia', novaData);
                    App.utils.$('#dataProducao').value = novaData;
                    this.renderProducaoDoDia();
                },
                renderProducaoDoDia() {
                    const tbody = App.utils.$('#producaoDiaTbody');
                    if (!tbody) return;
                    const dataFiltro = App.state.dataReferencia;
                    const setorId = App.state.setorEsquadrejadeiraId;
                    const producaoDoDia = App.state.cache.producao
                        .filter(p => p.Data === dataFiltro && (p.SetorID !== setorId))
                        .sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0) || b.ProducaoID - a.ProducaoID);
                    if (producaoDoDia.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;">Nenhum lan√ßamento para ${new Date(dataFiltro + 'T00:00:00').toLocaleDateString('pt-BR')}.</td></tr>`;
                    } else {
                        tbody.innerHTML = producaoDoDia.map(p => {
                            const produto = App.state.cache.produtos.find(prod => prod.ProdutoID === p.ProdutoID);
                            const turno = App.state.cache.turnos.find(t => t.TurnoID === p.TurnoID);
                            const totalCubagem = produto ? (produto.Cubagem_m3 || 0) * (p.Quantidade_Chapas || 0) : 0;
                            return `
                                <tr id="producao-row-${p.ProducaoID}">
                                    <td>${p.ProducaoID}</td>
                                    <td>${produto ? produto.Codigo : 'N/A'}</td>
                                    <td>${produto ? produto.Descricao : 'Produto n√£o encontrado'}</td>
                                    <td>${p.Quantidade_Chapas}</td>
                                    <td>${turno ? turno.TurnoNome : 'N/A'}</td>
                                    <td>${p.Observacoes ? p.Observacoes : ''}</td>
                                    <td>${App.utils.formatLaunchDate(p.createdAt, p.Data)}</td>
                                    <td><strong>${totalCubagem.toFixed(6)} m¬≥</strong></td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" onclick="abrirModalEditarProducao(${p.ProducaoID})">Editar</button>
                                        <button class="btn btn-sm btn-danger" onclick="excluirProducao(${p.ProducaoID})">Excluir</button>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    }
                    this.updateTotaisDoDia(producaoDoDia);
                },
                updateTotaisDoDia(producaoDoDia) {
                    const totalChapas = producaoDoDia.reduce((sum, p) => sum + (p.Quantidade_Chapas || 0), 0);
                    const totalVolume = producaoDoDia.reduce((sum, p) => {
                        const produto = App.state.cache.produtos.find(prod => prod.ProdutoID === p.ProdutoID);
                        const cubagem = produto ? (produto.Cubagem_m3 || 0) * (p.Quantidade_Chapas || 0) : 0;
                        return sum + cubagem;
                    }, 0);
                    App.utils.setText('#totalChapasDia', totalChapas.toString());
                    App.utils.setText('#totalVolumeDia', `${totalVolume.toFixed(3)} m¬≥`);
                },
                initEsquadrejadeiraTab() {
                    App.utils.$('#dataEsq').value = App.state.dataRefEsq;
                    App.ui.populateSelect('turnoEsq', App.state.cache.turnos, 'TurnoID', 'TurnoNome');
                    App.ui.populateSelect('produtoCodigoEsq', App.state.cache.produtos, 'Codigo', 'Descricao');
                    this.renderEsqDoDia();
                },
                setDataRefEsq() {
                    const novaData = App.utils.getValue('#dataRefEsq');
                    App.state.dataRefEsq = novaData;
                    localStorage.setItem('esq.dataRef', novaData);
                    App.utils.$('#dataEsq').value = novaData;
                    this.renderEsqDoDia();
                },
                async registrarProducaoEsq() {
                    const btn = App.utils.$('#btnRegistrarEsq');
                    btn.disabled = true;
                    try {
                        const codigo = App.utils.getValue('#codigoEsqInput') || App.utils.getValue('#produtoCodigoEsq');
                        const produto = App.state.cache.produtos.find(p => p.Codigo == codigo);
                        if (!produto) {
                            return App.ui.showNotification('Produto n√£o encontrado!', 'error');
                        }
                        if (!produto.Cubagem_m3 || produto.Cubagem_m3 <= 0) {
                            return App.ui.showNotification('Produto sem dimens√µes (comprimento/largura/bitola). N√£o √© poss√≠vel calcular m¬≥.', 'error');
                        }
                        const payload = {
                            Data: App.utils.getValue('#dataEsq'),
                            TurnoID: parseInt(App.utils.getValue('#turnoEsq'), 10),
                            SetorID: App.state.setorEsquadrejadeiraId,
                            ProdutoID: produto.ProdutoID,
                            Quantidade_Chapas: parseInt(App.utils.getValue('#quantidadeEsq'), 10)
                        };
                        if (!payload.ProdutoID || !payload.Quantidade_Chapas || !payload.TurnoID || !payload.Data || !payload.SetorID || payload.Quantidade_Chapas <= 0) {
                            return App.ui.showNotification('Por favor, preencha todos os campos obrigat√≥rios corretamente.', 'error');
                        }
                        const novoLancamento = await App.utils.apiCall('/producao', {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });
                        if (novoLancamento && novoLancamento.ProducaoID) {
                            App.state.cache.producao.push(novoLancamento);
                            App.ui.showNotification("Lan√ßamento registrado com sucesso!");
                        } else {
                            App.ui.showNotification(novoLancamento.message || "Lan√ßamento registrado, atualizando lista...");
                            await this.loadProducao();
                        }
                        App.utils.$('#codigoEsqInput').value = '';
                        App.utils.$('#quantidadeEsq').value = '';
                        App.utils.$('#produtoCodigoEsq').value = '';
                        App.utils.$('#descricaoProdutoEsqPreview').textContent = '';
                        App.utils.$('#codigoEsqInput').focus();
                        this.renderEsqDoDia();
                        this.loadDashboard();
                    } finally {
                        btn.disabled = false;
                    }
                },
                renderEsqDoDia() {
                    const tbody = App.utils.$('#esqDiaTbody');
                    if (!tbody) return;
                    const dataFiltro = App.state.dataRefEsq;
                    const setorId = App.state.setorEsquadrejadeiraId;
                    const producaoDoDia = App.state.cache.producao
                        .filter(p => p.Data === dataFiltro && p.SetorID === setorId)
                        .sort((a, b) => b.ProducaoID - a.ProducaoID);
                    if (producaoDoDia.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Nenhum lan√ßamento para ${new Date(dataFiltro + 'T00:00:00').toLocaleDateString('pt-BR')}.</td></tr>`;
                    } else {
                        tbody.innerHTML = producaoDoDia.map(p => {
                            const produto = App.state.cache.produtos.find(prod => prod.ProdutoID === p.ProdutoID);
                            const turno = App.state.cache.turnos.find(t => t.TurnoID === p.TurnoID);
                            const totalCubagem = produto ? (produto.Cubagem_m3 || 0) * (p.Quantidade_Chapas || 0) : 0;
                            return `
                                <tr id="producao-row-${p.ProducaoID}">
                                    <td>${p.ProducaoID}</td>
                                    <td>${produto ? produto.Codigo : 'N/A'}</td>
                                    <td>${produto ? produto.Descricao : 'Produto n√£o encontrado'}</td>
                                    <td>${p.Quantidade_Chapas}</td>
                                    <td>${turno ? turno.TurnoNome : 'N/A'}</td>
                                    <td><strong>${totalCubagem.toFixed(6)} m¬≥</strong></td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" onclick="abrirModalEditarProducao(${p.ProducaoID})">Editar</button>
                                        <button class="btn btn-sm btn-danger" onclick="excluirProducao(${p.ProducaoID})">Excluir</button>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    }
                    this.updateTotaisDoDiaEsq(producaoDoDia);
                },
                updateTotaisDoDiaEsq(producaoDoDia) {
                    const totalChapas = producaoDoDia.reduce((sum, p) => sum + (p.Quantidade_Chapas || 0), 0);
                    const totalVolume = producaoDoDia.reduce((sum, p) => {
                        const produto = App.state.cache.produtos.find(prod => prod.ProdutoID === p.ProdutoID);
                        const cubagem = produto ? (produto.Cubagem_m3 || 0) * (p.Quantidade_Chapas || 0) : 0;
                        return sum + cubagem;
                    }, 0);
                    App.utils.setText('#totalChapasEsqDia', totalChapas.toString());
                    App.utils.setText('#totalVolumeEsqDia', `${totalVolume.toFixed(3)} m¬≥`);
                },
                sync: {
                    async updateGerencial() {
                        const selDate = App.utils.getValue('#filtroDataGerencial') || App.utils.getTodayDateString();
                        if (App.state.isConnected) {
                            await Promise.all([
                                App.logic.loadProducao(),
                                App.logic.loadDescarte()
                            ]);
                        }
                        const {
                            producao: allProducao = [], produtos = [], turnos = [], familias = [], descarte = []
                        } = App.state.cache;
                        const setorEsqId = App.state.setorEsquadrejadeiraId;
                        const producao = allProducao.filter(p => p.SetorID !== setorEsqId);
                        const produtoById = Object.fromEntries(produtos.map(p => [p.ProdutoID, p]));
                        const turnoById = Object.fromEntries(turnos.map(t => [t.TurnoID, t]));
                        const familiaById = Object.fromEntries(familias.map(f => [f.FamiliaID, f]));
                        const fmt2d = (n) => (Number(n) || 0).toFixed(2).replace('.', ',');
                        const fmtPerc = (n) => (Number(n) || 0).toFixed(1).replace('.', ',');
                        const fmtChapas = (n) => (Number(n) || 0).toFixed(0);
                        const getM3 = (r) => {
                            const produto = produtoById[r.ProdutoID];
                            return produto ? (produto.Cubagem_m3 * r.Quantidade_Chapas) : 0;
                        };
                        const calcularPercentualDescarte = (producao, descarte) => {
                            const total = producao + descarte;
                            return total > 0 ? (descarte / total) * 100 : 0;
                        };
                        const classificarTurno = (turnoNome = '') => {
                            const s = String(turnoNome).toUpperCase();
                            if (s.includes('MESA ELEVADA')) return 'ELEVADA';
                            if (s === 'ESTEIRA' || s.includes('ESTEIRA') || s.includes('PLASTICO MESA 1 ESTEIRA') || (s.includes('2¬∫ TURNO MESA') && s.includes('ESTEIRA'))) return 'ESTEIRA';
                            if (s.includes('3¬∫ TURNO')) return '3T';
                            if (s.includes('1¬∫ TURNO') && !s.includes('ESTEIRA') && !s.includes('MESA ELEVADA')) return '1T';
                            if (s.includes('2¬∫ TURNO') && !s.includes('ESTEIRA') && !s.includes('MESA ELEVADA')) return '2T';
                            return 'OUTRO';
                        };
                        const grupos = {
                            '1T': 0,
                            '2T': 0,
                            '3T': 0,
                            'ELEVADA': 0,
                            'ESTEIRA': 0
                        };
                        const recDiaProd = producao.filter(r => r.Data === selDate);
                        const recDiaDesc = descarte.filter(r => r.Data === selDate);
                        const totDiaProd = {
                            ...grupos
                        };
                        const totDiaDescM3 = {
                            ...grupos
                        };
                        const totDiaDescChapas = {
                            ...grupos
                        };
                        const totDiaProdElevada = {
                            '1T': 0,
                            '2T': 0
                        };
                        const totDiaDescM3Elevada = {
                            '1T': 0,
                            '2T': 0
                        };
                        const totDiaDescChapasElevada = {
                            '1T': 0,
                            '2T': 0
                        };
                        for (const r of recDiaProd) {
                            const turno = turnoById[r.TurnoID];
                            const turnoNome = turno?.TurnoNome?.toUpperCase() || '';
                            const grupo = classificarTurno(turnoNome);
                            if (totDiaProd[grupo] !== undefined) totDiaProd[grupo] += getM3(r);
                            if (grupo === 'ELEVADA') {
                                if (turnoNome.includes('1¬∫ TURNO')) {
                                    totDiaProdElevada['1T'] += getM3(r);
                                } else if (turnoNome.includes('2¬∫ TURNO')) {
                                    totDiaProdElevada['2T'] += getM3(r);
                                }
                            }
                        }
                        for (const r of recDiaDesc) {
                            const turno = turnoById[r.TurnoID];
                            const turnoNome = turno?.TurnoNome?.toUpperCase() || '';
                            const grupo = classificarTurno(turnoNome);
                            if (totDiaDescM3[grupo] !== undefined) {
                                totDiaDescM3[grupo] += getM3(r);
                                totDiaDescChapas[grupo] += (r.Quantidade_Chapas || 0);
                            }
                            if (grupo === 'ELEVADA') {
                                if (turnoNome.includes('1¬∫ TURNO')) {
                                    totDiaDescM3Elevada['1T'] += getM3(r);
                                    totDiaDescChapasElevada['1T'] += (r.Quantidade_Chapas || 0);
                                } else if (turnoNome.includes('2¬∫ TURNO')) {
                                    totDiaDescM3Elevada['2T'] += getM3(r);
                                    totDiaDescChapasElevada['2T'] += (r.Quantidade_Chapas || 0);
                                }
                            }
                        }
                        const totalGeralDiaProd = Object.values(totDiaProd).reduce((a, b) => a + b, 0);
                        const totalGeralDiaDescM3 = Object.values(totDiaDescM3).reduce((a, b) => a + b, 0);
                        const totalGeralDiaDescChapas = Object.values(totDiaDescChapas).reduce((a, b) => a + b, 0);
                        const cardsTotaisDia = App.utils.$('#cardsTotaisDia');
                        if (cardsTotaisDia) {
                            cardsTotaisDia.innerHTML = [
                                ['1¬∫ TURNO', totDiaProd['1T'], totDiaDescM3['1T'], totDiaDescChapas['1T']],
                                ['2¬∫ TURNO', totDiaProd['2T'], totDiaDescM3['2T'], totDiaDescChapas['2T']],
                                ['3¬∫ TURNO', totDiaProd['3T'], totDiaDescM3['3T'], totDiaDescChapas['3T']],
                                ['MESA ELEVADA', totDiaProd['ELEVADA'], totDiaDescM3['ELEVADA'], totDiaDescChapas['ELEVADA']],
                                ['ESTEIRA', totDiaProd['ESTEIRA'], totDiaDescM3['ESTEIRA'], totDiaDescChapas['ESTEIRA']],
                                ['TOTAL GERAL', totalGeralDiaProd, totalGeralDiaDescM3, totalGeralDiaDescChapas]
                            ].map(([label, valProd, valDescM3, valDescChapas]) => {
                                const percDescarte = calcularPercentualDescarte(valProd, valDescM3);
                                const descarteFormatado = `${fmt2d(valDescM3)} m¬≥ | ${fmtChapas(valDescChapas)} chapas | ${fmtPerc(percDescarte)}%`;
                                return `
                                <div class="mesa-card">
                                    <div class="mesa-header">${label}</div>
                                    <div class="mesa-value valor-azul" style="margin-bottom: 0.25rem;">${fmt2d(valProd)} m¬≥</div>
                                    <div style="font-size: 0.8rem; color: var(--danger-color); font-weight: 600;">
                                        Descarte: ${descarteFormatado}
                                    </div>
                                </div>`;
                            }).join('');
                        }
                        const ym = selDate.slice(0, 7);
                        const recMesProd = producao.filter(r => (r.Data || '').startsWith(ym) && r.Quantidade_Chapas > 0);
                        const recMesDesc = descarte.filter(r => (r.Data || '').startsWith(ym));
                        const totMesProd = {
                            ...grupos
                        };
                        const totMesDescM3 = {
                            ...grupos
                        };
                        const totMesDescChapas = {
                            ...grupos
                        };
                        for (const r of recMesProd) {
                            const turno = turnoById[r.TurnoID];
                            const grupo = classificarTurno(turno?.TurnoNome || '');
                            if (totMesProd[grupo] !== undefined) totMesProd[grupo] += getM3(r);
                        }
                        for (const r of recMesDesc) {
                            const turno = turnoById[r.TurnoID];
                            const grupo = classificarTurno(turno?.TurnoNome || '');
                            if (totMesDescM3[grupo] !== undefined) {
                                totMesDescM3[grupo] += getM3(r);
                                totMesDescChapas[grupo] += (r.Quantidade_Chapas || 0);
                            }
                        }
                        const totalGeralMesProd = Object.values(totMesProd).reduce((a, b) => a + b, 0);
                        const totalGeralMesDescM3 = Object.values(totMesDescM3).reduce((a, b) => a + b, 0);
                        const totalGeralMesDescChapas = Object.values(totMesDescChapas).reduce((a, b) => a + b, 0);
                        const cardsMediasMes = App.utils.$('#cardsMediasMes');
                        if (cardsMediasMes) {
                            cardsMediasMes.innerHTML = [
                                ['1¬∫ TURNO', totMesProd['1T'], totMesDescM3['1T'], totMesDescChapas['1T'], '1T'],
                                ['2¬∫ TURNO', totMesProd['2T'], totMesDescM3['2T'], totMesDescChapas['2T'], '2T'],
                                ['3¬∫ TURNO', totMesProd['3T'], totMesDescM3['3T'], totMesDescChapas['3T'], '3T'],
                                ['MESA ELEVADA', totMesProd['ELEVADA'], totMesDescM3['ELEVADA'], totMesDescChapas['ELEVADA'], 'ELEVADA'],
                                ['ESTEIRA', totMesProd['ESTEIRA'], totMesDescM3['ESTEIRA'], totMesDescChapas['ESTEIRA'], 'ESTEIRA'],
                                ['TOTAIS', totalGeralMesProd, totalGeralMesDescM3, totalGeralMesDescChapas, 'TOTAIS']
                            ].map(([label, prodAcumulada, descM3, descChapas, grupoId]) => {
                                const diasComProducaoDoGrupo = new Set(
                                    recMesProd
                                        .filter(r => {
                                            if (grupoId === 'TOTAIS') return true;
                                            const turno = turnoById[r.TurnoID];
                                            const grupo = classificarTurno(turno?.TurnoNome || '');
                                            return grupo === grupoId;
                                        })
                                        .map(r => r.Data)
                                );
                                const divisorEspecifico = diasComProducaoDoGrupo.size > 0 ? diasComProducaoDoGrupo.size : 1;
                                const prodMedia = prodAcumulada / divisorEspecifico;
                                const mediaFormatada = diasComProducaoDoGrupo.size > 0 ? `${fmt2d(prodMedia)} m¬≥/dia` : '‚Äî';
                                const percDescarte = calcularPercentualDescarte(prodAcumulada, descM3);
                                const descarteFormatado = `${fmt2d(descM3)} m¬≥ | ${fmtChapas(descChapas)} chapas | ${fmtPerc(percDescarte)}%`;
                                return `
                                <div class="mesa-card">
                                    <div class="mesa-header">${label}</div>
                                     <div style="text-align: left; padding: 0.5rem; font-size: 0.9rem; min-height: 90px; display: flex; flex-direction: column; justify-content: center;">
                                        <p style="margin-bottom: 0.25rem;"><strong>Produ√ß√£o M√©dia:</strong> ${mediaFormatada}</p>
                                        <p style="margin-bottom: 0.25rem;"><strong>Produ√ß√£o Acumulada:</strong> ${fmt2d(prodAcumulada)} m¬≥</p>
                                        <p><strong>Descarte:</strong> <span style="color: var(--danger-color); font-weight: 600;">${descarteFormatado}</span></p>
                                    </div>
                                </div>`;
                            }).join('');
                            /* === IN√çCIO: handler que cria aba din√¢mica para o turno clicado === */
                            (function attachResumoMesCardHandlers() {
                                const container = document.getElementById('cardsMediasMes');
                                if (!container) return;

                                function injectModalCSS() {
                                    if (document.getElementById('modal-producao-style')) return;
                                    const style = document.createElement('style');
                                    style.id = 'modal-producao-style';
                                    style.innerHTML = `
            .producao-modal-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: rgba(0, 0, 0, 0.6); display: flex;
                justify-content: center; align-items: center; z-index: 1050;
            }
            .producao-modal-content {
                background-color: #fff; padding: 25px; border-radius: 8px;
                width: 90%; max-width: 800px; max-height: 90vh;
                overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            }
            .producao-modal-header {
                border-bottom: 1px solid #dee2e6; padding-bottom: 1rem; margin-bottom: 1rem;
                display: flex; justify-content: space-between; align-items: center;
            }
            .producao-modal-header h4 { margin: 0; }
            .producao-modal-close {
                border: none; background: transparent; font-size: 1.5rem;
                cursor: pointer; padding: 0.5rem 1rem;
            }
            .producao-link {
                cursor: pointer; color: inherit !important; font-weight: bold;
                text-decoration: underline;
            }
            .producao-link:hover { text-decoration: none; }
            .btn-obs {
                font-size: 12px; padding: 2px 8px; cursor: pointer;
                border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 4px;
            }
        `;
                                    document.head.appendChild(style);
                                }

                                setTimeout(() => {
                                    container.querySelectorAll('.mesa-card').forEach(card => {
                                        card.addEventListener('click', () => {
                                            const turnoKey = card.dataset.turnoKey || (card.querySelector('.mesa-header')?.textContent || '').trim();
                                            if (turnoKey) createDynamicTurnoTab(turnoKey);
                                        });
                                    });
                                }, 10);

                                function createDynamicTurnoTab(turnoKey) {
                                    const safeId = `detalhes-turno-${turnoKey.replace(/[^a-zA-Z0-9_-]/g, '_')}_${Date.now()}`;
                                    const navArea = document.querySelector('.nav-tab-container') || document.querySelector('.nav-tabs') || document.querySelector('.nav');
                                    if (navArea) {
                                        const btn = document.createElement('button');
                                        btn.className = 'nav-tab';
                                        btn.dataset.tab = safeId;
                                        btn.textContent = `Detalhes ${turnoKey}`;
                                        btn.onclick = () => {
                                            const switchFn = (App?.logic?.switchTab) || (window.App?.switchTab);
                                            if (switchFn) switchFn(safeId);
                                        };
                                        navArea.appendChild(btn);
                                    }
                                    const mainContainer = document.querySelector('#mainTabsContainer') || document.body;
                                    const content = document.createElement('div');
                                    content.id = safeId;
                                    content.className = 'tab-content';
                                    content.innerHTML = `<div class="card"><div id="${safeId}-inner">Carregando dados...</div></div>`;
                                    mainContainer.appendChild(content);
                                    renderTurnoDetalhes(safeId, turnoKey);
                                    const switchFn = (App?.logic?.switchTab) || (window.App?.switchTab);
                                    if (switchFn) {
                                        switchFn(safeId);
                                    } else {
                                        document.querySelector(`[data-tab="${safeId}"]`)?.click();
                                    }
                                }

                                function showProducaoDetailsModal(mesa, dia, anoMes, familias) {
                                    const producaoCache = (App?.state?.cache?.producao) || [];
                                    const produtosCache = (App?.state?.cache?.produtos) || [];
                                    const turnosCache = (App?.state?.cache?.turnos) || [];
                                    const familiasCache = (App?.state?.cache?.familias) || [];

                                    const [ano, mes] = anoMes.split('-');
                                    const dataCompleta = `${ano}-${mes}-${dia.padStart(2, '0')}`;
                                    const familiasArray = familias.split(' + ').map(f => f.trim());

                                    const producaoDetalhada = producaoCache.filter(p => {
                                        if (p.Data !== dataCompleta) return false;
                                        const turno = turnosCache.find(t => t.TurnoID === p.TurnoID);
                                        if (!turno) return false;
                                        const mesaDoRegistro = extractMesaFromTurno(turno.TurnoNome);
                                        if (mesaDoRegistro !== mesa) return false;
                                        const produto = produtosCache.find(prod => prod.ProdutoID === p.ProdutoID);
                                        if (!produto) return false;
                                        const familiaInfo = familiasCache.find(f => f.FamiliaID === produto.FamiliaID);
                                        const familiaDoRegistro = familiaInfo?.FamiliaNome?.trim() || '';
                                        return familiasArray.includes(familiaDoRegistro);
                                    });

                                    if (producaoDetalhada.length === 0) {
                                        alert(`Nenhum detalhe de produ√ß√£o encontrado para ${mesa} no dia ${dia}/${mes}/${ano}.`);
                                        return;
                                    }

                                    const produtosAgrupados = {};
                                    producaoDetalhada.forEach(p => {
                                        const qtd = parseInt(p.Quantidade_Chapas) || 0;
                                        if (!produtosAgrupados[p.ProdutoID]) produtosAgrupados[p.ProdutoID] = { totalChapas: 0 };
                                        produtosAgrupados[p.ProdutoID].totalChapas += qtd;
                                    });

                                    let modalHtml = `<div class="producao-modal-overlay"><div class="producao-modal-content"><div class="producao-modal-header"><h4>Detalhes da Produ√ß√£o: ${mesa} - ${dia}/${mes}/${ano}</h4><button class="producao-modal-close">&times;</button></div><table class="table"><thead><tr><th>Produto</th><th>Qtd. Chapas</th><th>Volume (m¬≥)</th></tr></thead><tbody>`;

                                    Object.keys(produtosAgrupados).forEach(produtoId => {
                                        const produto = produtosCache.find(p => p.ProdutoID == produtoId);
                                        const dados = produtosAgrupados[produtoId];
                                        const cubagem = parseFloat(produto?.Cubagem_m3) || 0;
                                        const volume = dados.totalChapas * cubagem;
                                        modalHtml += `<tr><td>${produto?.Descricao || `Produto ID ${produtoId}`}</td><td>${dados.totalChapas}</td><td>${volume.toFixed(3)}</td></tr>`;
                                    });

                                    modalHtml += `</tbody></table></div></div>`;
                                    const modalElement = document.createElement('div');
                                    modalElement.innerHTML = modalHtml;
                                    document.body.appendChild(modalElement);

                                    const closeModal = () => modalElement.remove();
                                    const overlay = modalElement.querySelector('.producao-modal-overlay');
                                    const closeBtn = modalElement.querySelector('.producao-modal-close');
                                    if (overlay) overlay.addEventListener('click', (e) => {
                                        if (e.target === e.currentTarget) closeModal();
                                    });
                                    if (closeBtn) closeBtn.addEventListener('click', closeModal);
                                }

                                // --- NOVA FUN√á√ÉO PARA MOSTRAR OBSERVA√á√ïES ---
                                function showObservacaoModal(mesa, dia, anoMes, familias) {
                                    const producaoCache = (App?.state?.cache?.producao) || [];
                                    const produtosCache = (App?.state?.cache?.produtos) || [];
                                    const turnosCache = (App?.state?.cache?.turnos) || [];
                                    const familiasCache = (App?.state?.cache?.familias) || [];

                                    const [ano, mes] = anoMes.split('-');
                                    const dataCompleta = `${ano}-${mes}-${dia.padStart(2, '0')}`;
                                    const familiasArray = familias.split(' + ').map(f => f.trim());

                                    const producaoDetalhada = producaoCache.filter(p => {
                                        if (p.Data !== dataCompleta) return false;
                                        const turno = turnosCache.find(t => t.TurnoID === p.TurnoID);
                                        if (!turno) return false;
                                        const mesaDoRegistro = extractMesaFromTurno(turno.TurnoNome);
                                        if (mesaDoRegistro !== mesa) return false;
                                        const produto = produtosCache.find(prod => prod.ProdutoID === p.ProdutoID);
                                        if (!produto) return false;
                                        const familiaInfo = familiasCache.find(f => f.FamiliaID === produto.FamiliaID);
                                        const familiaDoRegistro = familiaInfo?.FamiliaNome?.trim() || '';
                                        return familiasArray.includes(familiaDoRegistro);
                                    });

                                    const observacoes = producaoDetalhada
                                        .map(p => p.Obs?.trim())
                                        .filter(obs => obs);

                                    let contentHtml;
                                    if (observacoes.length > 0) {
                                        contentHtml = '<ul>' + observacoes.map(obs => `<li>${obs}</li>`).join('') + '</ul>';
                                    } else {
                                        contentHtml = '<p>Nenhuma observa√ß√£o encontrada para esta produ√ß√£o.</p>';
                                    }

                                    let modalHtml = `<div class="producao-modal-overlay"><div class="producao-modal-content"><div class="producao-modal-header"><h4>Observa√ß√µes: ${mesa} - ${dia}/${mes}/${ano}</h4><button class="producao-modal-close">&times;</button></div>${contentHtml}</div></div>`;

                                    const modalElement = document.createElement('div');
                                    modalElement.innerHTML = modalHtml;
                                    document.body.appendChild(modalElement);

                                    const closeModal = () => modalElement.remove();
                                    const overlay = modalElement.querySelector('.producao-modal-overlay');
                                    const closeBtn = modalElement.querySelector('.producao-modal-close');
                                    if (overlay) overlay.addEventListener('click', (e) => {
                                        if (e.target === e.currentTarget) closeModal();
                                    });
                                    if (closeBtn) closeBtn.addEventListener('click', closeModal);
                                }


                                function renderTurnoDetalhes(tabId, turnoKey) {
                                    const inner = document.getElementById(`${tabId}-inner`);
                                    if (!inner) return;

                                    injectModalCSS();

                                    const dataCompleta = App?.utils?.getValue?.('#filtroDataGerencial');
                                    const anoMes = dataCompleta ? dataCompleta.substring(0, 7) : null;

                                    if (!anoMes) {
                                        inner.innerHTML = `<div class="alert alert-warning">Selecione uma data no filtro gerencial.</div>`;
                                        return;
                                    }

                                    const producaoCache = (App?.state?.cache?.producao) || [];
                                    const descarteCache = (App?.state?.cache?.descarte) || [];
                                    const produtosCache = (App?.state?.cache?.produtos) || [];
                                    const turnosCache = (App?.state?.cache?.turnos) || [];
                                    const familiasCache = (App?.state?.cache?.familias) || [];
                                    const turnosDoTipo = turnosCache.filter(t => t.TurnoNome?.includes(turnoKey));
                                    const turnoIds = turnosDoTipo.map(t => t.TurnoID);

                                    let producaoFiltrada = producaoCache.filter(p => p.Data?.startsWith(anoMes) && turnoIds.includes(p.TurnoID));
                                    let descarteFiltrado = descarteCache.filter(d => d.Data?.startsWith(anoMes) && turnoIds.includes(d.TurnoID));

                                    if (turnoKey.includes('1¬∫ TURNO') || turnoKey.includes('2¬∫ TURNO')) {
                                        const turnoIdToNomeMap = new Map(turnosCache.map(t => [t.TurnoID, t.TurnoNome]));
                                        const isNotMesaElevada = (record) => {
                                            const turnoNome = turnoIdToNomeMap.get(record.TurnoID) || '';
                                            return extractMesaFromTurno(turnoNome) !== 'Mesa Elevada';
                                        };
                                        producaoFiltrada = producaoFiltrada.filter(isNotMesaElevada);
                                        descarteFiltrado = descarteFiltrado.filter(isNotMesaElevada);
                                    }

                                    if (producaoFiltrada.length === 0 && descarteFiltrado.length === 0) {
                                        inner.innerHTML = `<div class="alert alert-info">Nenhuma produ√ß√£o ou descarte encontrado.</div>`;
                                        return;
                                    }

                                    const dadosPorMesaEDia = {};
                                    let totalM3Geral = 0;
                                    producaoFiltrada.forEach(prod => {
                                        const produto = produtosCache.find(p => p.ProdutoID === prod.ProdutoID);
                                        const turno = turnosCache.find(t => t.TurnoID === prod.TurnoID);
                                        if (!produto || !turno || !prod.Data) return;
                                        const dia = prod.Data.substring(8, 10);
                                        const mesa = extractMesaFromTurno(turno.TurnoNome);
                                        let familia = familiasCache.find(f => f.FamiliaID === produto.FamiliaID)?.FamiliaNome || 'Sem fam√≠lia';
                                        if (!dadosPorMesaEDia[mesa]) dadosPorMesaEDia[mesa] = {};
                                        if (!dadosPorMesaEDia[mesa][dia]) dadosPorMesaEDia[mesa][dia] = {};
                                        if (!dadosPorMesaEDia[mesa][dia][familia]) dadosPorMesaEDia[mesa][dia][familia] = { m3: 0 };
                                        const totalM3 = (parseFloat(produto.Cubagem_m3) || 0) * (parseInt(prod.Quantidade_Chapas) || 0);
                                        dadosPorMesaEDia[mesa][dia][familia].m3 += totalM3;
                                        totalM3Geral += totalM3;
                                    });

                                    const descartePorMesaEDia = {};
                                    let descarteTotal = 0;
                                    descarteFiltrado.forEach(desc => {
                                        const produto = produtosCache.find(p => p.ProdutoID === desc.ProdutoID);
                                        const turno = turnosCache.find(t => t.TurnoID === desc.TurnoID);
                                        if (!produto || !turno || !desc.Data) return;
                                        const dia = desc.Data.substring(8, 10);
                                        const mesa = extractMesaFromTurno(turno.TurnoNome);
                                        let familia = familiasCache.find(f => f.FamiliaID === produto.FamiliaID)?.FamiliaNome || 'Sem fam√≠lia';
                                        if (!descartePorMesaEDia[mesa]) descartePorMesaEDia[mesa] = {};
                                        if (!descartePorMesaEDia[mesa][dia]) descartePorMesaEDia[mesa][dia] = {};
                                        const totalM3Descarte = (parseFloat(produto.Cubagem_m3) || 0) * (parseInt(desc.Quantidade_Chapas) || 0);
                                        if (!descartePorMesaEDia[mesa][dia][familia]) descartePorMesaEDia[mesa][dia][familia] = 0;
                                        descartePorMesaEDia[mesa][dia][familia] += totalM3Descarte;
                                        descarteTotal += totalM3Descarte;
                                    });

                                    const buttonId = `btn-voltar-${tabId}`;
                                    let html = `<div style="overflow:auto;"><button id="${buttonId}" style="float: right; cursor: pointer; padding: 5px 10px; border-radius: 5px; border: 1px solid #ccc; background-color: #f0f0f0; font-size: 14px;">Voltar / Fechar</button><h4>Produ√ß√£o detalhada - ${turnoKey} (${anoMes})</h4><table class="table" style="width:100%;"><thead><tr><th style="width: 15%;">Data</th><th>Fam√≠lia(s)</th><th style="width: 15%;">Meta (m¬≥)</th><th style="width: 15%;">Produ√ß√£o (m¬≥)</th><th style="width: 10%;">Obs.</th><th style="width: 15%;">Descarte (m¬≥)</th></tr></thead>`;
                                    const [ano, mes] = anoMes.split('-');
                                    Object.keys(dadosPorMesaEDia).sort().forEach(mesa => {
                                        const safeMesaId = `tbody-mesa-${mesa.replace(/[^a-zA-Z0-9_-]/g, '_')}-${tabId}`;
                                        html += `<tbody id="${safeMesaId}"><tr style="background-color: #f0f2f5; font-weight: bold; text-align: center;"><td colspan="6" style="position: relative; padding: 8px;">${mesa}<button class="btn-toggle-mesa" data-target-id="${safeMesaId}" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 12px; padding: 2px 8px; cursor: pointer;">Recolher</button></td></tr>`;
                                        const diasDaMesa = dadosPorMesaEDia[mesa];
                                        Object.keys(diasDaMesa).sort().forEach(dia => {
                                            const familiasDoDiaObj = diasDaMesa[dia];
                                            let producaoTotalDia = 0, descarteTotalDia = 0;
                                            const familiasNomesArray = Object.keys(familiasDoDiaObj).sort();
                                            familiasNomesArray.forEach(familiaNome => {
                                                producaoTotalDia += familiasDoDiaObj[familiaNome].m3;
                                                descarteTotalDia += descartePorMesaEDia[mesa]?.[dia]?.[familiaNome] || 0;
                                            });
                                            const dataFormatada = `${dia}/${mes}/${ano}`;
                                            const familiasAgrupadas = familiasNomesArray.join(' + ');
                                            const metaDiaria = METAS_FAMILIA[familiasAgrupadas.toUpperCase().trim()] || 0.0;
                                            html += `<tr class="mesa-data-row" data-mesa="${mesa}" data-familia="${familiasAgrupadas}">
                            <td>${dataFormatada}</td>
                            <td>${familiasAgrupadas}</td>
                            <td>${metaDiaria.toFixed(3)}</td>
                            <td><a href="#" class="producao-link" data-mesa="${mesa}" data-dia="${dia}" data-ano-mes="${anoMes}" data-familias="${familiasAgrupadas}">${producaoTotalDia.toFixed(3)}</a></td>
                            <td><button class="btn-obs" data-mesa="${mesa}" data-dia="${dia}" data-ano-mes="${anoMes}" data-familias="${familiasAgrupadas}">Ver</button></td>
                            <td>${descarteTotalDia.toFixed(3)}</td>
                         </tr>`;
                                        });
                                        html += `</tbody>`;
                                    });
                                    html += `</table><div style="margin-top: 1rem; font-size: 0.9rem; color: #666;"><strong>Total produzido:</strong> ${totalM3Geral.toFixed(3)} m¬≥ | <strong>Total descarte:</strong> ${descarteTotal.toFixed(3)} m¬≥ | <strong>Per√≠odo:</strong> ${anoMes}</div></div>`;
                                    inner.innerHTML = html;

                                    const btnVoltar = document.getElementById(buttonId);
                                    if (btnVoltar) btnVoltar.addEventListener('click', () => {
                                        document.getElementById(tabId)?.remove();
                                        document.querySelector(`button[data-tab="${tabId}"]`)?.remove();
                                        const remainingTabs = document.querySelectorAll('.nav-tab');
                                        let targetTabId = null;
                                        for (const tab of remainingTabs) {
                                            if (tab.textContent.toUpperCase().includes('GERENCIAL')) { targetTabId = tab.dataset.tab; break; }
                                        }
                                        if (!targetTabId && remainingTabs.length > 0) targetTabId = remainingTabs[0].dataset.tab;
                                        if (targetTabId) {
                                            const switchFn = (App?.logic?.switchTab) || (window.App?.switchTab);
                                            if (switchFn) switchFn(targetTabId);
                                        }
                                    });

                                    inner.querySelectorAll('.btn-toggle-mesa').forEach(button => {
                                        button.addEventListener('click', (e) => {
                                            e.stopPropagation();
                                            const tbody = document.getElementById(button.dataset.targetId);
                                            if (!tbody) return;
                                            const dataRows = tbody.querySelectorAll('.mesa-data-row');
                                            const isCollapsed = button.textContent.trim() === 'Expandir';
                                            dataRows.forEach(row => row.style.display = isCollapsed ? '' : 'none');
                                            button.textContent = isCollapsed ? 'Recolher' : 'Expandir';
                                        });
                                    });

                                    inner.querySelectorAll('.producao-link').forEach(link => {
                                        link.addEventListener('click', (e) => {
                                            e.preventDefault();
                                            try {
                                                const { mesa, dia, anoMes, familias } = e.currentTarget.dataset;
                                                showProducaoDetailsModal(mesa, dia, anoMes, familias);
                                            } catch (error) {
                                                console.error("ERRO AO TENTAR MOSTRAR O MODAL DE PRODU√á√ÉO:", error);
                                                alert("Ocorreu um erro ao buscar os detalhes da produ√ß√£o.");
                                            }
                                        });
                                    });

                                    // --- Adiciona evento de clique para os bot√µes de observa√ß√£o ---
                                    inner.querySelectorAll('.btn-obs').forEach(button => {
                                        button.addEventListener('click', (e) => {
                                            try {
                                                const { mesa, dia, anoMes, familias } = e.currentTarget.dataset;
                                                showObservacaoModal(mesa, dia, anoMes, familias);
                                            } catch (error) {
                                                console.error("ERRO AO TENTAR MOSTRAR O MODAL DE OBSERVA√á√ÉO:", error);
                                                alert("Ocorreu um erro ao buscar as observa√ß√µes.");
                                            }
                                        });
                                    });

                                    applyFamiliaMetasColor(inner);
                                }

                                function extractMesaFromTurno(turnoNome) {
                                    if (!turnoNome) return 'Mesa Desconhecida';
                                    const match = turnoNome.match(/MESA\s+(\d+)/i);
                                    if (match) return `Mesa ${match[1]}`;
                                    if (turnoNome.includes('ELEVADA')) return 'Mesa Elevada';
                                    if (turnoNome.includes('ESTEIRA')) return 'Esteira';
                                    return turnoNome;
                                }

                                const METAS_FAMILIA = {
                                    'MOVELEIRO': 11.5, 'RESINADO': 12.5, 'MOVELEIRO + RESINADO': 12.0,
                                    'PLASTIFICADO': 62.0, 'CAMADAS PADR√ÉO': 15.0, 'CAMADAS ESPECIAIS': 11.5,
                                    'MATERIAL COMPLEXO': 6.5, 'EXPORTACAO': 11.5, 'LAMINAS': 10.0
                                };

                                function applyFamiliaMetasColor(container) {
                                    container.querySelectorAll('tbody tr[data-familia]').forEach(r => {
                                        // Os √≠ndices das colunas mudaram por causa da nova coluna "Obs."
                                        const meta = parseFloat(r.children[2]?.textContent.replace(',', '.') || '0');
                                        const prod = parseFloat(r.children[3]?.textContent.replace(',', '.') || '0');
                                        if (meta > 0) {
                                            r.style.color = prod >= meta ? '#2ef714' : '#f71905';
                                        }
                                    });
                                }

                            })();
                            /* === FIM: handler cria aba din√¢mica === */

                        }
                        const somaMesa = (turnoGrupo, mesaNum) => recDiaProd.reduce((acc, r) => {
                            const turno = turnoById[r.TurnoID];
                            const turnoNome = turno?.TurnoNome?.toUpperCase() || '';
                            if (classificarTurno(turnoNome) === turnoGrupo && turnoNome.includes('MESA ' + mesaNum)) {
                                return acc + getM3(r);
                            }
                            return acc;
                        }, 0);
                        const renderGridTurno = (grupo, gridSel, descarteTurnoM3, descarteTurnoChapas) => {
                            const grid = App.utils.$(gridSel);
                            if (!grid) return;
                            const mesasProd = [1, 2, 3, 4].map(n => somaMesa(grupo, n));
                            const totalTurnoProd = mesasProd.reduce((a, b) => a + b, 0);
                            grid.innerHTML = mesasProd.map((val, idx) => {
                                const rate = totalTurnoProd > 0 ? (val / totalTurnoProd) : 0.25;
                                const descarteMesaM3 = descarteTurnoM3 * rate;
                                const descarteMesaChapas = Math.round(descarteTurnoChapas * rate);
                                const percDescarte = calcularPercentualDescarte(val, descarteMesaM3);
                                const descarteFormatado = `${fmt2d(descarteMesaM3)} m¬≥ | ${fmtChapas(descarteMesaChapas)} chapas | ${fmtPerc(percDescarte)}%`;
                                return `
                                <div class="mesa-card">
                                    <div class="card-topo-amarelo">MESA ${idx + 1}</div>
                                    <div class="mesa-value valor-azul" style="margin-bottom: 0.25rem;">${fmt2d(val)} m¬≥</div>
                                    <div style="font-size: 0.8rem; color: var(--danger-color); font-weight: 600;">
                                        Descarte: ${descarteFormatado}
                                    </div>
                                </div>`;
                            }).join('') + `
                                <div class="mesa-card total-turno">
                                    <div class="mesa-header">Total do Turno</div>
                                    <div class="mesa-value valor-azul" style="margin-bottom: 0.25rem;">${fmt2d(totalTurnoProd)} m¬≥</div>
                                    <div style="font-size: 0.8rem; color: var(--danger-color); font-weight: 600;">
                                        Descarte: ${fmt2d(descarteTurnoM3)} m¬≥ | ${fmtChapas(descarteTurnoChapas)} chapas | ${fmtPerc(calcularPercentualDescarte(totalTurnoProd, descarteTurnoM3))}%
                                    </div>
                                </div>`;
                        };
                        renderGridTurno('1T', '#grid1T', totDiaDescM3['1T'], totDiaDescChapas['1T']);
                        renderGridTurno('2T', '#grid2T', totDiaDescM3['2T'], totDiaDescChapas['2T']);
                        const grid3 = App.utils.$('#grid3ElevEsteira');
                        if (grid3) {
                            const dataForGrid3 = [
                                ['3¬∫ TURNO', totDiaProd['3T'], totDiaDescM3['3T'], totDiaDescChapas['3T']],
                                ['Mesa Elevada ‚Äî 1¬∫ Turno', totDiaProdElevada['1T'], totDiaDescM3Elevada['1T'], totDiaDescChapasElevada['1T']],
                                ['Mesa Elevada ‚Äî 2¬∫ Turno', totDiaProdElevada['2T'], totDiaDescM3Elevada['2T'], totDiaDescChapasElevada['2T']],
                                ['ESTEIRA', totDiaProd['ESTEIRA'], totDiaDescM3['ESTEIRA'], totDiaDescChapas['ESTEIRA']]
                            ];
                            grid3.innerHTML = dataForGrid3.map(([label, valProd, valDescM3, valDescChapas]) => {
                                const percDescarte = calcularPercentualDescarte(valProd, valDescM3);
                                const descarteFormatado = `${fmt2d(valDescM3)} m¬≥ | ${fmtChapas(valDescChapas)} chapas | ${fmtPerc(percDescarte)}%`;
                                return `
                                <div class="mesa-card">
                                    <div class="mesa-header">${label}</div>
                                    <div class="mesa-value valor-azul" style="margin-bottom: 0.25rem;">${fmt2d(valProd)} m¬≥</div>
                                    <div style="font-size: 0.8rem; color: var(--danger-color); font-weight: 600;">
                                        Descarte: ${descarteFormatado}
                                    </div>
                                </div>
                            `
                            }).join('');
                        }
                        this.updateTabelaSemanal(selDate, producao, produtoById, familiaById);
                    },
                    updateTabelaSemanal(selDate, producao, produtoById, familiaById) {
                        const fmt = (n) => (Number(n) || 0).toFixed(3);
                        const base = new Date(selDate + 'T00:00:00');
                        const dow = base.getDay();
                        const offsetSeg = (dow === 0 ? -6 : 1 - dow);
                        const seg = new Date(base);
                        seg.setDate(base.getDate() + offsetSeg);
                        const diasSemana = Array.from({
                            length: 5
                        }, (_, i) => {
                            const d = new Date(seg);
                            d.setDate(seg.getDate() + i);
                            return d.toISOString().split('T')[0];
                        });
                        const getFamiliaNome = (produtoID) => {
                            const produto = produtoById[produtoID];
                            if (!produto) return 'OUTROS';
                            const familia = familiaById[produto.FamiliaID];
                            return familia ? familia.FamiliaNome.trim().toUpperCase() : 'OUTROS';
                        };
                        const linhasSemana = diasSemana.map(data => {
                            const regsDia = producao.filter(r => r.Data === data);
                            const totaisDia = {
                                'EXPORTACAO': 0,
                                'PLASTIFICADO': 0,
                                'RESINADO': 0,
                                'MOVELEIRO': 0
                            };
                            let totalDia = 0;
                            for (const reg of regsDia) {
                                const produto = produtoById[reg.ProdutoID];
                                const volume = produto ? (produto.Cubagem_m3 * reg.Quantidade_Chapas) : 0;
                                const famNome = getFamiliaNome(reg.ProdutoID).replace('√á√ÉO', 'CAO');
                                if (totaisDia[famNome] !== undefined) {
                                    totaisDia[famNome] += volume;
                                }
                                totalDia += volume;
                            }
                            return {
                                data,
                                ...totaisDia,
                                totalDia
                            };
                        });
                        const tbody = App.utils.$('#tbodySemanal');
                        if (tbody) {
                            tbody.innerHTML = linhasSemana.map(linha => `
                                <tr>
                                    <td>${new Date(linha.data + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                                    <td>${fmt(linha.EXPORTACAO)}</td>
                                    <td>${fmt(linha.PLASTIFICADO)}</td>
                                    <td>${fmt(linha.RESINADO)}</td>
                                    <td>${fmt(linha.MOVELEIRO)}</td>
                                    <td><strong>${fmt(linha.totalDia)}</strong></td>
                                </tr>
                            `).join('');
                        }
                        const totaisSemana = linhasSemana.reduce((acc, linha) => {
                            acc.EXPORTACAO += linha.EXPORTACAO;
                            acc.PLASTIFICADO += linha.PLASTIFICADO;
                            acc.RESINADO += linha.RESINADO;
                            acc.MOVELEIRO += linha.MOVELEIRO;
                            acc.GERAL += linha.totalDia;
                            return acc;
                        }, {
                            EXPORTACAO: 0,
                            PLASTIFICADO: 0,
                            RESINADO: 0,
                            MOVELEIRO: 0,
                            GERAL: 0
                        });
                        const diasComProducaoGeral = linhasSemana.filter(l => l.totalDia > 0).length;
                        App.utils.setText('#mediaSemanalGeral', diasComProducaoGeral > 0 ? fmt(totaisSemana.GERAL / diasComProducaoGeral) : '‚Äî');
                        const diasComProducaoExportacao = linhasSemana.filter(l => l.EXPORTACAO > 0).length;
                        App.utils.setText('#mediaSemanalExportacao', diasComProducaoExportacao > 0 ? fmt(totaisSemana.EXPORTACAO / diasComProducaoExportacao) : '‚Äî');
                        const diasComProducaoPlastificado = linhasSemana.filter(l => l.PLASTIFICADO > 0).length;
                        App.utils.setText('#mediaSemanalPlastificado', diasComProducaoPlastificado > 0 ? fmt(totaisSemana.PLASTIFICADO / diasComProducaoPlastificado) : '‚Äî');
                        const diasComProducaoResinado = linhasSemana.filter(l => l.RESINADO > 0).length;
                        App.utils.setText('#mediaSemanalResinado', diasComProducaoResinado > 0 ? fmt(totaisSemana.RESINADO / diasComProducaoResinado) : '‚Äî');
                        const diasComProducaoMoveleiro = linhasSemana.filter(l => l.MOVELEIRO > 0).length;
                        App.utils.setText('#mediaSemanalMoveleiro', diasComProducaoMoveleiro > 0 ? fmt(totaisSemana.MOVELEIRO / diasComProducaoMoveleiro) : '‚Äî');
                        App.utils.setText('#totalSemanalExportacao', fmt(totaisSemana.EXPORTACAO));
                        App.utils.setText('#totalSemanalPlastificado', fmt(totaisSemana.PLASTIFICADO));
                        App.utils.setText('#totalSemanalResinado', fmt(totaisSemana.RESINADO));
                        App.utils.setText('#totalSemanalMoveleiro', fmt(totaisSemana.MOVELEIRO));
                        App.utils.setText('#totalSemanalGeral', fmt(totaisSemana.GERAL));
                        const anoMes = selDate.slice(0, 7);
                        const regsMes = producao.filter(r => (r.Data || '').startsWith(anoMes));
                        const totaisMensais = {
                            EXPORTACAO: 0,
                            PLASTIFICADO: 0,
                            RESINADO: 0,
                            MOVELEIRO: 0,
                            GERAL: 0
                        };
                        const diasValidos = {
                            EXPORTACAO: new Set(),
                            PLASTIFICADO: new Set(),
                            RESINADO: new Set(),
                            MOVELEIRO: new Set(),
                            GERAL: new Set()
                        };
                        for (const reg of regsMes) {
                            const produto = produtoById[reg.ProdutoID];
                            const volume = produto ? (produto.Cubagem_m3 * reg.Quantidade_Chapas) : 0;
                            const famNome = getFamiliaNome(reg.ProdutoID).replace('√á√ÉO', 'CAO');
                            if (volume > 0) { // Considera apenas lan√ßamentos v√°lidos
                                if (totaisMensais[famNome] !== undefined) {
                                    totaisMensais[famNome] += volume;
                                    diasValidos[famNome].add(reg.Data);
                                }
                                totaisMensais.GERAL += volume;
                                diasValidos.GERAL.add(reg.Data);
                            }
                        }
                        const divisorExportacao = diasValidos.EXPORTACAO.size > 0 ? diasValidos.EXPORTACAO.size : 1;
                        App.utils.setText('#mediaMensalExportacao', fmt(totaisMensais.EXPORTACAO / divisorExportacao));
                        const divisorPlastificado = diasValidos.PLASTIFICADO.size > 0 ? diasValidos.PLASTIFICADO.size : 1;
                        App.utils.setText('#mediaMensalPlastificado', fmt(totaisMensais.PLASTIFICADO / divisorPlastificado));
                        const divisorResinado = diasValidos.RESINADO.size > 0 ? diasValidos.RESINADO.size : 1;
                        App.utils.setText('#mediaMensalResinado', fmt(totaisMensais.RESINADO / divisorResinado));
                        const divisorMoveleiro = diasValidos.MOVELEIRO.size > 0 ? diasValidos.MOVELEIRO.size : 1;
                        App.utils.setText('#mediaMensalMoveleiro', fmt(totaisMensais.MOVELEIRO / divisorMoveleiro));
                        const divisorGeral = diasValidos.GERAL.size > 0 ? diasValidos.GERAL.size : 1;
                        App.utils.setText('#mediaMensalGeral', fmt(totaisMensais.GERAL / divisorGeral));
                        App.utils.setText('#totalMensalExportacao', fmt(totaisMensais.EXPORTACAO));
                        App.utils.setText('#totalMensalPlastificado', fmt(totaisMensais.PLASTIFICADO));
                        App.utils.setText('#totalMensalResinado', fmt(totaisMensais.RESINADO));
                        App.utils.setText('#totalMensalMoveleiro', fmt(totaisMensais.MOVELEIRO));
                        App.utils.setText('#totalMensalGeral', fmt(totaisMensais.GERAL));
                        const calcPerc = (valor, total) => (total > 0 ? `${((valor / total) * 100).toFixed(1)}%`.replace('.', ',') : '0,0%');
                        App.utils.setText('#percentMensalExportacao', calcPerc(totaisMensais.EXPORTACAO, totaisMensais.GERAL));
                        App.utils.setText('#percentMensalPlastificado', calcPerc(totaisMensais.PLASTIFICADO, totaisMensais.GERAL));
                        App.utils.setText('#percentMensalResinado', calcPerc(totaisMensais.RESINADO, totaisMensais.GERAL));
                        App.utils.setText('#percentMensalMoveleiro', calcPerc(totaisMensais.MOVELEIRO, totaisMensais.GERAL));
                    }
                },
                updateCharts(producaoParaGraficos) {
                    console.log("Atualizando gr√°ficos com dados de produ√ß√£o...");
                    if (window.Chart) {
                        const ctxTurno = document.getElementById('chartProducaoTurno');
                        if (ctxTurno) {
                            if (App.state.charts.producaoTurno) {
                                App.state.charts.producaoTurno.destroy();
                            }
                            const turnoData = {};
                            producaoParaGraficos.forEach(p => {
                                const turno = App.state.cache.turnos.find(t => t.TurnoID === p.TurnoID);
                                const turnoNome = turno ? turno.TurnoNome : 'Desconhecido';
                                const produto = App.state.cache.produtos.find(prod => prod.ProdutoID === p.ProdutoID);
                                const volume = produto ? (produto.Cubagem_m3 || 0) * (p.Quantidade_Chapas || 0) : 0;
                                if (!turnoData[turnoNome]) turnoData[turnoNome] = 0;
                                turnoData[turnoNome] += volume;
                            });
                            const labels = Object.keys(turnoData);
                            const data = Object.values(turnoData);
                            App.state.charts.producaoTurno = new Chart(ctxTurno, {
                                type: 'bar',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: 'Produ√ß√£o (m¬≥)',
                                        data: data,
                                        backgroundColor: 'rgba(37, 99, 235, 0.7)',
                                        borderColor: 'rgba(37, 99, 235, 1)',
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            title: {
                                                display: true,
                                                text: 'Volume (m¬≥)'
                                            }
                                        }
                                    }
                                }
                            });
                        }
                        const ctxEvolucao = document.getElementById('chartEvolucaoProducao');
                        if (ctxEvolucao) {
                            if (App.state.charts.evolucaoProducao) {
                                App.state.charts.evolucaoProducao.destroy();
                            }
                            const hoje = new Date();
                            const ultimosDias = [];
                            const dadosPorDia = {};
                            for (let i = 29; i >= 0; i--) {
                                const d = new Date(hoje);
                                d.setDate(hoje.getDate() - i);
                                const dataStr = d.toISOString().split('T')[0];
                                ultimosDias.push(dataStr);
                                dadosPorDia[dataStr] = 0;
                            }
                            producaoParaGraficos.forEach(p => {
                                if (p.Data && dadosPorDia[p.Data] !== undefined) {
                                    const produto = App.state.cache.produtos.find(prod => prod.ProdutoID === p.ProdutoID);
                                    const volume = produto ? (produto.Cubagem_m3 || 0) * (p.Quantidade_Chapas || 0) : 0;
                                    dadosPorDia[p.Data] += volume;
                                }
                            });
                            const dadosEvolucao = ultimosDias.map(d => dadosPorDia[d] || 0);
                            const labelsFormatados = ultimosDias.map(d => {
                                const date = new Date(d + 'T12:00:00');
                                return date.toLocaleDateString('pt-BR');
                            });
                            App.state.charts.evolucaoProducao = new Chart(ctxEvolucao, {
                                type: 'line',
                                data: {
                                    labels: labelsFormatados,
                                    datasets: [{
                                        label: 'Produ√ß√£o Di√°ria (m¬≥)',
                                        data: dadosEvolucao,
                                        fill: false,
                                        borderColor: 'rgba(22, 163, 74, 1)',
                                        backgroundColor: 'rgba(22, 163, 74, 0.2)',
                                        tension: 0.1,
                                        pointRadius: 4,
                                        pointHoverRadius: 6
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        x: {
                                            ticks: {
                                                maxRotation: 45,
                                                minRotation: 45
                                            }
                                        },
                                        y: {
                                            beginAtZero: true,
                                            title: {
                                                display: true,
                                                text: 'Volume (m¬≥)'
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    }
                },
                async conectarBanco() {
                    const host = App.utils.getValue('#dbHost') || 'localhost';
                    const port = App.utils.getValue('#dbPort') || '3001';
                    App.state.API_BASE_URL = `http://${host}:${port}`;
                    App.ui.updateConnectionStatus('connecting');
                    try {
                        const data = await App.utils.apiCall('/test-connection');
                        App.ui.updateConnectionStatus('connected');
                        App.ui.showNotification(`Conectado com sucesso: ${data.message || 'Conex√£o estabelecida'}`);
                        await this.loadAllData();
                    } catch (error) {
                        App.ui.updateConnectionStatus('disconnected');
                    }
                },
                initConsulta() {
                    const tipoConsulta = App.utils.$('#tipoConsulta');
                    if (tipoConsulta) {
                        tipoConsulta.addEventListener('change', this.toggleFiltrosConsulta);
                    }
                    this.populateFiltrosConsulta();
                },
                toggleFiltrosConsulta() {
                    const tipo = App.utils.getValue('#tipoConsulta');
                    const filtrosProducao = App.utils.$('#filtrosProducao');
                    const filtrosDescarte = App.utils.$('#filtrosDescarte');
                    if (tipo === 'producao') {
                        if (filtrosProducao) filtrosProducao.style.display = 'grid';
                        if (filtrosDescarte) filtrosDescarte.style.display = 'none';
                    } else {
                        if (filtrosProducao) filtrosProducao.style.display = 'none';
                        if (filtrosDescarte) filtrosDescarte.style.display = 'grid';
                    }
                },
                populateFiltrosConsulta() {
                    const {
                        familias = []
                    } = App.state.cache;
                    App.ui.populateSelect('filtroFamilia', familias, 'FamiliaID', 'FamiliaNome');
                },
                async aplicarFiltros() {
                    const tipo = App.utils.getValue('#tipoConsulta');
                    const dataInicio = App.utils.getValue('#filtroDataInicio');
                    const dataFim = App.utils.getValue('#filtroDataFim');
                    const turnosSelecionados = [...App.utils.$('#filtroTurno').options]
                        .filter(option => option.selected)
                        .map(option => option.value);
                    let dados = [];
                    if (tipo === 'producao') {
                        dados = [...App.state.cache.producao];
                        const produto = App.utils.getValue('#filtroProduto');
                        const mesa = App.utils.getValue('#filtroMesa');
                        const familia = App.utils.getValue('#filtroFamilia');
                        if (produto) dados = dados.filter(d => d.ProdutoID === parseInt(produto));
                        if (mesa) {
                            dados = dados.filter(d => {
                                const turnoObj = App.state.cache.turnos.find(t => t.TurnoID === d.TurnoID);
                                return (turnoObj?.TurnoNome?.toUpperCase() || '').includes(mesa);
                            });
                        }
                        if (familia) {
                            dados = dados.filter(d => {
                                const produto = App.state.cache.produtos.find(p => p.ProdutoID === d.ProdutoID);
                                return produto && produto.FamiliaID === parseInt(familia);
                            });
                        }
                    } else {
                        dados = [...App.state.cache.descarte];
                        const tipoDescarte = App.utils.getValue('#filtroTipoDescarte');
                        if (tipoDescarte) dados = dados.filter(d => d.Tipo_Descarte === tipoDescarte);
                    }
                    if (dataInicio) dados = dados.filter(d => d.Data >= dataInicio);
                    if (dataFim) dados = dados.filter(d => d.Data <= dataFim);
                    if (turnosSelecionados.length > 0) {
                        dados = dados.filter(d => {
                            const turnoObj = App.state.cache.turnos.find(t => t.TurnoID === d.TurnoID);
                            return turnoObj && turnosSelecionados.includes(turnoObj.TurnoNome);
                        });
                    }
                    const incluirSecador = App.utils.$('#incluirSecador').checked;
                    if (incluirSecador && tipo === 'producao') {
                        try {
                            const queryParams = new URLSearchParams();
                            if (dataInicio) queryParams.append('dataInicio', dataInicio);
                            if (dataFim) queryParams.append('dataFim', dataFim);
                            const secadorDados = await App.utils.apiCall(`/api/secador/producao?${queryParams.toString()}`);
                            const dadosSecadorFormatados = secadorDados.map(d => ({
                                ProducaoID: d.id,
                                Data: d.Data,
                                TurnoID: d.TurnoID,
                                ProdutoID: -1,
                                Quantidade_Chapas: 1,
                                Cubagem_m3: d.Cubagem_m3,
                                Observacoes: `Secador - ${d.Especie} - ${d.Observacoes || ''}`,
                                createdAt: d.UpdatedAt || d.CreatedAt,
                                isSecador: true,
                                CodigoSecador: d.Codigo,
                                DescricaoSecador: d.Descricao,
                                EspecieSecador: d.Especie
                            }));
                            let dadosSecadorFiltrados = dadosSecadorFormatados;
                            if (turnosSelecionados.length > 0) {
                                dadosSecadorFiltrados = dadosSecadorFormatados.filter(d => {
                                    const turnoObj = App.state.cache.turnos.find(t => t.TurnoID === d.TurnoID);
                                    return turnoObj && turnosSelecionados.includes(turnoObj.TurnoNome);
                                });
                            }
                            dados = [...dados, ...dadosSecadorFiltrados];
                        } catch (error) {
                            console.error('Erro ao buscar dados do Secador:', error);
                            App.ui.showNotification('Erro ao buscar dados do Secador: ' + error.message, 'warning');
                        }
                    }
                    this.exibirResultadosConsulta(dados, tipo);
                },
                exibirResultadosConsulta(dados, tipo) {
                    const container = App.utils.$('#resultadosConsulta');
                    if (!container) return;
                    if (dados.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #666;">Nenhum resultado encontrado.</p>';
                        return;
                    }
                    const totalQuantidade = dados.reduce((total, r) => total + (r.Quantidade_Chapas || 0), 0);
                    let totalVolume = 0;
                    totalVolume = dados.reduce((total, r) => {
                        if (r.isSecador) {
                            return total + (r.Cubagem_m3 || 0);
                        } else {
                            const produto = App.state.cache.produtos.find(p => p.ProdutoID === r.ProdutoID);
                            return total + ((produto?.Cubagem_m3 || 0) * (r.Quantidade_Chapas || 0));
                        }
                    }, 0);
                    let html = `
                        <div class="alert alert-success">
                            <strong>üìä Resultados:</strong> ${dados.length} registros encontrados.
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Data</th><th>Turno</th><th>Produto</th>
                                        <th>Quantidade (Chapas)</th><th>Volume (m¬≥)</th>
                                        ${tipo === 'descarte' ? '<th>Tipo Descarte</th><th>Obs</th>' : '<th>Obs</th>'}
                                    </tr>
                                </thead>
                                <tbody>`;
                    dados.forEach(registro => {
                        if (registro.isSecador) {
                            const turno = App.state.cache.turnos.find(t => t.TurnoID === registro.TurnoID);
                            const dataFormatada = new Date(registro.Data + 'T00:00:00').toLocaleDateString('pt-BR');
                            html += `
                                <tr style="background-color: #e6f7ff;">
                                    <td>${dataFormatada}</td>
                                    <td><span style="background: var(--info-color); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">${turno?.TurnoNome || 'N/A'}</span></td>
                                    <td>${registro.CodigoSecador} - ${registro.DescricaoSecador || 'Secador'}</td>
                                    <td>1</td>
                                    <td><strong>${(registro.Cubagem_m3 || 0).toFixed(6)}</strong></td>
                                    <td><span style="background: var(--success-color); color: white; padding: 0.25rem 0.5rem; border-radius: 4px;">Secador - ${registro.EspecieSecador}</span></td>
                                </tr>`;
                        } else {
                            const produto = App.state.cache.produtos.find(p => p.ProdutoID === registro.ProdutoID);
                            const turno = App.state.cache.turnos.find(t => t.TurnoID === registro.TurnoID);
                            const volume = (produto?.Cubagem_m3 || 0) * (registro.Quantidade_Chapas || 0);
                            const dataFormatada = new Date(registro.Data + 'T00:00:00').toLocaleDateString('pt-BR');
                            html += `
                                <tr>
                                    <td>${dataFormatada}</td>
                                    <td><span style="background: var(--info-color); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">${turno?.TurnoNome || 'N/A'}</span></td>
                                    <td>${produto ? `${produto.Codigo} - ${produto.Descricao}` : 'N/A'}</td>
                                    <td>${(registro.Quantidade_Chapas || 0).toFixed(0)}</td>
                                    <td><strong>${volume.toFixed(6)}</strong></td>
                                    ${tipo === 'descarte' ?
                                    `<td><span style="background: var(--danger-color); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">${registro.Tipo_Descarte || 'N/A'}</span></td><td>${registro.Obs || '-'}</td>` :
                                    `<td>${registro.Observacoes || '-'}</td>`}
                                </tr>`;
                        }
                    });
                    html += `
                                </tbody>
                                <tfoot style="font-weight: bold; background-color: #f0f2f5; border-top: 2px solid var(--primary-color);">
                                    <tr>
                                        <td colspan="3">TOTAIS</td>
                                        <td>${totalQuantidade.toFixed(0)}</td>
                                        <td>${totalVolume.toFixed(6)}</td>
                                        ${tipo === 'descarte' ? '<td colspan="2"></td>' : '<td></td>'}
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-success" onclick="exportarResultadosConsulta('${tipo}')">üì§ Exportar Resultados</button>
                        </div>`;
                    container.innerHTML = html;
                },
                limparFiltros() {
                    const campos = ['filtroDataInicio', 'filtroDataFim', 'filtroProduto', 'filtroMesa', 'filtroFamilia', 'filtroTipoDescarte'];
                    campos.forEach(id => {
                        const el = App.utils.$(`#${id}`);
                        if (el) el.value = '';
                    });
                    const filtroTurnoEl = App.utils.$('#filtroTurno');
                    if (filtroTurnoEl) {
                        [...filtroTurnoEl.options].forEach(option => option.selected = false);
                    }
                    App.utils.$('#tipoConsulta').value = 'producao';
                    App.utils.$('#incluirSecador').checked = false;
                    this.toggleFiltrosConsulta();
                    App.utils.$('#resultadosConsulta').innerHTML = '<p style="text-align: center; color: #666;">Aplique os filtros para ver os resultados.</p>';
                },
                exportarResultadosConsulta(tipo) {
                    App.ui.showNotification(`Exporta√ß√£o de resultados da consulta (${tipo}) em desenvolvimento`, 'info');
                },
                async salvarProduto() {
                    try {
                        const codigo = App.utils.getValue('#modalCodigo').trim();
                        const descricao = App.utils.getValue('#modalDescricao').trim();

                        if (!codigo || !descricao) {
                            App.ui.showNotification('C√≥digo e Descri√ß√£o s√£o obrigat√≥rios', 'error');
                            return;
                        }

                        const comprimento = parseFloat(App.utils.getValue('#modalComprimento')) || 0;
                        const largura = parseFloat(App.utils.getValue('#modalLargura')) || 0;
                        const bitola = parseFloat(App.utils.getValue('#modalBitola')) || 0;
                        const familiaID = parseInt(App.utils.getValue('#modalFamiliaID')) || 1;

                        const payload = {
                            Codigo: codigo,
                            Descricao: descricao,
                            Comprimento_m: comprimento,
                            Largura_m: largura,
                            Bitola_m: bitola,
                            Cubagem_m3: comprimento * largura * bitola,
                            FamiliaID: familiaID,
                            Ativo: 'SIM'
                        };

                        const endpoint = App.state.editingProduct ? `/produtos/${App.state.editingProduct}` : '/produtos';
                        const method = App.state.editingProduct ? 'PUT' : 'POST';

                        App.ui.showLoading(true);
                        const result = await App.utils.apiCall(endpoint, {
                            method: method,
                            body: JSON.stringify(payload)
                        });

                        App.ui.showNotification(result.message || 'Produto salvo com sucesso!', 'success');
                        App.ui.toggleModal('modalProduto', false); // CORRIGIDO: false para fechar o modal

                        // Recarrega a lista de produtos
                        await this.loadProdutos();

                        App.state.editingProduct = null;

                    } catch (error) {
                        console.error('Erro ao salvar produto:', error);
                        App.ui.showNotification('Erro ao salvar produto: ' + error.message, 'error');
                    } finally {
                        App.ui.showLoading(false);
                    }
                },

                async salvarTurno() {
                    const nomeTurno = App.utils.getValue('#modalNomeTurno').trim();
                    if (!nomeTurno) return App.ui.showNotification("O nome do turno √© obrigat√≥rio.", 'warning');
                    App.ui.showNotification("Cria√ß√£o de turnos n√£o implementada no servidor", 'warning');
                    App.ui.toggleModal('modalTurno', false);
                },
               async registrarProducao() {
                    App.ui.showLoading(true); // Mostra o indicador de "carregando"
                    try {
                        // Mant√©m toda a sua l√≥gica para pegar os dados do formul√°rio
                        const codigo = App.utils.getValue('#codigoInput') || App.utils.getValue('#produtoCodigo');
                        const produto = App.state.cache.produtos.find(p => p.Codigo == codigo);

                        // Mant√©m todas as suas valida√ß√µes
                        if (!produto) {
                            throw new Error('Produto n√£o encontrado!');
                        }
                        if (!produto.Cubagem_m3 || produto.Cubagem_m3 <= 0) {
                            throw new Error('Produto sem dimens√µes. N√£o √© poss√≠vel calcular m¬≥.');
                        }
                        const observacaoParaCopiar = App.utils.getValue('#obsProducao').trim();
                        if (!observacaoParaCopiar) {
                            throw new Error('O campo Observa√ß√£o √© obrigat√≥rio para este lan√ßamento.');
                        }
                        const setorGeral = App.state.cache.setores.find(s => s.SetorNome.toUpperCase() === 'PRODU√á√ÉO GERAL');

                        // Prepara o pacote de dados para o Supabase
                        const lancamento = {
                            Data: App.utils.getValue('#dataProducao'),
                            TurnoID: parseInt(App.utils.getValue('#turnoDetalhado'), 10),
                            SetorID: setorGeral ? setorGeral.SetorID : 1, // Usa a sua l√≥gica para encontrar o setor
                            ProdutoID: produto.ProdutoID,
                            Quantidade_Chapas: parseInt(App.utils.getValue('#quantidade'), 10),
                            Observacoes: observacaoParaCopiar
                        };

                        if (!lancamento.ProdutoID || !lancamento.Quantidade_Chapas || !lancamento.TurnoID || !lancamento.Data || lancamento.Quantidade_Chapas <= 0) {
                            throw new Error('Por favor, preencha todos os campos obrigat√≥rios corretamente.');
                        }

                        // Comando que envia os dados para o Supabase
                        const { data, error } = await supabaseClient
                            .from('Producao') // Nome da tabela no Supabase
                            .insert([lancamento]); // Enviando o pacote de dados

                        if (error) {
                            // Se o Supabase der um erro, ele ser√° mostrado na tela
                            throw new Error(`Erro do Supabase: ${error.message}`);
                        }

                        App.ui.showNotification("Lan√ßamento registrado com SUCESSO na nuvem!", 'success');

                        // Mant√©m a sua l√≥gica de copiar a observa√ß√£o para a √°rea de transfer√™ncia
                        if (observacaoParaCopiar && navigator.clipboard) {
                            try {
                                await navigator.clipboard.writeText(observacaoParaCopiar);
                                App.ui.showNotification('Observa√ß√£o copiada!');
                            } catch (err) {
                                console.error('Falha ao copiar a observa√ß√£o: ', err);
                            }
                        }

                        // Mant√©m a sua l√≥gica de limpar o formul√°rio e atualizar a tela
                        this.resetFormProducaoParcial();
                        App.utils.$('#obsProducao').value = '';
                        this.renderProducaoDoDia();
                        this.loadDashboard();

                    } catch (error) {
                        // Se qualquer um dos "throw new Error" acontecer, ele ser√° mostrado aqui
                        console.error('Erro ao registrar produ√ß√£o:', error);
                        App.ui.showNotification(error.message, 'error');
                    } finally {
                        // Garante que o "carregando" sempre vai sumir, mesmo se der erro
                        App.ui.showLoading(false);
                    }
                },
                // Fim da fun√ß√£o produ√ß√£o Registrar produ√ß√£o na aba Produ√ß√£o 
                resetFormProducaoParcial() {
                    App.utils.$('#codigoInput').value = '';
                    App.utils.$('#quantidade').value = '';
                    App.utils.$('#produtoCodigo').value = '';
                    App.utils.$('#descricaoProdutoPreview').textContent = '';
                    App.utils.$('#codigoInput').focus();
                },
                descarte: {
                    state: {
                        selectedProdutoId: null,
                        editingRowId: null,
                        originalRowHTML: null,
                    },
                    init() {
                        App.utils.$('#dataDescarte').value = App.utils.getYesterdayDateString();
                        App.utils.$('#dataTabelaDescartes').value = App.state.dataTabelaDescartes;
                        // LINHA ADICIONADA: Popula o dropdown de turnos do descarte.
                        App.ui.populateSelect('turnoDescarte', App.state.cache.turnos, 'TurnoID', 'TurnoNome');
                        this.loadDescartesDoDia();
                    },
                    setDataTabela() {
                        const novaData = App.utils.getValue('#dataTabelaDescartes');
                        App.state.dataTabelaDescartes = novaData;
                        localStorage.setItem('descarte.dataTabela', novaData);
                        this.loadDescartesDoDia(novaData);
                    },
                    async loadDescartesDoDia(dataParaCarregar) {
                        try {
                            const data = dataParaCarregar || App.state.dataTabelaDescartes;
                            if (!data) {
                                console.warn("loadDescartesDoDia chamado sem uma data definida.");
                                App.state.cache.descartesDoDia = [];
                                this.renderDescartesDoDia();
                                return;
                            }
                            App.state.dataTabelaDescartes = data;
                            const descartes = await App.utils.apiCall(`/descarte?data=${data}`);
                            const normalizedDescartes = (descartes || []).map(d => ({
                                DescarteID: d.DescarteID || d.descarte_id,
                                ProdutoID: d.ProdutoID || d.produto_id,
                                TurnoID: d.TurnoID || d.turno_id,
                                Tipo_Descarte: d.Tipo_Descarte || d.tipo_descarte,
                                Quantidade_Chapas: d.Quantidade_Chapas || d.quantidade_chapas,
                                Obs: d.Obs || d.obs,
                                Data: d.Data || d.data,
                                createdAt: d.createdAt || d.created_at
                            }));
                            App.state.cache.descartesDoDia = normalizedDescartes.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0) || b.DescarteID - a.DescarteID);
                            App.state.descarteCurrentPage = 1;
                            this.renderDescartesDoDia();
                        } catch (error) {
                            console.error("Erro ao carregar descartes do dia:", error);
                            App.state.cache.descartesDoDia = [];
                            this.renderDescartesDoDia();
                        }
                    },
                    renderDescartesDoDia() {
                        const tbody = App.utils.$('#descartesDiaTbody');
                        const paginationContainer = App.utils.$('#paginationDescartes');
                        if (!tbody || !paginationContainer) return;
                        const data = App.state.cache.descartesDoDia;
                        const page = App.state.descarteCurrentPage;
                        const rowsPerPage = App.state.descarteRowsPerPage;
                        if (!data || data.length === 0) {
                            tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;">Nenhum descarte para esta data.</td></tr>`;
                            paginationContainer.innerHTML = '';
                            return;
                        }
                        const startIndex = (page - 1) * rowsPerPage;
                        const endIndex = startIndex + rowsPerPage;
                        const paginatedData = data.slice(startIndex, endIndex);
                        tbody.innerHTML = paginatedData.map(d => this.renderRow(d)).join('');
                        this.renderPagination(data.length);
                    },
                    renderRow(d, isEditing = false) {
                        const produto = App.state.cache.produtos.find(p => p.ProdutoID === d.ProdutoID);
                        const turno = App.state.cache.turnos.find(t => t.TurnoID === d.TurnoID);
                        if (isEditing) {
                            return `
                                    <tr id="descarte-row-${d.DescarteID}" class="is-editing" data-descarte-id="${d.DescarteID}">
                                        <td>${d.DescarteID}</td>
                                        <td>${produto?.Codigo || 'N/A'}</td>
                                        <td>${produto?.Descricao || 'N/A'}</td>
                                        <td><input type="text" class="form-group" value="${d.Tipo_Descarte}" data-field="Tipo_Descarte" list="tiposDescarteDataList"></td>
                                        <td><input type="number" class="form-group" value="${d.Quantidade_Chapas}" data-field="Quantidade_Chapas" min="1"></td>
                                        <td>
                                            <select class="form-group" data-field="TurnoID">
                                                ${App.state.cache.turnos.map(t => `<option value="${t.TurnoID}" ${t.TurnoID == d.TurnoID ? 'selected' : ''}>${t.TurnoNome}</option>`).join('')}
                                            </select>
                                        </td>
                                        <td><input type="text" class="form-group" value="${d.Obs || ''}" data-field="Obs"></td>
                                        <td>${App.utils.formatLaunchDate(d.createdAt, d.Data)}</td>
                                        <td>
                                            <button class="btn btn-sm btn-success" data-action="save" aria-label="Salvar altera√ß√£o">Salvar</button>
                                            <button class="btn btn-sm btn-secondary" data-action="cancel" aria-label="Cancelar altera√ß√£o">Cancelar</button>
                                        </td>
                                    </tr>`;
                        }
                        return `
                                <tr id="descarte-row-${d.DescarteID}" data-descarte-id="${d.DescarteID}">
                                    <td>${d.DescarteID}</td>
                                    <td>${produto?.Codigo || 'N/A'}</td>
                                    <td>${produto?.Descricao || 'N/A'}</td>
                                    <td>${d.Tipo_Descarte}</td>
                                    <td>${d.Quantidade_Chapas}</td>
                                    <td>${turno?.TurnoNome || 'N/A'}</td>
                                    <td>${d.Obs || ''}</td>
                                    <td>${App.utils.formatLaunchDate(d.createdAt, d.Data)}</td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" data-action="edit" aria-label="Editar linha ${d.DescarteID}">Editar</button>
                                        <button class="btn btn-sm btn-danger" data-action="delete" aria-label="Excluir linha ${d.DescarteID}">Excluir</button>
                                    </td>
                                </tr>`;
                    },
                    renderPagination(totalRows) {
                        const paginationContainer = App.utils.$('#paginationDescartes');
                        paginationContainer.innerHTML = '';
                        const pageCount = Math.ceil(totalRows / App.state.descarteRowsPerPage);
                        if (pageCount <= 1) return;
                        for (let i = 1; i <= pageCount; i++) {
                            const btn = document.createElement('button');
                            btn.className = `btn btn-sm ${i === App.state.descarteCurrentPage ? 'btn-primary' : 'btn-secondary'}`;
                            btn.textContent = i;
                            btn.onclick = () => {
                                App.state.descarteCurrentPage = i;
                                this.renderDescartesDoDia();
                            };
                            paginationContainer.appendChild(btn);
                        }
                    },
                    async registrar() {
                        const produtoId = this.state.selectedProdutoId;
                        if (!produtoId) {
                            return App.ui.showNotification("Selecione um produto v√°lido.", "warning");
                        }
                        const payload = {
                            Data: App.utils.getValue('#dataDescarte'),
                            TurnoID: parseInt(App.utils.getValue('#turnoDescarte'), 10),
                            SetorID: 1,
                            ProdutoID: produtoId,
                            Tipo_Descarte: App.utils.getValue('#tipoDescarte').trim(),
                            Quantidade_Chapas: parseInt(App.utils.getValue('#quantidadeDescarte'), 10),
                            Obs: App.utils.getValue('#descarteObs').trim()
                        };
                        if (!payload.ProdutoID || !payload.TurnoID || !payload.Data || !payload.Tipo_Descarte || !(payload.Quantidade_Chapas > 0)) {
                            return App.ui.showNotification('Por favor, preencha todos os campos obrigat√≥rios corretamente.', 'error');
                        }
                        try {
                            const novoDescarte = await App.utils.apiCall('/descarte', {
                                method: 'POST',
                                body: JSON.stringify(payload)
                            });
                            App.ui.showNotification('Descarte registrado com sucesso!', 'success');
                            this.resetForm();
                            novoDescarte.createdAt = novoDescarte.createdAt || new Date().toISOString();
                            App.state.cache.descarte.push(novoDescarte);
                            App.logic.loadDashboard();
                            if (payload.Data === App.state.dataTabelaDescartes) {
                                App.state.cache.descartesDoDia.unshift(novoDescarte);
                                this.renderDescartesDoDia();
                            }
                        } catch (e) {
                            console.error("Erro ao registrar descarte:", e);
                        }
                    },

                    resetForm() {
                        // Esse ncodigo garante que o  campo do c√≥digo e seu estado N√ÉO ser√£o limpos, para permitir m√∫ltiplos lan√ßamentos

                        App.utils.$('#tipoDescarte').value = '';
                        App.utils.$('#quantidadeDescarte').value = '';
                        App.utils.$('#descarteObs').value = '';

                        // O foco vai para o pr√≥ximo campo l√≥gico: "Tipo de Descarte",
                        // j√° que o produto foi mantido.
                        App.utils.$('#tipoDescarte').focus();
                    },
                    handleCodigoChange(e) {
                        const input = e.target.value.trim();
                        const display = App.utils.$('#produtoSelecionadoDescarte');
                        const produto = App.state.cache.produtos.find(p => p.Codigo === input || p.Descricao === input);
                        if (produto) {
                            this.state.selectedProdutoId = produto.ProdutoID;
                            const dimensoes = produto.Comprimento_m ? `(${produto.Comprimento_m}x${produto.Largura_m}x${produto.Bitola_m})` : '';
                            const cubagem = produto.Cubagem_m3 ? `${produto.Cubagem_m3.toFixed(6)} m¬≥/chapa` : '';
                            display.innerHTML = `<strong>${produto.Codigo}</strong> - ${produto.Descricao} <br> <small>${dimensoes} ${cubagem}</small>`;
                            display.style.color = 'var(--secondary-color)';
                        } else {
                            this.state.selectedProdutoId = null;
                            display.textContent = input ? 'C√≥digo n√£o encontrado.' : 'Nenhum produto selecionado.';
                            display.style.color = input ? 'var(--danger-color)' : 'var(--dark-color)';
                        }
                    },
                    handleRowDblClick(e) {
                        const row = e.target.closest('tr');
                        if (row && row.dataset.descarteId && !row.classList.contains('is-editing')) {
                            this.startEditing(row.dataset.descarteId);
                        }
                    },
                    handleTableClick(e) {
                        const action = e.target.dataset.action;
                        if (!action) return;
                        const row = e.target.closest('tr');
                        const id = row.dataset.descarteId;
                        if (action === 'edit') this.startEditing(id);
                        if (action === 'delete') this.deleteDescarte(id);
                        if (action === 'save') this.saveEditing(id);
                        if (action === 'cancel') this.cancelEditing(id);
                    },
                    handleTableKeyDown(e) {
                        const row = e.target.closest('tr.is-editing');
                        if (!row) return;
                        const id = row.dataset.descarteId;
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.saveEditing(id);
                        }
                        if (e.key === 'Escape') {
                            e.preventDefault();
                            this.cancelEditing(id);
                        }
                    },
                    startEditing(id) {
                        if (this.state.editingRowId) {
                            this.cancelEditing(this.state.editingRowId);
                        }
                        const rowData = App.state.cache.descartesDoDia.find(d => d.DescarteID == id);
                        const rowElement = App.utils.$(`#descarte-row-${id}`);
                        if (rowData && rowElement) {
                            this.state.editingRowId = id;
                            this.state.originalRowHTML = rowElement.innerHTML;
                            const editHTML = this.renderRow(rowData, true);
                            rowElement.innerHTML = editHTML.substring(editHTML.indexOf('>') + 1, editHTML.lastIndexOf('<')).trim();
                            rowElement.classList.add('is-editing');
                            rowElement.querySelector('input, select')?.focus();
                        }
                    },
                    cancelEditing(id) {
                        const rowElement = App.utils.$(`#descarte-row-${id}`);
                        if (rowElement && this.state.originalRowHTML) {
                            rowElement.innerHTML = this.state.originalRowHTML;
                            rowElement.classList.remove('is-editing');
                        }
                        this.state.editingRowId = null;
                        this.state.originalRowHTML = null;
                    },
                    async saveEditing(id) {
                        const row = App.utils.$(`#descarte-row-${id}`);
                        if (!row) return;
                        const payload = {
                            Tipo_Descarte: row.querySelector('[data-field="Tipo_Descarte"]').value,
                            Quantidade_Chapas: parseInt(row.querySelector('[data-field="Quantidade_Chapas"]').value, 10),
                            TurnoID: parseInt(row.querySelector('[data-field="TurnoID"]').value, 10),
                            Obs: row.querySelector('[data-field="Obs"]').value,
                        };
                        if (!payload.Tipo_Descarte || !(payload.Quantidade_Chapas > 0) || !payload.TurnoID) {
                            return App.ui.showNotification("Campos inv√°lidos na linha.", 'error');
                        }
                        try {
                            await App.utils.apiCall(`/descarte/${id}`, {
                                method: 'PUT',
                                body: JSON.stringify(payload)
                            });
                            App.ui.showNotification('Descarte atualizado com sucesso!');
                            await this.loadDescartesDoDia();
                        } catch (e) {
                            this.cancelEditing(id);
                        } finally {
                            this.state.editingRowId = null;
                            this.state.originalRowHTML = null;
                        }
                    },
                    deleteDescarte(id) {
                        const confirmModal = App.utils.$('#confirmModal');
                        const confirmOk = App.utils.$('#confirmOk');
                        if (!confirmModal || !confirmOk) return;
                        App.utils.setText('#confirmModalTitle', 'Confirmar Exclus√£o de Descarte');
                        App.utils.setText('#confirmModalText', `Tem certeza que deseja excluir o descarte #${id}?`);
                        confirmOk.onclick = async () => {
                            try {
                                await App.utils.apiCall(`/descarte/${id}`, {
                                    method: 'DELETE'
                                });
                                App.ui.showNotification(`Descarte #${id} exclu√≠do com sucesso.`);
                                await this.loadDescartesDoDia();
                            } catch (e) {
                                console.error(`Falha ao excluir descarte ${id}`, e);
                            } finally {
                                App.ui.toggleModal('confirmModal', false);
                            }
                        };
                        App.ui.toggleModal('confirmModal', true);
                    },
                },
                prensa: {
                    state: {
                        dataRef: null,
                        // O ideal √© ter um setor "Prensa", mas usaremos o "Geral" como fallback.
                        setorId: null,
                    },
                    init() {
                        // Define o ID do setor para os registros da prensa.
                        const setorPrensa = App.state.cache.setores.find(s => s.SetorNome.toUpperCase() === 'PRENSA');
                        const setorGeral = App.state.cache.setores.find(s => s.SetorNome.toUpperCase() === 'PRODU√á√ÉO GERAL');
                        this.state.setorId = setorPrensa ? setorPrensa.SetorID : (setorGeral ? setorGeral.SetorID : 1);

                        App.utils.$('#dataPrensa').value = this.state.dataRef;
                        App.ui.populateSelect('turnoPrensa', App.state.cache.turnos, 'TurnoID', 'TurnoNome');
                        App.ui.populateSelect('produtoCodigoPrensa', App.state.cache.produtos, 'Codigo', 'Descricao');
                        // ADICIONE ESTE EVENT LISTENER na fun√ß√£o setupEventListeners():
                        App.utils.$('#codigoPrensaInput').addEventListener('input', App.utils.debounce(async (e) => {
                            const codigo = e.target.value.trim();
                            if (!codigo) return;

                            // Busca produto e atualiza preview
                            App.buscarProdutoPorCodigo(codigo, '#descricaoProdutoPrensaPreview');

                            // Tenta sugerir carga automaticamente
                            try {
                                const response = await App.utils.apiCall(`/api/prensa/carga?codigo=${encodeURIComponent(codigo)}`);
                                if (response.carga) {
                                    const select = App.utils.$('#cargaPrensaSelect');
                                    const option = Array.from(select.options).find(opt => opt.value == response.carga);

                                    if (option) {
                                        select.value = response.carga;
                                    } else {
                                        // Se n√£o existir, cria uma op√ß√£o tempor√°ria
                                        const newOption = document.createElement('option');
                                        newOption.value = response.carga;
                                        newOption.textContent = `${response.carga} chapas/prensada (Sugerido)`;
                                        select.appendChild(newOption);
                                        select.value = response.carga;
                                    }

                                    // Recalcula prensadas
                                    App.logic.prensa.recalcularPrensadas();
                                }
                            } catch (error) {
                                // N√£o faz nada se n√£o encontrar sugest√£o
                                console.log("Nenhuma sugest√£o de carga encontrada para:", codigo);
                            }
                        }, 500));

                        this.carregarCargasDisponiveis(); // Nova fun√ß√£o para popular o dropdown
                        this.carregarGridDia();
                        this.atualizarTotaisDia();
                    },
                    async carregarCargasDisponiveis() {
                        const select = App.utils.$("#cargaPrensaSelect");
                        if (!select) return;

                        // Op√ß√µes padr√£o como fallback
                        const cargasPadrao = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51];

                        try {
                            const cargasDisponiveis = await App.utils.apiCall("/api/prensa/cargas-disponiveis");

                            // Limpa select e adiciona op√ß√£o padr√£o
                            select.innerHTML = '<option value="">Selecione a carga (chapas/prensada)</option>';

                            // Verifica se a resposta √© um array v√°lido
                            if (Array.isArray(cargasDisponiveis) && cargasDisponiveis.length > 0) {
                                cargasDisponiveis.forEach(carga => {
                                    const option = document.createElement('option');
                                    option.value = carga;
                                    option.textContent = `${carga} chapas/prensada`;
                                    select.appendChild(option);
                                });
                            } else {
                                // Usa valores padr√£o se a resposta for inv√°lida
                                throw new Error('Resposta do servidor inv√°lida');
                            }
                        } catch (error) {
                            console.warn("Falha ao carregar cargas, usando valores padr√£o:", error);

                            // Limpa e preenche com valores padr√£o
                            select.innerHTML = '<option value="">Selecione a carga (chapas/prensada)</option>';
                            cargasPadrao.forEach(carga => {
                                const option = document.createElement('option');
                                option.value = carga;
                                option.textContent = `${carga} chapas/prensada`;
                                select.appendChild(option);
                            });

                            App.ui.showNotification('Usando cargas padr√£o', 'warning');
                        }

                        // Adiciona event listener para recalcular prensadas quando a carga mudar
                        select.addEventListener('change', () => this.recalcularPrensadas());
                    },


                    async sugerirCargaProduto() {
                        const codigo = App.utils.getValue('#codigoPrensaInput') || App.utils.getValue('#produtoCodigoPrensa');
                        if (!codigo) return;

                        try {
                            const data = await App.utils.apiCall(`/api/prensa/carga?codigo=${encodeURIComponent(codigo)}`);
                            const cargaSugerida = data.carga;
                            const select = App.utils.$('#cargaPrensaSelect');

                            // Verifica se a carga sugerida j√° existe como uma op√ß√£o
                            let optionExists = false;
                            for (let option of select.options) {
                                if (option.value == cargaSugerida) {
                                    optionExists = true;
                                    break;
                                }
                            }

                            // Se n√£o existir, adiciona
                            if (!optionExists && cargaSugerida) {
                                const newOption = document.createElement('option');
                                newOption.value = cargaSugerida;
                                newOption.textContent = `${cargaSugerida} chapas/prensada (Sugerido)`;
                                select.appendChild(newOption);
                            }

                            // Seleciona a carga sugerida
                            select.value = cargaSugerida;
                            this.recalcularPrensadas(); // Recalcula ao sugerir
                            App.utils.$('#btnRegistrarPrensa').disabled = false;

                        } catch (error) {
                            // N√£o faz nada se n√£o encontrar, o usu√°rio pode selecionar manualmente
                            console.warn(`Nenhuma carga padr√£o encontrada para o c√≥digo ${codigo}`);
                        }
                    },

                    recalcularPrensadas() {
                        const qtd = parseInt(App.utils.getValue('#quantidadePrensa'), 10) || 0;
                        const carga = parseInt(App.utils.getValue('#cargaPrensaSelect'), 10) || 0;
                        const prensadasPreview = App.utils.$('#prensadasPreview');

                        if (qtd > 0 && carga > 0) {
                            const prensadas = Math.ceil(qtd / carga);
                            prensadasPreview.value = `${prensadas} prensadas`;
                            App.utils.$('#btnRegistrarPrensa').disabled = false;
                        } else {
                            prensadasPreview.value = '‚Äî';
                            App.utils.$('#btnRegistrarPrensa').disabled = true;
                        }
                    },
                    setDataRef() {
                        const novaData = App.utils.getValue('#dataRefPrensa');
                        this.state.dataRef = novaData;
                        localStorage.setItem('prensa.dataRef', novaData);
                        App.utils.$('#dataPrensa').value = novaData;
                        this.carregarCargasDisponiveis();
                        this.carregarGridDia();
                        this.atualizarTotaisDia();
                    },
                    async confirmarCarga() {
                        const codigo = App.utils.getValue('#codigoPrensaInput') || App.utils.getValue('#produtoCodigoPrensa');
                        const qtd = parseInt(App.utils.getValue('#quantidadePrensa'), 10);

                        if (!codigo || !qtd || qtd <= 0) {
                            App.ui.showNotification('Informe um produto e uma quantidade v√°lida.', 'warning');
                            return;
                        }

                        try {
                            // A fun√ß√£o apiCall j√° mostra o loading
                            const data = await App.utils.apiCall(`/api/prensa/carga?codigo=${encodeURIComponent(codigo)}`);
                            const carga = parseInt(data.carga, 10);

                            if (carga > 0) {
                                // escreve no SELECT atual
                                const sel = App.utils.$('#cargaPrensaSelect');
                                if (sel) {
                                    // se a op√ß√£o n√£o existir, adiciona antes de selecionar
                                    let exists = false;
                                    for (let o of sel.options) { if (parseInt(o.value, 10) === carga) { exists = true; break; } }
                                    if (!exists) {
                                        const opt = document.createElement('option');
                                        opt.value = String(carga);
                                        opt.textContent = `${carga} chapas/prensada (Sugerido)`;
                                        sel.appendChild(opt);
                                    }
                                    sel.value = String(carga);
                                }
                                const prensadas = Math.ceil(qtd / carga);
                                App.utils.$('#prensadasPreview').value = `${prensadas} prensadas`;
                                App.utils.$('#btnRegistrarPrensa').disabled = false;

                                App.ui.showNotification(`Carga de ${carga} chapas/prensada confirmada.`, 'success');
                            } else {
                                throw new Error('Carga inv√°lida recebida do servidor.');
                            }
                        } catch (error) {
                            App.ui.showNotification('Carga n√£o encontrada. Verifique o cadastro do produto.', 'error');
                            App.utils.$('#btnRegistrarPrensa').disabled = true;
                        }
                    },
                    async registrar() {
                        const codigo = App.utils.getValue('#codigoPrensaInput') || App.utils.getValue('#produtoCodigoPrensa');
                        const produto = App.state.cache.produtos.find(p => p.Codigo == codigo);
                        const quantidade = parseInt(App.utils.getValue('#quantidadePrensa'), 10);
                        const carga = parseInt(App.utils.getValue('#cargaPrensaSelect'), 10);

                        if (!produto || !quantidade || !carga) {
                            App.ui.showNotification('Dados insuficientes para o registro.', 'error');
                            return;
                        }

                        const payload = {
                            Data: App.utils.getValue('#dataPrensa'),
                            TurnoID: parseInt(App.utils.getValue('#turnoPrensa'), 10),
                            SetorID: this.state.setorId,
                            ProdutoID: produto.ProdutoID,
                            Quantidade_Chapas: quantidade,
                            Carga: carga,
                            Prensadas: Math.ceil(quantidade / carga),
                            Observacoes: App.utils.getValue('#obsPrensa').trim()
                        };

                        if (!payload.ProdutoID || !payload.TurnoID || !payload.Data || !(payload.Quantidade_Chapas > 0)) {
                            App.ui.showNotification('Preencha todos os campos obrigat√≥rios (*).', 'error');
                            return;
                        }

                        try {
                            const novoLancamento = await App.utils.apiCall('/producao', { method: 'POST', body: JSON.stringify(payload) });

                            App.state.cache.producao.push({ ...payload, ProducaoID: novoLancamento.ProducaoID, createdAt: new Date().toISOString() });

                            App.ui.showNotification('Produ√ß√£o da Prensa registrada com sucesso!');
                            this.limparForm();
                            this.carregarGridDia();
                            this.atualizarTotaisDia();

                        } catch (error) {
                            // O erro j√° √© notificado
                        }
                    },
                    async carregarGridDia() {
                        const tbody = App.utils.$('#prensaDiaTbody');
                        if (!tbody) return;

                        const dataFiltro = this.state.dataRef;
                        const producaoDoDia = App.state.cache.producao
                            .filter(p => p.Data === dataFiltro && p.SetorID === this.state.setorId)
                            .sort((a, b) => (b.ProducaoID || Date.parse(b.createdAt)) - (a.ProducaoID || Date.parse(a.createdAt)));

                        if (producaoDoDia.length === 0) {
                            tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;">Nenhum lan√ßamento para esta data.</td></tr>`;
                        } else {
                            tbody.innerHTML = producaoDoDia.map(p => {
                                const produto = App.state.cache.produtos.find(prod => prod.ProdutoID === p.ProdutoID);
                                const turno = App.state.cache.turnos.find(t => t.TurnoID === p.TurnoID);
                                return `
                    <tr>
                        <td>${p.ProducaoID}</td>
                        <td>${produto?.Codigo || 'N/A'}</td>
                        <td>${produto?.Descricao || 'N/A'}</td>
                        <td>${p.Quantidade_Chapas}</td>
                        <td>${p.Carga || 'N/A'}</td>
                        <td>${p.Prensadas || 'N/A'}</td>
                        <td>${turno?.TurnoNome || 'N/A'}</td>
                        <td>${p.Observacoes || ''}</td>
                        <td>${App.utils.formatLaunchDate(p.createdAt, p.Data)}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="abrirModalEditarProducao(${p.ProducaoID})">Editar</button>
                            <button class="btn btn-sm btn-danger" onclick="excluirProducao(${p.ProducaoID})">Excluir</button>
                        </td>
                    </tr>
                `;
                            }).join('');
                        }
                    },
                    async atualizarTotaisDia() {
                        const producaoDoDia = App.state.cache.producao
                            .filter(p => p.Data === this.state.dataRef && p.SetorID === this.state.setorId);

                        const totalChapas = producaoDoDia.reduce((sum, p) => sum + (p.Quantidade_Chapas || 0), 0);
                        const totalPrensadas = producaoDoDia.reduce((sum, p) => sum + (p.Prensadas || 0), 0);

                        App.utils.setText('#totalChapasPrensaDia', totalChapas);
                        App.utils.setText('#totalPrensadasDia', totalPrensadas);
                    },
                    limparForm() {
                        ['codigoPrensaInput', 'quantidadePrensa', 'cargaPrensa', 'prensadasPreview', 'obsPrensa'].forEach(id => App.utils.$(`#${id}`).value = '');
                        App.utils.$('#produtoCodigoPrensa').value = '';
                        App.utils.$('#descricaoProdutoPrensaPreview').textContent = '';
                        App.utils.$('#btnRegistrarPrensa').disabled = true;
                        App.utils.$('#codigoPrensaInput').focus();
                    },
                }, // <-- V√çRGULA IMPORTANTE AQUI
                resumoDescarte: {
                    async getProducaoPorFamiliaNoDia(dataISO) {
                        const producaoDia = App.state.cache.producao.filter(p => p.Data === dataISO);
                        const mapa = new Map();
                        for (const p of producaoDia) {
                            const produto = App.state.cache.produtos.find(prod => prod.ProdutoID === p.ProdutoID);
                            const familiaNome = App.logic.getFamiliaNome(produto?.FamiliaID) || 'Sem Fam√≠lia';
                            if (!mapa.has(familiaNome)) {
                                mapa.set(familiaNome, {
                                    chapas: 0
                                });
                            }
                            mapa.get(familiaNome).chapas += p.Quantidade_Chapas;
                        }
                        return mapa;
                    },
                    async getDescartePorFamiliaETipoNoDia(dataISO) {
                        const descartesDia = App.state.cache.descartesDoDia.filter(d => d.Data === dataISO);
                        const mapa = new Map();
                        for (const d of descartesDia) {
                            const produto = App.state.cache.produtos.find(prod => prod.ProdutoID === d.ProdutoID);
                            const familiaNome = App.logic.getFamiliaNome(produto?.FamiliaID) || 'Sem Fam√≠lia';
                            const tipoDescarte = d.Tipo_Descarte || 'N√£o especificado';
                            if (!mapa.has(familiaNome)) {
                                mapa.set(familiaNome, {
                                    totalChapas: 0,
                                    porTipo: new Map()
                                });
                            }
                            const familiaData = mapa.get(familiaNome);
                            familiaData.totalChapas += d.Quantidade_Chapas;
                            const qtdPorTipo = familiaData.porTipo.get(tipoDescarte) || 0;
                            familiaData.porTipo.set(tipoDescarte, qtdPorTipo + d.Quantidade_Chapas);
                        }
                        return mapa;
                    },
                    montarResumoDescarteWhats({
                        dataISO,
                        mapProducao,
                        mapDescarte,
                        optsSugestoes,
                        limiares = {
                            alertaPerc: 5
                        }
                    }) {
                        const dataFmt = new Date(dataISO + 'T12:00:00').toLocaleDateString('pt-BR');
                        const fInt = (n) => (n || 0).toLocaleString('pt-BR');
                        const fPerc = (n) => isFinite(n) && n > 0 ? n.toLocaleString('pt-BR', {
                            minimumFractionDigits: 1,
                            maximumFractionDigits: 1
                        }) + '%' : '‚Äî';
                        const FAMILIAS_ORDEM = ['EXPORTACAO', 'PLASTIFICADO', 'RESINADO', 'MOVELEIRO'];
                        const totalProduzido = Array.from(mapProducao.values()).reduce((s, d) => s + d.chapas, 0);
                        const totalDescarte = Array.from(mapDescarte.values()).reduce((s, d) => s + d.totalChapas, 0);
                        const percTotal = fPerc((totalDescarte / (totalProduzido + totalDescarte)) * 100);
                        let msg = `*NM ‚Äî Resumo Produ√ß√£o & Descarte (${dataFmt})*\n\n`;
                        msg += `*Totais (chapas):*\n`;
                        msg += `‚Ä¢ Produzidas: ${fInt(totalProduzido)}\n`;
                        msg += `‚Ä¢ Descarte: ${fInt(totalDescarte)} (${percTotal})\n\n`;
                        msg += `*Por fam√≠lia (chapas):*\n`;
                        FAMILIAS_ORDEM.forEach(fam => {
                            const nomeNorm = fam.replace('√á√ÉO', 'CAO').toUpperCase();
                            const prodData = Array.from(mapProducao.entries()).find(([k]) => k.toUpperCase().includes(nomeNorm));
                            const descData = Array.from(mapDescarte.entries()).find(([k]) => k.toUpperCase().includes(nomeNorm));
                            const p = prodData ? prodData[1].chapas : 0;
                            const d = descData ? descData[1].totalChapas : 0;
                            const perc = fPerc((d / (p + d)) * 100);
                            msg += `‚Ä¢ ${fam.charAt(0).toUpperCase() + fam.slice(1).toLowerCase()} ‚Äî Prod: ${fInt(p)} | Desc: ${fInt(d)} (${perc})\n`;
                        });
                        const detalhePorTipo = Array.from(mapDescarte.entries()).filter(([, d]) => d.totalChapas > 0);
                        if (detalhePorTipo.length > 0) {
                            msg += `\n*Detalhamento por tipo (chapas):*\n`;
                            detalhePorTipo.forEach(([familia, dados], index) => {
                                if (index > 0) {
                                    msg += '\n';
                                }
                                msg += `‚Ä¢ *${familia}:*\n`;
                                const tiposOrdenados = [...dados.porTipo.entries()].sort(([, a], [, b]) => b - a);
                                tiposOrdenados.forEach(([tipo, qtd]) => {
                                    const percTipo = fPerc((qtd / dados.totalChapas) * 100);
                                    msg += `  - ${tipo}: ${fInt(qtd)} (${percTipo})\n`;
                                });
                            });
                        }
                        if (Object.values(optsSugestoes).some(v => v)) {
                            msg += `\n\n*Sugest√µes:*\n`;
                            if (optsSugestoes.top3) {
                                const todosTipos = new Map();
                                mapDescarte.forEach(d => {
                                    d.porTipo.forEach((qtd, tipo) => {
                                        todosTipos.set(tipo, (todosTipos.get(tipo) || 0) + qtd);
                                    });
                                });
                                const top3 = [...todosTipos.entries()].sort(([, a], [, b]) => b - a).slice(0, 3);
                                if (top3.length > 0) {
                                    msg += `‚Ä¢ Top 3 tipos com maior impacto: ${top3.map(([t, q]) => `${t} (${fInt(q)})`).join(', ')}\n`;
                                }
                            }
                            if (optsSugestoes.familiaMaior) {
                                let maxPerc = -1;
                                let famMax = 'N/A';
                                mapDescarte.forEach((dadosDesc, familia) => {
                                    const dadosProd = mapProducao.get(familia) || {
                                        chapas: 0
                                    };
                                    const p = dadosProd.chapas;
                                    const d = dadosDesc.totalChapas;
                                    const percNum = (d / (p + d)) * 100;
                                    if (isFinite(percNum) && percNum > maxPerc) {
                                        maxPerc = percNum;
                                        famMax = familia;
                                    }
                                });
                                if (maxPerc > -1) {
                                    const alerta = maxPerc > limiares.alertaPerc ? ` (ATEN√á√ÉO, acima de ${limiares.alertaPerc}%)` : '';
                                    msg += `‚Ä¢ Maior % de descarte: ${famMax} com ${fPerc(maxPerc)}${alerta}\n`;
                                }
                            }
                        }
                        return msg;
                    },
                    async onCopiarResumoDescarte() {
                        const dataISO = App.utils.getValue('#dataTabelaDescartes');
                        if (!dataISO) {
                            App.ui.showNotification('Por favor, selecione uma data primeiro.', 'warning');
                            return;
                        }
                        let mapProducao, mapDescarte;
                        try {
                            App.ui.showLoading(true);
                            await Promise.all([
                                App.logic.descarte.loadDescartesDoDia(dataISO),
                                App.logic.loadProducao()
                            ]);
                            [mapProducao, mapDescarte] = await Promise.all([
                                this.getProducaoPorFamiliaNoDia(dataISO),
                                this.getDescartePorFamiliaETipoNoDia(dataISO)
                            ]);
                        } catch (error) {
                            console.error("ERRO CR√çTICO ao buscar ou processar dados para o resumo:", error);
                            App.ui.showNotification('Falha ao obter os dados para o resumo. Verifique o console (F12) e tente novamente.', 'error');
                            return;
                        } finally {
                            App.ui.showLoading(false);
                        }
                        const producaoEncontrada = mapProducao && mapProducao.size > 0;
                        const descarteEncontrado = mapDescarte && mapDescarte.size > 0;
                        if (!producaoEncontrada && !descarteEncontrado) {
                            App.ui.showNotification('Sem lan√ßamentos de produ√ß√£o ou descarte para esta data.', 'info');
                            return;
                        }
                        if (!producaoEncontrada) {
                            App.ui.showNotification('Aten√ß√£o: Nenhum dado de PRODU√á√ÉO encontrado. O resumo conter√° apenas Descartes.', 'warning');
                        }
                        if (!descarteEncontrado) {
                            App.ui.showNotification('Aten√ß√£o: Nenhum dado de DESCARTE encontrado. O resumo conter√° apenas Produ√ß√£o.', 'warning');
                        }
                        const modal = App.utils.$('#modalResumoDescarte');
                        const btnConfirmar = App.utils.$('#btnConfirmarCopiaResumo');
                        if (!modal || !btnConfirmar) {
                            console.error("Erro de Interface: O modal de resumo (#modalResumoDescarte) ou seu bot√£o de confirma√ß√£o (#btnConfirmarCopiaResumo) n√£o foram encontrados no HTML.");
                            App.ui.showNotification("Erro de interface: O modal de resumo n√£o p√¥de ser aberto.", 'error');
                            return;
                        }
                        App.utils.$('#sugestaoTop3').checked = false;
                        App.utils.$('#sugestaoFamiliaMaior').checked = false;
                        App.ui.toggleModal('modalResumoDescarte', true);
                        const newBtn = btnConfirmar.cloneNode(true);
                        btnConfirmar.parentNode.replaceChild(newBtn, btnConfirmar);
                        newBtn.onclick = async () => {
                            const optsSugestoes = {
                                top3: App.utils.$('#sugestaoTop3').checked,
                                familiaMaior: App.utils.$('#sugestaoFamiliaMaior').checked,
                            };
                            const texto = this.montarResumoDescarteWhats({
                                dataISO,
                                mapProducao,
                                mapDescarte,
                                optsSugestoes
                            });
                            try {
                                await navigator.clipboard.writeText(texto);
                                App.ui.showNotification('Resumo copiado para a √°rea de transfer√™ncia!', 'success');
                            } catch (err) {
                                console.error('Falha ao copiar para a √°rea de transfer√™ncia:', err);
                                App.ui.showNotification('Erro ao copiar. Verifique as permiss√µes do navegador.', 'error');
                            } finally {
                                App.ui.toggleModal('modalResumoDescarte', false);
                            }
                        };
                    }
                },
            },
            init() {
                console.log('Sistema COMPENSADOS NM iniciando...');
                const today = this.utils.getLocalDateISO();
                const savedProdDate = localStorage.getItem('producao.dataReferencia');
                App.state.dataReferencia = savedProdDate || today;
                const savedEsqDate = localStorage.getItem('esq.dataRef');
                App.state.dataRefEsq = savedEsqDate || today;
                const savedDescDate = localStorage.getItem('descarte.dataTabela');
                App.state.dataTabelaDescartes = savedDescDate || today;
                App.state.esqGerencial.currentDate = new Date(today + 'T12:00:00');
                App.utils.$('#dataReferencia').value = App.state.dataReferencia;
                App.utils.$('#dataRefEsq').value = App.state.dataRefEsq;
                App.utils.$('#filtroDataGerencial').value = today;
                App.utils.$('#esqGerencialDataRef').value = today;
                App.utils.$('#dataTabelaDescartes').value = App.state.dataTabelaDescartes;
                App.utils.$('#dataDescarte').value = this.utils.getYesterdayDateString();
                const savedPrensaDate = localStorage.getItem('prensa.dataRef');
                App.logic.prensa.state.dataRef = savedPrensaDate || today;
                App.utils.$('#dataRefPrensa').value = App.logic.prensa.state.dataRef;
                this.ui.updateConnectionStatus('disconnected');
                this.setupEventListeners();
                setTimeout(() => this.logic.conectarBanco(), 1000);
                console.log('Sistema inicializado com sucesso!');
            },
            // SUBSTITUA TODA ESTA FUN√á√ÉO NO SEU JAVASCRIPT
            setupEventListeners() {
                const btnConectar = App.utils.$('#btnConectar');
                if (btnConectar) {
                    btnConectar.addEventListener('click', () => App.logic.conectarBanco());
                }
                document.body.addEventListener('click', (e) => {
                    if (e.target && e.target.id === 'btnCopiarResumoDescarte') {
                        if (App.logic.resumoDescarte && typeof App.logic.resumoDescarte.onCopiarResumoDescarte === 'function') {
                            App.logic.resumoDescarte.onCopiarResumoDescarte();
                        }
                    }
                });
                const mobileMenuToggle = App.utils.$('#mobileMenuToggle');
                const sidebar = App.utils.$('#sidebar');
                const overlay = App.utils.$('#sidebarOverlay');
                const sidebarCloseButton = App.utils.$('#sidebarCloseButton');
                const closeMenu = () => {
                    sidebar.classList.remove('is-open');
                    overlay.classList.remove('is-open');
                };
                if (mobileMenuToggle && sidebar && overlay) {
                    mobileMenuToggle.addEventListener('click', () => {
                        sidebar.classList.toggle('is-open');
                        overlay.classList.toggle('is-open');
                    });
                    overlay.addEventListener('click', closeMenu);
                    if (sidebarCloseButton) {
                        sidebarCloseButton.addEventListener('click', closeMenu);
                    }
                }
                App.utils.$('#navTabs').addEventListener('click', (e) => {
                    const button = e.target.closest('.nav-tab');
                    if (button) {
                        this.switchTab(button.dataset.tab);
                        closeMenu();
                    }
                });
                document.addEventListener("keydown", (e) => {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                        return;
                    }
                    if (e.ctrlKey && e.key === 'Enter') {
                        e.preventDefault();
                        const activeTab = document.querySelector('.tab-content.active').id;
                        if (activeTab === 'producao') registrarProducao();
                        else if (activeTab === 'esquadrejadeira') App.logic.registrarProducaoEsq();
                        else if (activeTab === 'descarte') App.logic.descarte.registrar();
                        else if (activeTab === 'prensa') App.logic.prensa.registrar();
                    }
                    if (e.ctrlKey) {
                        const key = e.key.toLowerCase();
                        const tabMap = { "1": "dashboard", "2": "gerencial", "3": "importar", "4": "produtos", "5": "turnos", "6": "producao", "7": "descarte", "8": "consulta", "9": "relatorios", "e": "esquadrejadeira", "p": "prensa", "g": "gerencial-acabamento" };
                        if (tabMap[key]) {
                            e.preventDefault();
                            document.querySelector(`.nav-tab[data-tab="${tabMap[key]}"]`)?.click();
                        }
                    }
                });
                App.utils.$('#dataReferencia').addEventListener('change', () => App.logic.setDataReferencia());
                App.utils.$('#dataRefEsq').addEventListener('change', () => App.logic.setDataRefEsq());
                App.utils.$('#btnRegistrarEsq').addEventListener('click', () => App.logic.registrarProducaoEsq());
                App.utils.$('#codigoEsqInput').addEventListener('input', App.utils.debounce((e) => App.buscarProdutoPorCodigo(e.target.value, '#descricaoProdutoEsqPreview'), 300));
                App.utils.$('#codigoEsqInput').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        App.utils.$('#quantidadeEsq').focus();
                    }
                });
                App.utils.$('#quantidadeEsq').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        App.utils.$('#turnoEsq').focus();
                    }
                });
                App.utils.$('#turnoEsq').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        App.utils.$('#btnRegistrarEsq').focus();
                    }
                });
                App.utils.$('#buscarProduto')?.addEventListener('input', App.utils.debounce((e) => {
                    const input = e.target;
                    const selectionStart = input.selectionStart;
                    App.state.produtos.filterText = App.utils.normalizeText(e.target.value);
                    App.logic.renderProdutos();
                    input.focus();
                    input.setSelectionRange(selectionStart, selectionStart);
                }, 200));
                App.utils.$('#produtos thead')?.addEventListener('click', (e) => {
                    const th = e.target.closest('th');
                    if (th && th.dataset.sort) {
                        const key = th.dataset.sort;
                        const { sort } = App.state.produtos;
                        if (sort.key === key) {
                            sort.dir = sort.dir === 'asc' ? 'desc' : 'asc';
                        } else {
                            sort.key = key;
                            sort.dir = 'asc';
                        }
                        App.logic.renderProdutos();
                    }
                });
                App.utils.$('#filtroDataGerencial')?.addEventListener('change', () => App.logic.sync.updateGerencial());
                App.utils.$('#dataTabelaDescartes').addEventListener('change', () => App.logic.descarte.setDataTabela());
                App.utils.$('#codigoDescarteInput').addEventListener('input', App.utils.debounce(App.logic.descarte.handleCodigoChange.bind(App.logic.descarte), 300));



                // --- IN√çCIO DO C√ìDIGO DE NAVEGA√á√ÉO COM 'ENTER' E SETAS PARA A ABA DESCARTE ---
                const descarteFieldsOrder = [
                    'codigoDescarteInput',
                    'tipoDescarte',
                    'quantidadeDescarte',
                    'turnoDescarte',
                    'dataDescarte',
                    'descarteObs',
                    'btnRegistrarDescarte'
                ];

                descarteFieldsOrder.forEach((fieldId, index) => {
                    const element = App.utils.$('#' + fieldId);

                    if (element) {
                        element.addEventListener('keydown', (event) => {
                            if (event.key === 'Enter' || event.key === 'ArrowDown' || event.key === 'ArrowUp') {
                                if (event.ctrlKey) {
                                    return;
                                }
                                event.preventDefault();

                                let targetIndex;

                                if (event.key === 'ArrowUp') {
                                    targetIndex = index - 1;
                                } else {
                                    targetIndex = index + 1;
                                }

                                const targetFieldId = descarteFieldsOrder[targetIndex];

                                if (targetFieldId) {
                                    const targetElement = App.utils.$('#' + targetFieldId);
                                    if (targetElement) {
                                        targetElement.focus();


                                        setTimeout(() => {
                                            if (targetElement.tagName === 'INPUT' && (targetElement.type === 'text' || targetElement.type === 'number')) {
                                                targetElement.select();
                                            }
                                        }, 0); // Um delay de 0ms √© suficiente para resolver o problema de timing.

                                    }
                                }
                            }
                        });
                    }
                });
                // --- FIM DO C√ìDIGO DE NAVEGA√á√ÉO COM 'ENTER' E SETAS PARA A ABA DESCARTE ---


                App.utils.$('#descartesDiaTbody').addEventListener('dblclick', App.logic.descarte.handleRowDblClick.bind(App.logic.descarte));
                App.utils.$('#descartesDiaTbody').addEventListener('click', App.logic.descarte.handleTableClick.bind(App.logic.descarte));
                App.utils.$('#descartesDiaTbody').addEventListener('keydown', App.logic.descarte.handleTableKeyDown.bind(App.logic.descarte));
                App.utils.$('#dataRefPrensa').addEventListener('change', () => App.logic.prensa.setDataRef());
                App.utils.$('#codigoPrensaInput').addEventListener('input', App.utils.debounce((e) => App.buscarProdutoPorCodigo(e.target.value, '#descricaoProdutoPrensaPreview'), 300));
                App.utils.$('#btnConfirmarCargaPrensa').addEventListener('click', () => App.logic.prensa.confirmarCarga());
                App.utils.$('#btnRegistrarPrensa').addEventListener('click', () => App.logic.prensa.registrar());
                App.utils.$('#btnLimparPrensa').addEventListener('click', () => App.logic.prensa.limparForm());
                App.utils.$('#codigoPrensaInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') App.utils.$('#quantidadePrensa').focus(); });
                App.utils.$('#quantidadePrensa').addEventListener('keydown', (e) => { if (e.key === 'Enter') App.utils.$('#btnConfirmarCargaPrensa').focus(); });
                App.utils.$('#quantidadePrensa').addEventListener('input', () => {
                    App.utils.$('#btnRegistrarPrensa').disabled = true;
                    App.utils.$('#prensadasPreview').value = 'Confirme a carga novamente';
                });
                App.logic.initConsulta();
                App.logic.esqGerencial.initEventListeners();
                App.logic.detalhesTurno.initAba();
            },
            handleProducaoFormKeyDown(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const targetId = e.target.id;
                    if (targetId === 'codigoInput') {
                        App.buscarProdutoPorCodigo(e.target.value, '#descricaoProdutoPreview');
                        App.utils.$('#quantidade').focus();
                    } else if (targetId === 'quantidade') {
                        App.utils.$('#turnoDetalhado').focus();
                    } else if (targetId === 'turnoDetalhado') {
                        App.utils.$('#dataProducao').focus();
                    }
                }
            },
            switchTab(tabId) {


                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                const activeTabButton = document.querySelector(`.nav-tab[data-tab="${tabId}"]`);
                if (activeTabButton) activeTabButton.classList.add('active');

                const activeTabContent = App.utils.$(`#${tabId}`);
                if (activeTabContent) activeTabContent.classList.add('active');

                // Sistema de inicializa√ß√£o √∫nica - CORRIGIDO
                if (App.state.isConnected) {
                    if (!App.state.initializedTabs[tabId]) {
                        if (tabId === 'gerencial') this.logic.sync.updateGerencial();
                        if (tabId === 'gerencial-acabamento') this.logic.esqGerencial.init();
                        if (tabId === 'detalhes-turno') this.logic.detalhesTurno.initAba();
                        if (tabId === 'consulta') this.logic.loadConsultaData();
                        if (tabId === 'producao') this.logic.initProducaoTab();
                        if (tabId === 'esquadrejadeira') this.logic.initEsquadrejadeiraTab();
                        if (tabId === 'descarte') this.logic.descarte.init();
                        if (tabId === 'prensa') this.logic.prensa.init();
                        if (tabId === 'secador') initSecadorTab();

                        App.state.initializedTabs[tabId] = true;
                    }
                } else {
                    App.ui.showNotification('Conecte-se ao servidor primeiro', 'warning');
                }
            },
            buscarProdutoPorCodigo(codigo, previewSelector) {
                const produto = App.state.cache.produtos.find(p => p.Codigo === codigo.trim());
                const previewEl = App.utils.$(previewSelector);
                if (produto && previewEl) {
                    previewEl.textContent = `${produto.Descricao}`;
                    previewEl.style.color = '#1e40af';
                } else if (previewEl) {
                    previewEl.textContent = 'Produto n√£o encontrado.';
                    previewEl.style.color = '#dc2626';
                }
            },
            filterTable(tbodyId, term) {
                const filter = term.toUpperCase();
                const tbody = App.utils.$(`#${tbodyId}`);
                if (!tbody) return;
                const rows = tbody.getElementsByTagName("tr");
                for (let row of rows) {
                    let found = false;
                    for (let cell of row.getElementsByTagName("td")) {
                        if (cell && cell.textContent.toUpperCase().indexOf(filter) > -1) {
                            found = true;
                            break;
                        }
                    }
                    row.style.display = found ? "" : "none";
                }
            },
        });



        App.logic.esqGerencial = {
            init() {
                if (!App.state.isConnected) {
                    App.ui.showNotification('Conecte-se ao servidor para ver os dados.', 'warning');
                    return;
                }
                const today = App.utils.getTodayDateString();
                App.state.esqGerencial.currentDate = new Date(today + 'T12:00:00');
                App.utils.$('#esqGerencialDataRef').value = today;

                const findTurno = (namePart, sectorPart = 'ESQUADREJADEIRA') => {
                    const turnos = App.state.cache.turnos;
                    const nameUpper = namePart.toUpperCase();
                    const sectorUpper = sectorPart.toUpperCase();
                    let turno = turnos.find(t => {
                        const turnoNomeUpper = t.TurnoNome.toUpperCase();
                        return turnoNomeUpper.includes(sectorUpper) && turnoNomeUpper.includes(nameUpper);
                    });
                    if (!turno) {
                        console.warn(`Turno espec√≠fico "${sectorPart} ${namePart}" n√£o encontrado. Usando fallback gen√©rico.`);
                        turno = turnos.find(t => t.TurnoNome.toUpperCase().includes(nameUpper));
                    }
                    return turno;
                };

                const turno1 = findTurno('1¬∫');
                const turno2 = findTurno('2¬∫');

                App.state.esqGerencial.turno1Id = turno1 ? turno1.TurnoID : null;
                App.state.esqGerencial.turno2Id = turno2 ? turno2.TurnoID : null;

                this.loadDataForWeek();
            },

            initEventListeners() {
                App.utils.$('#esqGerencialDataRef').addEventListener('change', (e) => {
                    App.state.esqGerencial.currentDate = new Date(e.target.value + 'T12:00:00');
                    this.loadDataForWeek();
                });
                App.utils.$('#btnSemanaAnterior').addEventListener('click', () => this.changeWeek(-7));
                App.utils.$('#btnSemanaSeguinte').addEventListener('click', () => this.changeWeek(7));
                App.utils.$('#esqGerencialTbody').addEventListener('click', (e) => {
                    const row = e.target.closest('tr');
                    if (row && row.dataset.date) {
                        this.updatePercentualDia(row.dataset.date);
                    }
                });
            },

            changeWeek(offset) {
                App.state.esqGerencial.currentDate.setDate(App.state.esqGerencial.currentDate.getDate() + offset);
                App.utils.$('#esqGerencialDataRef').value = App.state.esqGerencial.currentDate.toISOString().split('T')[0];
                this.loadDataForWeek();
            },

            getWeekRange(date) {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                const startOfWeek = new Date(d.setDate(diff));
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 4);
                return { startOfWeek, endOfWeek };
            },

            loadDataForWeek() {
                const { startOfWeek, endOfWeek } = this.getWeekRange(App.state.esqGerencial.currentDate);
                const startStr = startOfWeek.toISOString().split('T')[0];
                const endStr = endOfWeek.toISOString().split('T')[0];

                App.utils.setText('#esqGerencialTituloSemana',
                    `Semana de ${startOfWeek.toLocaleDateString('pt-BR')} a ${endOfWeek.toLocaleDateString('pt-BR')}`
                );

                const esqProducao = App.state.cache.producao.filter(p => p.SetorID === App.state.setorEsquadrejadeiraId);
                const weekProducao = esqProducao.filter(p => p.Data >= startStr && p.Data <= endStr);

                this.renderTable(startOfWeek, weekProducao);
                this.calculateAndRenderFooter(startOfWeek, endOfWeek, esqProducao);

                const refDateStr = App.state.esqGerencial.currentDate.toISOString().split('T')[0];
                const dayToSelect = (refDateStr >= startStr && refDateStr <= endStr) ? refDateStr : startStr;
                this.updatePercentualDia(dayToSelect);
            },

            renderTable(startOfWeek, weekProducao) {
                const tbody = App.utils.$('#esqGerencialTbody');
                tbody.innerHTML = '';
                const weekDays = ['Segunda-feira', 'Ter√ßa-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira'];

                for (let i = 0; i < 5; i++) {
                    const currentDate = new Date(startOfWeek);
                    currentDate.setDate(startOfWeek.getDate() + i);
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const dayName = weekDays[i];

                    const producaoDia = weekProducao.filter(p => p.Data === dateStr);
                    const totals = { t1Chapas: 0, t1M3: 0, t2Chapas: 0, t2M3: 0 };

                    producaoDia.forEach(p => {
                        const produto = App.state.cache.produtos.find(prod => prod.ProdutoID === p.ProdutoID);
                        if (!produto) return;
                        const m3 = (p.Quantidade_Chapas || 0) * (produto.Cubagem_m3 || 0);
                        if (p.TurnoID === App.state.esqGerencial.turno1Id) {
                            totals.t1Chapas += p.Quantidade_Chapas;
                            totals.t1M3 += m3;
                        } else if (p.TurnoID === App.state.esqGerencial.turno2Id) {
                            totals.t2Chapas += p.Quantidade_Chapas;
                            totals.t2M3 += m3;
                        }
                    });

                    const totalChapasDia = totals.t1Chapas + totals.t2Chapas;
                    const totalM3Dia = totals.t1M3 + totals.t2M3;

                    const row = document.createElement('tr');
                    row.dataset.date = dateStr;
                    row.innerHTML = `
                        <td>${dayName} (${currentDate.toLocaleDateString('pt-BR')})</td>
                        <td>${totals.t1Chapas} | ${totals.t1M3.toFixed(3)}</td>
                        <td>${totals.t2Chapas} | ${totals.t2M3.toFixed(3)}</td>
                        <td><strong>${totalChapasDia} | ${totalM3Dia.toFixed(3)}</strong></td>
                    `;
                    tbody.appendChild(row);
                }
            },

            calculateAndRenderFooter(startOfWeek, endOfWeek, esqProducao) {
                const startStr = startOfWeek.toISOString().split('T')[0];
                const endStr = endOfWeek.toISOString().split('T')[0];

                const weekProducao = esqProducao.filter(p => p.Data >= startStr && p.Data <= endStr);

                const totals = { t1Chapas: 0, t1M3: 0, t2Chapas: 0, t2M3: 0, totalChapas: 0, totalM3: 0 };
                const diasComProducao = new Set(weekProducao.map(p => p.Data)).size;

                weekProducao.forEach(p => {
                    const produto = App.state.cache.produtos.find(prod => prod.ProdutoID === p.ProdutoID);
                    if (!produto) return;
                    const m3 = (p.Quantidade_Chapas || 0) * (produto.Cubagem_m3 || 0);
                    totals.totalChapas += p.Quantidade_Chapas;
                    totals.totalM3 += m3;
                    if (p.TurnoID === App.state.esqGerencial.turno1Id) { totals.t1Chapas += p.Quantidade_Chapas; totals.t1M3 += m3; }
                    else if (p.TurnoID === App.state.esqGerencial.turno2Id) { totals.t2Chapas += p.Quantidade_Chapas; totals.t2M3 += m3; }
                });

                const divisor = diasComProducao > 0 ? diasComProducao : 1;
                App.utils.setText('#esqGerencialMedia1T', `${Math.round(totals.t1Chapas / divisor)} | ${(totals.t1M3 / divisor).toFixed(3)}`);
                App.utils.setText('#esqGerencialMedia2T', `${Math.round(totals.t2Chapas / divisor)} | ${(totals.t2M3 / divisor).toFixed(3)}`);
                App.utils.setText('#esqGerencialMediaTotal', `${Math.round(totals.totalChapas / divisor)} | ${(totals.totalM3 / divisor).toFixed(3)}`);

                App.utils.setText('#esqGerencialAcumulado1T', `${totals.t1Chapas} | ${totals.t1M3.toFixed(3)}`);
                App.utils.setText('#esqGerencialAcumulado2T', `${totals.t2Chapas} | ${totals.t2M3.toFixed(3)}`);
                App.utils.setText('#esqGerencialAcumuladoTotal', `${totals.totalChapas} | ${totals.totalM3.toFixed(3)}`);

                const monthStart = new Date(endOfWeek.getFullYear(), endOfWeek.getMonth(), 1).toISOString().split('T')[0];
                const mtdProducao = esqProducao.filter(p => p.Data >= monthStart && p.Data <= endStr);
                const mtdTotals = { t1Chapas: 0, t1M3: 0, t2Chapas: 0, t2M3: 0, totalChapas: 0, totalM3: 0 };
                mtdProducao.forEach(p => {
                    const produto = App.state.cache.produtos.find(prod => prod.ProdutoID === p.ProdutoID);
                    if (!produto) return;
                    const m3 = (p.Quantidade_Chapas || 0) * (produto.Cubagem_m3 || 0);
                    mtdTotals.totalChapas += p.Quantidade_Chapas;
                    mtdTotals.totalM3 += m3;
                    if (p.TurnoID === App.state.esqGerencial.turno1Id) { mtdTotals.t1Chapas += p.Quantidade_Chapas; mtdTotals.t1M3 += m3; }
                    else if (p.TurnoID === App.state.esqGerencial.turno2Id) { mtdTotals.t2Chapas += p.Quantidade_Chapas; mtdTotals.t2M3 += m3; }
                });

                App.utils.setText('#esqGerencialMtd1T', `${mtdTotals.t1Chapas} | ${mtdTotals.t1M3.toFixed(3)}`);
                App.utils.setText('#esqGerencialMtd2T', `${mtdTotals.t2Chapas} | ${mtdTotals.t2M3.toFixed(3)}`);
                App.utils.setText('#esqGerencialMtdTotal', `${mtdTotals.totalChapas} | ${mtdTotals.totalM3.toFixed(3)}`);

                this.updatePercentualMes(mtdProducao, mtdTotals.totalM3);
            },

            updatePercentualDia(dateStr) {
                document.querySelectorAll('#esqGerencialTbody tr').forEach(r => r.classList.remove('selected-day'));
                const row = App.utils.$(`#esqGerencialTbody tr[data-date="${dateStr}"]`);
                if (row) row.classList.add('selected-day');

                const dateFmt = new Date(dateStr + 'T12:00:00').toLocaleDateString('pt-BR');
                App.utils.setText('#percDiaTitulo', `% do Dia (${dateFmt})`);

                const esqProducao = App.state.cache.producao.filter(p => p.SetorID === App.state.setorEsquadrejadeiraId);
                const diaProducao = esqProducao.filter(p => p.Data === dateStr);

                const totalM3Dia = diaProducao.reduce((sum, p) => {
                    const produto = App.state.cache.produtos.find(prod => prod.ProdutoID === p.ProdutoID);
                    return sum + (produto ? (p.Quantidade_Chapas * produto.Cubagem_m3) : 0);
                }, 0);

                this.renderPercentualList('#percDiaContainer', diaProducao, totalM3Dia);
            },

            updatePercentualMes(mtdProducao, totalM3Mes) {
                this.renderPercentualList('#percMesContainer', mtdProducao, totalM3Mes);
            },

            renderPercentualList(containerSelector, producao, totalM3) {
                const container = App.utils.$(containerSelector);
                if (!container) return;

                if (totalM3 === 0) {
                    container.innerHTML = '<li>Nenhuma produ√ß√£o no per√≠odo.</li>';
                    return;
                }

                const m3PorTamanho = producao.reduce((acc, p) => {
                    const produto = App.state.cache.produtos.find(prod => prod.ProdutoID === p.ProdutoID);
                    if (!produto || !produto.Comprimento_m) return acc;

                    const tamanhoKey = `${produto.Comprimento_m.toFixed(2)}√ó${produto.Largura_m.toFixed(2)}√ó${produto.Bitola_m.toFixed(3)}`;
                    const m3 = (p.Quantidade_Chapas || 0) * (produto.Cubagem_m3 || 0);

                    if (!acc[tamanhoKey]) acc[tamanhoKey] = 0;
                    acc[tamanhoKey] += m3;
                    return acc;
                }, {});

                const sortedTamanhos = Object.entries(m3PorTamanho).sort(([, a], [, b]) => b - a);

                container.innerHTML = sortedTamanhos.slice(0, 10).map(([tamanho, m3]) => {
                    const percent = (m3 / totalM3 * 100).toFixed(1);
                    return `
                        <li>
                            <span class="tamanho">${tamanho}</span>
                            <span class="valor">${m3.toFixed(3)} m¬≥</span>
                            <span class="percentual">${percent}%</span>
                        </li>
                    `;
                }).join('');

                if (sortedTamanhos.length > 10) {
                    container.innerHTML += `<li><a href="#" style="text-align:center; display:block;">+ Ver todos</a></li>`;
                }
            }
        };
        // =========== IN√çCIO: DETALHES (VERS√ÉO FINAL COM CORRE√á√ÉO DE RENDERIZA√á√ÉO) ===========
        App.logic.detalhesTurno = {
            state: {
                processedData: null,
                currentDate: null,
                filterTerm: '',
                filterFamily: []
            },

            initAba() {
                App.utils.$('#btnBuscarDetalhesAba').addEventListener('click', () => this.run('aba'));
                // Conecta ao novo bot√£o que agora vai gerar as imagens PNG
                App.utils.$('#btnGerarPngs').addEventListener('click', () => this.gerarImagensPNG());
                App.utils.$('#btnExportarCsvDetalhes').addEventListener('click', () => this.export('csv'));
                App.utils.$('#btnCopiarResumo').addEventListener('click', () => this.copySummary());

                App.utils.$('#buscaDetalhesAba').addEventListener('input', App.utils.debounce(e => {
                    this.state.filterTerm = e.target.value;
                    this.render('aba');
                }, 300));

                App.utils.$('#filtroFamiliaDetalhes').addEventListener('change', e => {
                    this.state.filterFamily = Array.from(e.target.selectedOptions).map(opt => opt.value);
                    this.render('aba');
                });
            },

            // As fun√ß√µes run, processData, render, etc., continuam as mesmas da vers√£o anterior.
            // Cole o bloco inteiro para garantir que tudo funcione.
            async run(target) {
                const filtroAba = App.utils.$('#filtroFamiliaDetalhes');
                if (filtroAba && (!filtroAba.options || filtroAba.options.length === 0)) {
                    App.ui.populateSelect('filtroFamiliaDetalhes', App.state.cache.familias, 'FamiliaID', 'FamiliaNome');
                    if (App.utils.$('#filtroFamiliaDetalhes option[value=""]')) App.utils.$('#filtroFamiliaDetalhes option[value=""]').remove();
                }

                const dateInputId = target === 'modal' ? '#filtroDataGerencial' : '#filtroDataDetalhesTurno';
                const date = App.utils.getValue(dateInputId);
                if (!date) {
                    App.ui.showNotification('Por favor, selecione uma data.', 'warning');
                    return;
                }

                this.state.currentDate = date;
                this.state.filterTerm = '';
                this.state.filterFamily = [];

                App.utils.$('#buscaDetalhesAba').value = '';
                Array.from(App.utils.$('#filtroFamiliaDetalhes').options).forEach(opt => opt.selected = false);

                App.ui.showLoading(true);
                await Promise.all([App.logic.loadProducao()]).catch(e => console.error("Falha ao recarregar dados", e));

                this.processData(date);
                this.render(target);

                App.ui.showLoading(false);
            },

            processData(date) {
                const { producao: allProducao, produtos, turnos, familias } = App.state.cache;
                const producaoDia = allProducao.filter(p => p.Data === date && p.SetorID !== App.state.setorEsquadrejadeiraId);

                const getTurnoMesa = (turnoId) => {
                    const turno = turnos.find(t => t.TurnoID === turnoId);
                    if (!turno) return { turnoGrupo: 'OUTROS', mesa: 'N/A' };
                    const nome = turno.TurnoNome.toUpperCase();
                    let turnoGrupo = 'OUTROS';
                    if (nome.includes('1¬∫ TURNO')) turnoGrupo = '1T';
                    else if (nome.includes('2¬∫ TURNO')) turnoGrupo = '2T';
                    else if (nome.includes('3¬∫ TURNO')) turnoGrupo = '3T';
                    let mesa = 'GERAL';
                    const mesaMatch = nome.match(/MESA \d+|MESA ELEVADA|ESTEIRA/);
                    if (mesaMatch) mesa = mesaMatch[0];
                    return { turnoGrupo, mesa };
                };

                const data = { '1T': {}, '2T': {}, '3T': {}, 'OUTROS': {} };

                producaoDia.forEach(p => {
                    const produto = produtos.find(prod => prod.ProdutoID === p.ProdutoID);
                    if (!produto) return;
                    const familia = familias.find(f => f.FamiliaID === produto.FamiliaID) || { FamiliaID: 0, FamiliaNome: 'SEM FAM√çLIA' };
                    const { turnoGrupo, mesa } = getTurnoMesa(p.TurnoID);

                    if (!data[turnoGrupo][mesa]) {
                        data[turnoGrupo][mesa] = { listaDeProdutos: new Map() };
                    }

                    const listaProdutos = data[turnoGrupo][mesa].listaDeProdutos;
                    const cubagem = produto.Cubagem_m3 || 0;

                    if (listaProdutos.has(produto.ProdutoID)) {
                        const itemExistente = listaProdutos.get(produto.ProdutoID);
                        itemExistente.quantidade += p.Quantidade_Chapas;
                        itemExistente.m3Total += p.Quantidade_Chapas * cubagem;
                    } else {
                        listaProdutos.set(produto.ProdutoID, {
                            codigo: produto.Codigo,
                            descricao: produto.Descricao,
                            familia: familia.FamiliaNome,
                            familiaId: familia.FamiliaID,
                            quantidade: p.Quantidade_Chapas,
                            m3Total: p.Quantidade_Chapas * cubagem,
                            data: p.Data,
                            medida: `${(produto.Comprimento_m || 0).toFixed(2)}x${(produto.Largura_m || 0).toFixed(2)}x${(produto.Bitola_m || 0).toFixed(3)}m`
                        });
                    }
                });

                this.state.processedData = {};
                Object.keys(data).forEach(turnoKey => {
                    if (Object.keys(data[turnoKey]).length > 0) {
                        this.state.processedData[turnoKey] = {};
                        Object.keys(data[turnoKey]).forEach(mesaKey => {
                            const mesaData = data[turnoKey][mesaKey];
                            const produtosArray = Array.from(mesaData.listaDeProdutos.values());

                            const totaisMesa = {
                                chapasProduzidas: produtosArray.reduce((s, p) => s + p.quantidade, 0),
                                m3Total: produtosArray.reduce((s, p) => s + p.m3Total, 0),
                            };

                            const resumoPorFamilia = produtosArray.reduce((acc, prod) => {
                                if (!acc[prod.familia]) {
                                    acc[prod.familia] = { familiaId: prod.familiaId, medidas: new Set(), chapasProduzidas: 0, m3Total: 0 };
                                }
                                acc[prod.familia].medidas.add(prod.medida);
                                acc[prod.familia].chapasProduzidas += prod.quantidade;
                                acc[prod.familia].m3Total += prod.m3Total;
                                return acc;
                            }, {});

                            produtosArray.forEach(prod => {
                                prod.percentualMesa = totaisMesa.m3Total > 0 ? (prod.m3Total / totaisMesa.m3Total) * 100 : 0;
                            });

                            this.state.processedData[turnoKey][mesaKey] = {
                                resumoPorFamilia,
                                listaDeProdutos: produtosArray,
                                totaisMesa
                            };
                        });
                    }
                });
            },

            render(target) {
                const container = App.utils.$('#detalhesTurnoContent');
                if (!this.state.processedData || Object.keys(this.state.processedData).length === 0) {
                    container.innerHTML = '<div class="alert alert-info">Nenhuma produ√ß√£o encontrada para esta data.</div>';
                    App.utils.$('#detalhesTurnoTotals').innerHTML = '';
                    return;
                }

                let mainHtml = '';
                const totaisGerais = { chapasProduzidas: 0, m3Total: 0 };
                const turnosOrdenados = ['1T', '2T', '3T', 'OUTROS'];
                const formatarNomeTurno = (key) => key === 'OUTROS' ? 'OUTROS TURNOS' : key.replace('T', '¬∫ TURNO');

                turnosOrdenados.forEach(turnoKey => {
                    const turnoData = this.state.processedData[turnoKey];
                    if (!turnoData || Object.keys(turnoData).length === 0) return;

                    let turnoContentHtml = '';
                    const totaisTurno = { chapasProduzidas: 0, m3Total: 0 };

                    Object.keys(turnoData).sort().forEach(mesaKey => {
                        const mesaData = turnoData[mesaKey];
                        if (!mesaData || !mesaData.listaDeProdutos || mesaData.listaDeProdutos.length === 0) return;

                        const filteredItems = mesaData.listaDeProdutos.filter(item => {
                            const searchTerm = this.state.filterTerm.toUpperCase();
                            const familyMatch = this.state.filterFamily.length === 0 || this.state.filterFamily.includes(String(item.familiaId));
                            const termMatch = !searchTerm || item.codigo.toUpperCase().includes(searchTerm) || item.descricao.toUpperCase().includes(searchTerm);
                            return familyMatch && termMatch;
                        });

                        if (filteredItems.length === 0 && (this.state.filterTerm || this.state.filterFamily.length > 0)) return;

                        let resumoHtml = `<div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem;">`;
                        let hasVisibleFamilies = false;
                        Object.keys(mesaData.resumoPorFamilia).sort().forEach(familiaKey => {
                            const familiaData = mesaData.resumoPorFamilia[familiaKey];
                            if (this.state.filterFamily.length > 0 && !this.state.filterFamily.includes(String(familiaData.familiaId))) return;
                            hasVisibleFamilies = true;
                            resumoHtml += `<div class="card" style="margin-bottom: 0; padding: 1rem; border-top-color: var(--info-color); flex-grow: 1;"><h4 style="margin-bottom: 0.5rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">FAM√çLIA: ${familiaKey}</h4><div style="font-size: 0.9rem;"><strong>Medidas:</strong> <small>${[...familiaData.medidas].join(', ')}</small><br><strong>Chapas Produzidas:</strong> ${familiaData.chapasProduzidas.toLocaleString('pt-BR')}<br><strong>Total m¬≥:</strong> ${familiaData.m3Total.toLocaleString('pt-BR', { minimumFractionDigits: 3, maximumFractionDigits: 3 })}</div></div>`;
                        });
                        resumoHtml += `</div>`;
                        if (!hasVisibleFamilies && this.state.filterFamily.length > 0) resumoHtml = '';

                        let tabelaHtml = '';
                        if (filteredItems.length > 0) {
                            tabelaHtml = `<h4 style="margin-top: 1.5rem; border-top: 2px solid #eee; padding-top: 1rem;">Produtos da Mesa</h4><div class="table-container"><table class="table"><thead><tr><th>C√≥d</th><th>Descri√ß√£o</th><th>Fam√≠lia</th><th>Qtd</th><th>m¬≥ Total</th><th>% da Mesa</th><th>A√ß√£o</th></tr></thead><tbody>
                                 ${filteredItems.map(item => `<tr><td>${item.codigo}</td><td>${item.descricao}</td><td>${item.familia}</td><td>${item.quantidade.toLocaleString('pt-BR')}</td><td><strong>${item.m3Total.toLocaleString('pt-BR', { minimumFractionDigits: 3, maximumFractionDigits: 3 })}</strong></td><td>${item.percentualMesa.toFixed(2).replace('.', ',')}%</td><td><button class="btn btn-info btn-sm" onclick="App.logic.detalhesTurno.goToProducao('${item.data}', '${item.codigo}')" title="Ir para lan√ßamento">‚ûî</button></td></tr>`).join('')}
                                 </tbody></table></div>`;
                        }

                        const { totaisMesa } = mesaData;
                        turnoContentHtml += `<div class="card" style="margin-bottom: 1.5rem;"><h3 style="background: #eef2ff; padding: 0.75rem; border-radius: 8px;">MESA: ${mesaKey}</h3><div style="padding: 1.5rem;">${resumoHtml}${tabelaHtml}<div style="text-align: right; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); font-weight: bold;">Total da Mesa: ${totaisMesa.chapasProduzidas.toLocaleString('pt-BR')} chapas | ${totaisMesa.m3Total.toLocaleString('pt-BR', { minimumFractionDigits: 3, maximumFractionDigits: 3 })} m¬≥</div></div></div>`;

                        totaisTurno.chapasProduzidas += totaisMesa.chapasProduzidas;
                        totaisTurno.m3Total += totaisMesa.m3Total;
                    });

                    if (turnoContentHtml) {
                        mainHtml += `<div class="card" data-turno-key="${turnoKey}" style="margin-bottom: 1.5rem; background-color: #f0f2f5;"><h2 style="background: var(--dark-color); color: white; padding: 0.75rem 1.5rem; margin: -1.5rem -1.5rem 1.5rem -1.5rem; border-radius: 12px 12px 0 0;">${formatarNomeTurno(turnoKey)}</h2><div style="padding: 1.5rem;">${turnoContentHtml}<div style="text-align: right; font-weight: bold; font-size: 1.1rem; color: var(--primary-color); margin-top: 1rem;">Total do Turno: ${totaisTurno.chapasProduzidas.toLocaleString('pt-BR')} chapas | ${totaisTurno.m3Total.toLocaleString('pt-BR', { minimumFractionDigits: 3, maximumFractionDigits: 3 })} m¬≥</div></div></div>`;
                        totaisGerais.chapasProduzidas += totaisTurno.chapasProduzidas;
                        totaisGerais.m3Total += totaisTurno.m3Total;
                    }
                });

                container.innerHTML = mainHtml || '<div class="alert alert-info">Nenhuma produ√ß√£o encontrada para os filtros aplicados.</div>';

                const totalsContainer = App.utils.$('#detalhesTurnoTotals');
                totalsContainer.innerHTML = `<span style="font-weight: bold;">TOTAL GERAL DO DIA:</span><span style="margin-left: 1rem;">${totaisGerais.chapasProduzidas.toLocaleString('pt-BR')} chapas</span><span style="margin-left: 1rem;">${totaisGerais.m3Total.toLocaleString('pt-BR', { minimumFractionDigits: 3, maximumFractionDigits: 3 })} m¬≥</span>`;
            },

            goToProducao(data, codigo) { /* ...c√≥digo sem altera√ß√£o... */ },
            export(format) { /* ...c√≥digo sem altera√ß√£o... */ },
            copySummary() { /* ...c√≥digo sem altera√ß√£o... */ },

            /**
             * NOVA FUN√á√ÉO
             * Tira um "print" de cada card de turno e baixa arquivos .png separados.
             */
            async gerarImagensPNG() {
                if (!this.state.processedData || Object.keys(this.state.processedData).length === 0) {
                    App.ui.showNotification('N√£o h√° dados para gerar as imagens.', 'warning');
                    return;
                }

                App.ui.showLoading(true);
                App.ui.showNotification('Gerando imagens PNG, por favor aguarde...', 'info');

                try {
                    const turnos = document.querySelectorAll('#detalhesTurnoContent [data-turno-key]');

                    // Loop para processar e baixar cada turno como uma imagem separada
                    for (const turnoNode of turnos) {
                        const turnoId = turnoNode.dataset.turnoKey || 'Turno';

                        // Usa html2canvas para converter o elemento em uma imagem
                        const canvas = await html2canvas(turnoNode, {
                            scale: 2, // Melhor qualidade de imagem
                            useCORS: true
                        });

                        // Cria um link tempor√°rio para acionar o download
                        const link = document.createElement('a');
                        link.download = `Relatorio_Turno_${turnoId}_${this.state.currentDate}.png`;
                        link.href = canvas.toDataURL('image/png');
                        link.click(); // Aciona o download no navegador
                    }

                    App.ui.showNotification('Imagens PNG geradas com sucesso!', 'success');

                } catch (error) {
                    console.error("Erro ao gerar imagens PNG:", error);
                    App.ui.showNotification('Ocorreu um erro ao gerar as imagens.', 'error');
                } finally {
                    App.ui.showLoading(false);
                }
            }
        };

        // Fun√ß√µes globais
        function testarConexao() { App.logic.conectarBanco(); }
        function abrirModalProduto() {
            App.state.editingProduct = null;
            App.utils.setText('#tituloModalProduto', 'Novo Produto');
            ['modalCodigo', 'modalDescricao', 'modalComprimento', 'modalLargura', 'modalBitola', 'modalFamiliaID'].forEach(id => App.utils.$(`#${id}`).value = '');
            App.ui.toggleModal('modalProduto', true);
        }
        function abrirModalTurno() {
            App.state.editingTurno = null;
            App.utils.setText('#tituloModalTurno', 'Novo Turno');
            App.utils.$('#modalNomeTurno').value = '';
            App.ui.toggleModal('modalTurno', true);
        }
        function fecharModal(modalId) { App.ui.toggleModal(modalId, false); }
        function toggleSelect(selectId) {
            const select = App.utils.$(`#${selectId}`);
            if (select) select.style.display = select.style.display === 'none' ? 'block' : 'none';
        }
        function editarProduto(id) {
            const p = App.state.cache.produtos.find(p => p.ProdutoID == id);
            if (!p) return;
            App.state.editingProduct = id;
            App.utils.setText('#tituloModalProduto', 'Editar Produto');
            App.utils.$('#modalCodigo').value = p.Codigo;
            App.utils.$('#modalDescricao').value = p.Descricao;
            App.utils.$('#modalComprimento').value = p.Comprimento_m;
            App.utils.$('#modalLargura').value = p.Largura_m;
            App.utils.$('#modalBitola').value = p.Bitola_m;
            App.utils.$('#modalFamiliaID').value = p.FamiliaID;
            App.ui.toggleModal('modalProduto', true);
        }
        function editarTurno(id) {
            const t = App.state.cache.turnos.find(t => t.TurnoID == id);
            if (!t) return;
            App.state.editingTurno = id;
            App.utils.setText('#tituloModalTurno', 'Editar Turno');
            App.utils.$('#modalNomeTurno').value = t.TurnoNome;
            App.ui.toggleModal('modalTurno', true);
        }
        async function excluirProduto(id) {
            if (confirm('Deseja realmente excluir este produto?')) {
                try {
                    const result = await App.utils.apiCall(`/produtos/${id}`, { method: 'DELETE' });
                    App.ui.showNotification(result.message);
                    App.logic.loadProdutos();
                } catch (error) { }
            }
        }
        async function excluirTurno(id) {
            if (confirm('Deseja realmente excluir este turno?')) {
                App.ui.showNotification("Exclus√£o de turnos n√£o implementada no servidor", 'warning');
            }
        }
        async function salvarProduto() {
            try {
                const codigo = App.utils.getValue('#modalCodigo').trim();
                const descricao = App.utils.getValue('#modalDescricao').trim();

                if (!codigo || !descricao) {
                    App.ui.showNotification('C√≥digo e Descri√ß√£o s√£o obrigat√≥rios', 'error');
                    return;
                }

                const comprimento = parseFloat(App.utils.getValue('#modalComprimento')) || 0;
                const largura = parseFloat(App.utils.getValue('#modalLargura')) || 0;
                const bitola = parseFloat(App.utils.getValue('#modalBitola')) || 0;
                const familiaID = parseInt(App.utils.getValue('#modalFamiliaID')) || 1;

                const payload = {
                    Codigo: codigo,
                    Descricao: descricao,
                    Comprimento_m: comprimento,
                    Largura_m: largura,
                    Bitola_m: bitola,
                    Cubagem_m3: comprimento * largura * bitola,
                    FamiliaID: familiaID,
                    Ativo: 'SIM'
                };

                const endpoint = App.state.editingProduct ? `/produtos/${App.state.editingProduct}` : '/produtos';
                const method = App.state.editingProduct ? 'PUT' : 'POST';

                App.ui.showLoading(true);

                try {
                    const result = await App.utils.apiCall(endpoint, {
                        method: method,
                        body: JSON.stringify(payload)
                    });
                    App.ui.showNotification(result.message || 'Produto salvo com sucesso!', 'success');
                } catch (apiError) {
                    // Se der 404 no PUT, tenta criar novo produto
                    if (apiError.message.includes('404') && method === 'PUT') {
                        console.warn('Endpoint PUT n√£o encontrado, tentando POST...');
                        const createResult = await App.utils.apiCall('/produtos', {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });
                        App.ui.showNotification('Produto criado com sucesso (servidor n√£o suporta edi√ß√£o)!', 'success');
                    } else {
                        throw apiError;
                    }
                }

                App.ui.toggleModal('modalProduto', false);
                await App.logic.loadProdutos();
                App.state.editingProduct = null;

            } catch (error) {
                console.error('Erro ao salvar produto:', error);
                App.ui.showNotification('Erro ao salvar produto: ' + error.message, 'error');
            } finally {
                App.ui.showLoading(false);
            }
        }
        function salvarTurno() { App.logic.salvarTurno(); }
        function registrarProducao() { App.logic.registrarProducao(); }
        function registrarDescarte() { App.logic.descarte.registrar(); }
        function aplicarFiltros() { App.logic.aplicarFiltros(); }
        function limparFiltros() { App.logic.limparFiltros(); }
        function exportarResultadosConsulta(tipo) { App.logic.exportarResultadosConsulta(tipo); }
        function exportarProdutos() { App.ui.showNotification('Funcionalidade de exporta√ß√£o em desenvolvimento', 'info'); }
        function exportarTurnos() { App.ui.showNotification('Funcionalidade de exporta√ß√£o em desenvolvimento', 'info'); }
        function exportarRelatorio(tipo) { App.ui.showNotification(`Exportando relat√≥rio ${tipo}...`, 'info'); }
        function importarArquivo() {
            if (!App.utils.$('#fileInput').files[0]) return App.ui.showNotification('Selecione um arquivo', 'warning');
            App.ui.showNotification('Funcionalidade de importa√ß√£o em desenvolvimento', 'info');
        }

        function abrirModalEditarProducao(id) {
            const p = App.state.cache.producao.find(p => p.ProducaoID == id);
            if (!p) return App.ui.showNotification('Lan√ßamento n√£o encontrado!', 'error');

            const produto = App.state.cache.produtos.find(prod => prod.ProdutoID === p.ProdutoID);
            App.state.editingProducao = id;

            App.ui.populateSelect('modalEditarTurno', App.state.cache.turnos, 'TurnoID', 'TurnoNome');
            App.utils.setText('#tituloModalEditarProducao', `Editar Lan√ßamento #${id}`);
            App.utils.setText('#modalEditarProducaoDescricao', produto ? `${produto.Codigo} - ${produto.Descricao}` : 'Produto n√£o encontrado');
            App.utils.$('#modalEditarQuantidade').value = p.Quantidade_Chapas;
            App.utils.$('#modalEditarTurno').value = p.TurnoID;
            App.utils.$('#modalEditarData').value = p.Data;

            App.ui.toggleModal('modalEditarProducao', true);
        }

        async function salvarProducaoEditada() {
            const producaoID = App.state.editingProducao;
            if (!producaoID) return;

            const payload = {
                Quantidade_Chapas: parseInt(App.utils.getValue('#modalEditarQuantidade'), 10),
                TurnoID: parseInt(App.utils.getValue('#modalEditarTurno'), 10),
                Data: App.utils.getValue('#modalEditarData'),
            };

            if (!payload.Quantidade_Chapas || !payload.TurnoID || !payload.Data || payload.Quantidade_Chapas <= 0) {
                return App.ui.showNotification('Por favor, preencha todos os campos corretamente.', 'error');
            }

            try {
                const result = await App.utils.apiCall(`/producao/${producaoID}`, { method: 'PUT', body: JSON.stringify(payload) });
                App.ui.showNotification(result.message);
                App.ui.toggleModal('modalEditarProducao', false);
                App.state.editingProducao = null;

                await App.logic.loadProducao();

                if (App.utils.$('#esquadrejadeira').classList.contains('active')) {
                    App.logic.renderEsqDoDia();
                } else {
                    App.logic.renderProducaoDoDia();
                }
            } catch (error) {
                console.warn(`MODO DE SIMULA√á√ÉO (PUT /producao/${producaoID}): `, error);
                const index = App.state.cache.producao.findIndex(p => p.ProducaoID === producaoID);
                if (index !== -1) {
                    App.state.cache.producao[index] = { ...App.state.cache.producao[index], ...payload };
                    App.ui.showNotification("Altera√ß√£o simulada com sucesso (apenas local).");
                    App.ui.toggleModal('modalEditarProducao', false);
                    App.state.editingProducao = null;
                    if (App.utils.$('#esquadrejadeira').classList.contains('active')) {
                        App.logic.renderEsqDoDia();
                    } else {
                        App.logic.renderProducaoDoDia();
                    }
                }
            }
        }

        function excluirProducao(id) {
            const confirmModal = App.utils.$('#confirmModal');
            const confirmOk = App.utils.$('#confirmOk');
            if (!confirmModal || !confirmOk) return;

            App.utils.setText('#confirmModalTitle', 'Confirmar Exclus√£o');
            App.utils.setText('#confirmModalText', `Tem certeza que deseja excluir o lan√ßamento #${id}? Esta a√ß√£o n√£o pode ser desfeita.`);

            confirmOk.onclick = () => confirmarExclusaoProducao(id);

            App.ui.toggleModal('confirmModal', true);
        }

        async function confirmarExclusaoProducao(id) {
            try {
                const result = await App.utils.apiCall(`/producao/${id}`, { method: 'DELETE' });
                App.ui.showNotification(result.message);

                const index = App.state.cache.producao.findIndex(p => p.ProducaoID == id);
                if (index > -1) {
                    App.state.cache.producao.splice(index, 1);
                }

                if (App.utils.$('#esquadrejadeira').classList.contains('active')) {
                    App.logic.renderEsqDoDia();
                } else {
                    App.logic.renderProducaoDoDia();
                }

                App.logic.loadDashboard();

            } catch (error) {
                console.error('Erro ao excluir produ√ß√£o:', error);
                App.ui.showNotification('Falha ao excluir. Verifique a conex√£o e tente novamente.', 'error');
            } finally {
                App.ui.toggleModal('confirmModal', false);
            }
        }

        async function exportarPrintGerencial() {
            App.ui.showLoading(true);
            App.ui.showNotification('Gerando prints... Por favor, aguarde.', 'info');

            const gerencialTab = App.utils.$('#gerencial');
            const allSections = Array.from(gerencialTab.querySelectorAll('.gerencial-section'));
            const originalDisplays = new Map();
            allSections.forEach(el => originalDisplays.set(el, el.style.display));

            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            const dateString = `${day}-${month}-${year}`;

            const downloadCanvas = (canvas, filename) => {
                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL('image/png');
                link.click();
            };

            const capturePart = async (sectionsToShow) => {
                allSections.forEach(el => el.style.display = 'none');
                sectionsToShow.forEach(id => {
                    const el = App.utils.$(id);
                    if (el) el.style.display = 'block';
                });

                const canvas = await html2canvas(gerencialTab, {
                    useCORS: true,
                    scale: 1.5,
                    scrollY: -window.scrollY
                });

                return canvas;
            };

            try {
                const canvas1 = await capturePart(['#totaisGeraisDia', '#mediasMes']);
                downloadCanvas(canvas1, `gerencial_parte1_${dateString}.png`);

                const canvas2 = await capturePart(['#secao1T', '#secao2T', '#secao3ElevEsteira', '#gerencial > .gerencial-section:last-of-type']);
                downloadCanvas(canvas2, `gerencial_parte2_${dateString}.png`);

                App.ui.showNotification('‚úÖ Prints gerados com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao gerar os prints:', error);
                App.ui.showNotification('Ocorreu um erro ao gerar os prints.', 'error');
            } finally {
                allSections.forEach(el => el.style.display = originalDisplays.get(el) || '');
                App.ui.showLoading(false);
            }
        }

        async function exportarPrintGerencialAcabamento() {
            App.ui.showLoading(true);
            App.ui.showNotification('Gerando print do Gerencial de Acabamento...', 'info');

            const gerencialAcabamentoTab = App.utils.$('#gerencial-acabamento');

            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            const dateString = `${day}-${month}-${year}`;

            const downloadCanvas = (canvas, filename) => {
                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL('image/png');
                link.click();
            };

            try {
                const canvas = await html2canvas(gerencialAcabamentoTab, {
                    useCORS: true,
                    scale: 1.5,
                    scrollY: -window.scrollY
                });

                downloadCanvas(canvas, `gerencial_acabamento_${dateString}.png`);
                App.ui.showNotification('‚úÖ Print gerado com sucesso!', 'success');

            } catch (error) {
                console.error('Erro ao gerar o print do Gerencial Acabamento:', error);
                App.ui.showNotification('Ocorreu um erro ao gerar o print.', 'error');
            } finally {
                App.ui.showLoading(false);
            }
        }

        // ===== Produ√ß√£o: Auto-tab e Replica√ß√£o de Obs por Turno/Mesa =====


        (function setupProducaoUX() {
            const elCodigo = document.getElementById('codigoInput');
            const elQtd = document.getElementById('quantidade');
            const elTurno = document.getElementById('turnoDetalhado');
            const elData = document.getElementById('dataProducao');
            const elObs = document.getElementById('obsProducao');
            const btnRegistrar = document.getElementById('btnRegistrarProducao');

            // Mapa: chave `${data}|${turnoValor}` => texto Obs
            const obsMemo = new Map();

            function obsKey() {
                const d = (elData?.value || '').trim();
                const t = (elTurno?.options[elTurno.selectedIndex]?.text || '').trim();
                return `${d}|${t}`;
            }

            function tryPrefillObsFromMemo() {
                const key = obsKey();
                if (!key) return;
                const d = (elData?.value || '').trim();
                const t = (elTurno?.options[elTurno.selectedIndex]?.text || '').trim();
                if (obsMemo.has(key) && elObs && !elObs.value) {
                    elObs.value = obsMemo.get(key);
                } else if (!obsMemo.has(key) && elObs) {
                    elObs.value = '';
                }
            }

            // Campo C√≥digo: Apenas avan√ßa com 'Enter'
            elCodigo?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && elCodigo.value.trim()) {
                    e.preventDefault();
                    App.buscarProdutoPorCodigo(elCodigo.value, '#descricaoProdutoPreview');
                    elQtd?.focus();
                    elQtd?.select?.();
                }
            });

            // Campo Quantidade: Avan√ßa com 'Enter', volta com 'Seta para Cima'
            elQtd?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && elQtd.value.trim()) {
                    e.preventDefault();
                    elTurno?.focus();
                } else if (e.key === 'ArrowUp') { // NOVO
                    e.preventDefault();
                    elCodigo?.focus();
                }
            });

            // Campo Turno: Avan√ßa com 'Enter', volta com 'Seta para Cima'
            elTurno?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && elTurno.value.trim()) {
                    e.preventDefault();
                    elData?.focus();
                } else if (e.key === 'ArrowUp') { // NOVO
                    e.preventDefault();
                    elQtd?.focus();
                }
            });

            // Campo Data: Avan√ßa com 'Enter', volta com 'Seta para Cima'
            elData?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    elObs?.focus();
                } else if (e.key === 'ArrowUp') { // NOVO
                    e.preventDefault();
                    elTurno?.focus();
                }
            });

            // Campo Observa√ß√µes: Avan√ßa com 'Enter', volta com 'Seta para Cima'
            elObs?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.ctrlKey) {
                    e.preventDefault();
                    btnRegistrar?.focus();
                } else if (e.key === 'ArrowUp') { // NOVO
                    e.preventDefault();
                    elData?.focus();
                }
            });

            // NOVO: Bot√£o Registrar: Volta para Observa√ß√µes com 'Seta para Cima'
            btnRegistrar?.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    elObs?.focus();
                }
            });

            // L√≥gica para memorizar a observa√ß√£o (sem altera√ß√µes)
            elTurno?.addEventListener('change', tryPrefillObsFromMemo);
            elData?.addEventListener('change', tryPrefillObsFromMemo);

            elObs?.addEventListener('input', () => {
                const key = obsKey();
                const d = (elData?.value || '').trim();
                const t = (elTurno?.options[elTurno.selectedIndex]?.text || '').trim();
                if (!key || !d || !t) return;
                if (elObs.value && elObs.value.trim().length > 0) {
                    obsMemo.set(key, elObs.value.trim());
                } else {
                    obsMemo.delete(key);
                }
            });

            if (typeof window.registrarProducao === 'function') {
                const _orig = window.registrarProducao;
                window.registrarProducao = async function patchedRegistrarProducao() {
                    if (elObs && (!elObs.value || !elObs.value.trim())) {
                        const key = obsKey();
                        if (key && obsMemo.has(key)) {
                            elObs.value = obsMemo.get(key);
                        }
                    }
                    try {
                        await _orig.apply(this, arguments);
                    } catch (err) {
                        console.warn('Falha ao enviar com Observacoes. Prosseguir sem esse campo.', err);
                    }
                    const key = obsKey();
                    if (key && elObs && elObs.value && elObs.value.trim()) {
                        obsMemo.set(key, elObs.value.trim());
                    }
                    elCodigo && (elCodigo.value = '');
                    elQtd && (elQtd.value = '');
                    document.getElementById('descricaoProdutoPreview').textContent = '';
                    elObs && (elObs.value = obsMemo.get(obsKey()) || '');
                    elCodigo?.focus();
                };
            }
            window.__obsMemoProducao = obsMemo;
        })();

        window.addEventListener('load', () => App.init());

        document.addEventListener('DOMContentLoaded', function () {
            const PROD_TAB_ID = 'produtos';
            const PROD_HASH = '#' + PROD_TAB_ID;

            const deveAtivarProdutos = (location.hash === PROD_HASH)
                || (new URLSearchParams(location.search).get('tab') === PROD_TAB_ID);

            if (deveAtivarProdutos) {
                if (typeof App?.switchTab === 'function') {
                    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                    document.querySelector(`[data-tab="${PROD_TAB_ID}"]`).classList.add('active');
                    App.utils.$(`#${PROD_TAB_ID}`).classList.add('active');
                }

                const campoBusca = document.getElementById('buscarProduto');
                if (campoBusca) {
                    setTimeout(() => campoBusca.focus(), 100);
                }
            }
        });

        // =========== SECADOR TAB ===========
        // Utilit√°rios
        const _fmt3 = (v) => (isFinite(+v) ? (+v).toFixed(3) : '');
        const _normEsp = (s) => (String(s || '').trim().toLowerCase().startsWith('e') ? 'Eucalipto' : 'Pinus');
        const _hojeISO = () => new Date().toISOString().split('T')[0];

        // Estado persistente
        const SEC_STATE = {
            data: localStorage.getItem('secador.dataRef') || _hojeISO(),
            turnoID: null,
            codigo: '',
            editingId: null
        };

        // Inicializa a aba quando aberta
        async function initSecadorTab() {
            if (App.utils.$('#secador').classList.contains('active')) {
                // Data default ou √∫ltima escolhida
                App.utils.$('#sec_data').value = SEC_STATE.data;

                // Populando select de turnos
                App.ui.populateSelect('sec_turno', App.state.cache.turnos, 'TurnoID', 'TurnoNome');
                if (SEC_STATE.turnoID) App.utils.$('#sec_turno').value = SEC_STATE.turnoID;

                // Se houver c√≥digo salvo, carrega
                if (SEC_STATE.codigo) {
                    App.utils.$('#sec_codigo').value = SEC_STATE.codigo;
                    await buscarProdutoSecador();
                }

                // Carrega a grid
                await carregarGridSecador();
            }
        }

        // Busca produto do secador por c√≥digo
        async function buscarProdutoSecador() {
            const codigo = App.utils.$('#sec_codigo').value.trim();
            const preview = App.utils.$('#sec_preview');

            if (!codigo) {
                preview.textContent = 'Nenhum produto selecionado.';
                preview.style.color = 'var(--dark-color)';
                return;
            }

            try {
                const response = await App.utils.apiCall(`/api/secador/produto/${encodeURIComponent(codigo)}`);
                const produto = response;

                if (produto) {
                    SEC_STATE.codigo = codigo;
                    preview.innerHTML = `
                        <strong>${produto.codigo || codigo}</strong> - ${produto.descricao || 'Sem descri√ß√£o'}<br>
                        <small>Dimens√µes: ${_fmt3(produto.comp_m)}m √ó ${_fmt3(produto.largura_m)}m | Qualidade: ${produto.qualidade || 'N/A'}</small>
                    `;
                    preview.style.color = 'var(--secondary-color)';
                } else {
                    preview.textContent = 'C√≥digo n√£o encontrado na Dim_secador.';
                    preview.style.color = 'var(--danger-color)';
                }
            } catch (error) {
                preview.textContent = 'C√≥digo n√£o encontrado na Dim_secador.';
                preview.style.color = 'var(--danger-color)';
            }
        }

        // Registrar produ√ß√£o do secador
        async function registrarProducaoSecador() {
            const codigo = App.utils.$('#sec_codigo').value.trim();
            const cubagem = parseFloat(App.utils.$('#sec_cubagem').value);
            const especie = App.utils.$('#sec_especie').value;
            const turnoID = parseInt(App.utils.$('#sec_turno').value, 10);
            const data = App.utils.$('#sec_data').value;
            const obs = App.utils.$('#sec_obs').value;

            // Valida√ß√µes
            if (!codigo) {
                App.ui.showNotification('Informe um c√≥digo v√°lido.', 'error');
                return;
            }
            if (!(cubagem > 0)) {
                App.ui.showNotification('Cubagem deve ser maior que zero.', 'error');
                return;
            }
            if (!turnoID) {
                App.ui.showNotification('Selecione um turno.', 'error');
                return;
            }
            if (!data) {
                App.ui.showNotification('Informe a data.', 'error');
                return;
            }

            const payload = {
                data,
                turnoID,
                codigo,
                cubagem_m3: parseFloat(cubagem.toFixed(3)),
                especie: _normEsp(especie),
                observacoes: obs
            };

            try {
                const endpoint = SEC_STATE.editingId
                    ? `/api/secador/producao/${SEC_STATE.editingId}`
                    : '/api/secador/producao';
                const method = SEC_STATE.editingId ? 'PUT' : 'POST';

                await App.utils.apiCall(endpoint, { method, body: JSON.stringify(payload) });

                // Salvar no estado
                SEC_STATE.data = data;
                SEC_STATE.turnoID = turnoID;
                SEC_STATE.codigo = codigo;
                SEC_STATE.editingId = null;

                // Limpar campos
                App.utils.$('#sec_cubagem').value = '';
                App.utils.$('#sec_especie').value = 'Pinus';
                App.utils.$('#sec_obs').value = '';

                localStorage.setItem('secador.dataRef', data);

                App.ui.showNotification(
                    SEC_STATE.editingId ? 'Produ√ß√£o do Secador atualizada com sucesso!' : 'Produ√ß√£o do Secador registrada com sucesso!',
                    'success'
                );

                await carregarGridSecador();
            } catch (error) {
                App.ui.showNotification('Erro ao registrar produ√ß√£o: ' + (error.message || 'Falha de comunica√ß√£o'), 'error');
            }
        }

        // Carregar grid de lan√ßamentos do dia
        async function carregarGridSecador() {
            const data = App.utils.$('#sec_data').value;
            try {
                const rows = await App.utils.apiCall(`/api/secador/producao?data=${encodeURIComponent(data)}`);
                const tbody = App.utils.$('#sec_grid_body');

                if (!rows || rows.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;">Nenhum lan√ßamento para ${new Date(data + 'T00:00:00').toLocaleDateString('pt-BR')}.</td></tr>`;
                    return;
                }

                tbody.innerHTML = rows.map(x => `
                    <tr>
                        <td>${x.id}</td>
                        <td>${x.Codigo}</td>
                        <td>${x.Descricao || ''}</td>
                        <td>${_fmt3(x.comp_m)}m √ó ${_fmt3(x.largura_m)}m</td>
                        <td>${x.Qualidade || ''}</td>
                        <td>${x.Especie || ''}</td>
                        <td><strong>${_fmt3(x.Cubagem_m3)}</strong></td>
                        <td>${x.turnoNome || ''}</td>
                        <td>${x.Observacoes || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editarSecador(${x.id})">Editar</button>
                            <button class="btn btn-sm btn-danger" onclick="excluirSecador(${x.id})">Excluir</button>
                        </td>
                    </tr>`).join('');
            } catch (error) {
                App.ui.showNotification('Erro ao carregar lan√ßamentos: ' + (error.message || 'Falha de comunica√ß√£o'), 'error');
            }
        }

        // Editar lan√ßamento do secador
        async function editarSecador(id) {
            try {
                const data = App.utils.$('#sec_data').value;
                const rows = await App.utils.apiCall(`/api/secador/producao?data=${encodeURIComponent(data)}`);
                const registro = rows.find(r => r.id === id);

                if (!registro) {
                    App.ui.showNotification('Registro n√£o encontrado!', 'error');
                    return;
                }

                // Preencher formul√°rio
                App.utils.$('#sec_codigo').value = registro.Codigo;
                App.utils.$('#sec_cubagem').value = _fmt3(registro.Cubagem_m3);
                App.utils.$('#sec_especie').value = _normEsp(registro.Especie);
                App.utils.$('#sec_turno').value = registro.TurnoID;
                App.utils.$('#sec_data').value = registro.Data;
                App.utils.$('#sec_obs').value = registro.Observacoes || '';

                // Buscar detalhes do produto
                await buscarProdutoSecador();

                // Marcar como editando
                SEC_STATE.editingId = id;
                App.utils.$('#sec_confirm').textContent = 'Atualizar Produ√ß√£o (Ctrl+Enter)';

            } catch (error) {
                App.ui.showNotification('Erro ao editar: ' + (error.message || 'Falha de comunica√ß√£o'), 'error');
            }
        }

        // Excluir lan√ßamento do secador
        async function excluirSecador(id) {
            if (!confirm('Deseja realmente excluir este lan√ßamento?')) {
                return;
            }

            try {
                await App.utils.apiCall(`/api/secador/producao/${id}`, { method: 'DELETE' });
                App.ui.showNotification('Lan√ßamento exclu√≠do com sucesso!', 'success');
                await carregarGridSecador();
            } catch (error) {
                App.ui.showNotification('Erro ao excluir: ' + (error.message || 'Falha de comunica√ß√£o'), 'error');
            }
        }

        // Limpar formul√°rio
        function limparFormSecador() {
            SEC_STATE.editingId = null;
            App.utils.$('#sec_cubagem').value = '';
            App.utils.$('#sec_especie').value = 'Pinus';
            App.utils.$('#sec_obs').value = '';
            App.utils.$('#sec_confirm').textContent = 'Registrar Produ√ß√£o (Ctrl+Enter)';
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function () {
            // Event listener para inicializar a aba Secador quando selecionada
            const secadorTab = App.utils.$('[data-tab="secador"]');
            if (secadorTab) {
                secadorTab.addEventListener('click', function () {
                    App.switchTab('secador');
                    initSecadorTab();
                });
            }

            // Eventos dos campos
            App.utils.$('#sec_codigo')?.addEventListener('blur', buscarProdutoSecador);
            App.utils.$('#sec_codigo')?.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    buscarProdutoSecador().then(() => {
                        App.utils.$('#sec_cubagem').focus();
                    });
                }
            });

            App.utils.$('#sec_data')?.addEventListener('change', function () {
                SEC_STATE.data = this.value;
                localStorage.setItem('secador.dataRef', this.value);
                carregarGridSecador();
            });

            App.utils.$('#sec_turno')?.addEventListener('change', function () {
                SEC_STATE.turnoID = parseInt(this.value, 10);
            });

            // Bot√µes
            App.utils.$('#sec_confirm')?.addEventListener('click', registrarProducaoSecador);
            App.utils.$('#sec_limpar')?.addEventListener('click', limparFormSecador);

            // Ctrl+Enter para salvar (apenas quando a aba estiver ativa)
            document.addEventListener('keydown', function (e) {
                if (e.ctrlKey && e.key === 'Enter' && App.utils.$('#secador').classList.contains('active')) {
                    e.preventDefault();
                    registrarProducaoSecador();
                }
            });
        });

        // Expor fun√ß√µes para uso global
        window.editarSecador = editarSecador;
        window.excluirSecador = excluirSecador;


        // Estado persistente
        const TORNO_STATE = {
            data: localStorage.getItem('torno.dataRef') || _hojeISO(),
            torno: 'PETKOMAQ',
            editingId: null,
            obsMemo: new Map() // Para replica√ß√£o de observa√ß√µes
        };

        // Inicializa a aba quando aberta
        function initTornoTab() {
            if (App.utils.$('#torno').classList.contains('active')) {
                // Data default ou √∫ltima escolhida
                App.utils.$('#torno_data').value = TORNO_STATE.data;

                // Se houver torno salvo, seleciona
                if (TORNO_STATE.torno) {
                    App.utils.$('#torno_torno').value = TORNO_STATE.torno;
                }

                // Carrega a grid
                carregarGridTorno();

                // Verifica se h√° observa√ß√£o memorizada para este torno+data
                checkMemoObs();
            }
        }

        // Formatar n√∫mero para exibi√ß√£o com formato espec√≠fico
        function formatTornoNum(val, tipo) {
            if (val === null || val === undefined) return '';

            const num = parseFloat(val);
            if (isNaN(num)) return '';

            switch (tipo) {
                case 'comp':
                case 'larg':
                    // Formato 2,60 ou 1,28 (2 casas decimais, v√≠rgula)
                    return num.toFixed(2).replace('.', ',');
                case 'esp':
                    // Formato 2,6 (1 casa decimal, v√≠rgula)
                    return num.toFixed(1).replace('.', ',');
                case 'm3':
                    // Formato 6,042 m¬≥ (3 casas decimais, v√≠rgula, s√≠mbolo)
                    return num.toFixed(3).replace('.', ',') + ' m¬≥';
                default:
                    // Padr√£o para outros n√∫meros
                    return num.toFixed(3).replace('.', ',');
            }
        }

        // Carregar grid de lan√ßamentos do dia
        async function carregarGridTorno() {
            const data = App.utils.$('#torno_data').value;
            try {
                const rows = await App.utils.apiCall(`/api/torno/dia?data=${encodeURIComponent(data)}`);
                const tbody = App.utils.$('#torno_grid_body');

                if (!rows || rows.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="12" style="text-align:center;">Nenhum lan√ßamento para ${new Date(data + 'T00:00:00').toLocaleDateString('pt-BR')}.</td></tr>`;
                    return;
                }

                tbody.innerHTML = rows.map(x => `
            <tr>
                <td>${x.id}</td>
                <td>${x.Data}</td>
                <td>${x.Torno || ''}</td>
                <td>${x.Especie || ''}</td>
                <td>${formatTornoNum(x.comp_lamina_m, 'comp')}</td>
                <td>${formatTornoNum(x.larg_lamina_m, 'larg')}</td>
                <td>${formatTornoNum(x.esp_lamina_mm, 'esp')}</td>
                <td><strong>${formatTornoNum(x.m3_lamina, 'm3')}</strong></td>
                <td>${x.diametro_tora || ''}</td>
                <td>${x.teve_parada || 'N√£o'}</td>
                <td>${x.Obs || ''}</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="editarTorno(${x.id})">Editar</button>
                    <button class="btn btn-sm btn-danger" onclick="excluirTorno(${x.id})">Excluir</button>
                </td>
            </tr>`).join('');
            } catch (error) {
                App.ui.showNotification('Erro ao carregar lan√ßamentos: ' + (error.message || 'Falha de comunica√ß√£o'), 'error');
            }
        }

        // Verifica se h√° observa√ß√£o memorizada para este torno+data
        function checkMemoObs() {
            const torno = App.utils.$('#torno_torno').value;
            const data = App.utils.$('#torno_data').value;
            const key = `${data}|${torno}`;

            if (TORNO_STATE.obsMemo.has(key)) {
                App.utils.$('#torno_obs').value = TORNO_STATE.obsMemo.get(key);
            } else {
                App.utils.$('#torno_obs').value = '';
            }
        }

        // Memoriza observa√ß√£o para este torno+data
        function saveObsMemo() {
            const torno = App.utils.$('#torno_torno').value;
            const data = App.utils.$('#torno_data').value;
            const obs = App.utils.$('#torno_obs').value.trim();
            const key = `${data}|${torno}`;

            if (obs) {
                TORNO_STATE.obsMemo.set(key, obs);
            } else {
                TORNO_STATE.obsMemo.delete(key);
            }
        }

        // Registrar produ√ß√£o do torno
        async function registrarProducaoTorno() {
            const data = App.utils.$('#torno_data').value;
            const torno = App.utils.$('#torno_torno').value;
            const especie = App.utils.$('#torno_especie').value;
            const diametro_tora = App.utils.$('#torno_diametro').value;
            const comp_lamina_m = App.utils.$('#torno_comp').value;
            const larg_lamina_m = App.utils.$('#torno_larg').value;
            const esp_lamina_mm = App.utils.$('#torno_esp').value;
            const m3_lamina = App.utils.$('#torno_m3').value;
            const teve_parada = App.utils.$('#torno_parada').checked;
            const obs = App.utils.$('#torno_obs').value;

            // Valida√ß√µes
            if (!data) {
                App.ui.showNotification('Informe a data.', 'error');
                return;
            }
            if (!torno) {
                App.ui.showNotification('Selecione o torno.', 'error');
                return;
            }
            if (!especie) {
                App.ui.showNotification('Selecione a esp√©cie.', 'error');
                return;
            }
            if (!diametro_tora) {
                App.ui.showNotification('Selecione o di√¢metro da tora.', 'error');
                return;
            }
            if (!(parseFloat(comp_lamina_m) > 0)) {
                App.ui.showNotification('Comprimento da l√¢mina deve ser maior que zero.', 'error');
                return;
            }
            if (!(parseFloat(larg_lamina_m) > 0)) {
                App.ui.showNotification('Largura da l√¢mina deve ser maior que zero.', 'error');
                return;
            }
            if (!(parseFloat(esp_lamina_mm) > 0)) {
                App.ui.showNotification('Espessura da l√¢mina deve ser maior que zero.', 'error');
                return;
            }
            if (!(parseFloat(m3_lamina) > 0)) {
                App.ui.showNotification('m¬≥ da l√¢mina deve ser maior que zero.', 'error');
                return;
            }

            const payload = {
                data,
                torno,
                especie,
                diametro_tora,
                comp_lamina_m,
                larg_lamina_m,
                esp_lamina_mm,
                m3_lamina,
                teve_parada,
                obs
            };

            try {
                const endpoint = TORNO_STATE.editingId
                    ? `/api/torno/${TORNO_STATE.editingId}`
                    : '/api/torno';
                const method = TORNO_STATE.editingId ? 'PATCH' : 'POST';

                await App.utils.apiCall(endpoint, { method, body: JSON.stringify(payload) });

                // Salvar no estado
                TORNO_STATE.data = data;
                TORNO_STATE.torno = torno;
                TORNO_STATE.editingId = null;

                // Memoriza observa√ß√£o
                saveObsMemo();

                // Limpar campos (exceto data e torno)
                limparFormTornoParcial();

                localStorage.setItem('torno.dataRef', data);

                App.ui.showNotification(
                    TORNO_STATE.editingId ? 'Lan√ßamento do Torno atualizado com sucesso!' : 'Lan√ßamento do Torno registrado com sucesso!',
                    'success'
                );

                await carregarGridTorno();
            } catch (error) {
                App.ui.showNotification('Erro ao registrar produ√ß√£o: ' + (error.message || 'Falha de comunica√ß√£o'), 'error');
            }
        }

        // Limpar formul√°rio parcialmente (mant√©m data e torno)
        function limparFormTornoParcial() {
            App.utils.$('#torno_especie').value = 'Pinus';
            App.utils.$('#torno_diametro').value = '18A25';
            App.utils.$('#torno_comp').value = '';
            App.utils.$('#torno_larg').value = '';
            App.utils.$('#torno_esp').value = '';
            App.utils.$('#torno_m3').value = '';
            App.utils.$('#torno_parada').checked = false;

            // Recarrega observa√ß√£o do memo (ou limpa se n√£o houver)
            checkMemoObs();

            // Muda texto do bot√£o se estava editando
            App.utils.$('#torno_confirm').textContent = 'Registrar Produ√ß√£o (Ctrl+Enter)';

            // Foco no primeiro campo
            App.utils.$('#torno_especie').focus();
        }

        // Limpar formul√°rio completamente
        function limparFormTornoCompleto() {
            limparFormTornoParcial();
            TORNO_STATE.editingId = null;
        }

        // Editar lan√ßamento do torno
        async function editarTorno(id) {
            try {
                const data = App.utils.$('#torno_data').value;
                const rows = await App.utils.apiCall(`/api/torno/dia?data=${encodeURIComponent(data)}`);
                const registro = rows.find(r => r.id === id);

                if (!registro) {
                    App.ui.showNotification('Registro n√£o encontrado!', 'error');
                    return;
                }

                // Preencher formul√°rio
                App.utils.$('#torno_data').value = registro.Data;
                App.utils.$('#torno_torno').value = registro.Torno;
                App.utils.$('#torno_especie').value = registro.Especie;
                App.utils.$('#torno_diametro').value = registro.diametro_tora;
                App.utils.$('#torno_comp').value = registro.comp_lamina_m;
                App.utils.$('#torno_larg').value = registro.larg_lamina_m;
                App.utils.$('#torno_esp').value = registro.esp_lamina_mm;
                App.utils.$('#torno_m3').value = registro.m3_lamina;
                App.utils.$('#torno_parada').checked = registro.teve_parada === 'Sim';
                App.utils.$('#torno_obs').value = registro.Obs || '';

                // Marcar como editando
                TORNO_STATE.editingId = id;
                App.utils.$('#torno_confirm').textContent = 'Atualizar Lan√ßamento (Ctrl+Enter)';

                // Foco no primeiro campo edit√°vel
                App.utils.$('#torno_especie').focus();

            } catch (error) {
                App.ui.showNotification('Erro ao editar: ' + (error.message || 'Falha de comunica√ß√£o'), 'error');
            }
        }

        // Excluir lan√ßamento do torno
        async function excluirTorno(id) {
            if (!confirm('Deseja realmente excluir este lan√ßamento?')) {
                return;
            }

            try {
                await App.utils.apiCall(`/api/torno/${id}`, { method: 'DELETE' });
                App.ui.showNotification('Lan√ßamento exclu√≠do com sucesso!', 'success');
                await carregarGridTorno();
            } catch (error) {
                App.ui.showNotification('Erro ao excluir: ' + (error.message || 'Falha de comunica√ß√£o'), 'error');
            }
        }

        // Replicar observa√ß√µes para mesmo torno e data
        function replicarObsTorno() {
            // Verificar se h√° observa√ß√£o para replicar
            const obs = App.utils.$('#torno_obs').value.trim();
            if (!obs) {
                App.ui.showNotification('N√£o h√° observa√ß√£o para replicar.', 'warning');
                return;
            }

            // Confirmar com o usu√°rio
            if (!confirm('Deseja replicar esta observa√ß√£o para todos os lan√ßamentos do mesmo torno e mesma data?')) {
                return;
            }

            const torno = App.utils.$('#torno_torno').value;
            const data = App.utils.$('#torno_data').value;

            // Buscar todos os lan√ßamentos do dia
            App.utils.apiCall(`/api/torno/dia?data=${encodeURIComponent(data)}`)
                .then(rows => {
                    // Filtrar apenas os do mesmo torno
                    const lancsDoTorno = rows.filter(r => r.Torno === torno);

                    // Se n√£o houver outros lan√ßamentos, avisar e sair
                    if (lancsDoTorno.length === 0) {
                        App.ui.showNotification('N√£o h√° outros lan√ßamentos deste torno na data atual.', 'warning');
                        return;
                    }

                    // Atualizar cada lan√ßamento
                    const promises = lancsDoTorno.map(lanc =>
                        App.utils.apiCall(`/api/torno/${lanc.id}`, {
                            method: 'PATCH',
                            body: JSON.stringify({ obs })
                        })
                    );

                    // Aguardar todas as atualiza√ß√µes
                    return Promise.all(promises);
                })
                .then(() => {
                    // Memorizar observa√ß√£o
                    saveObsMemo();

                    // Recarregar a tabela
                    carregarGridTorno();

                    App.ui.showNotification('Observa√ß√£o replicada com sucesso!', 'success');
                })
                .catch(error => {
                    App.ui.showNotification('Erro ao replicar observa√ß√£o: ' + (error.message || 'Falha de comunica√ß√£o'), 'error');
                });
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function () {
            // Event listener para inicializar a aba Torno quando selecionada
            const tornoTab = App.utils.$('[data-tab="torno"]');
            if (tornoTab) {
                tornoTab.addEventListener('click', function () {
                    App.switchTab('torno');
                    initTornoTab();
                });
            }

            // Eventos dos campos
            App.utils.$('#torno_data')?.addEventListener('change', function () {
                TORNO_STATE.data = this.value;
                localStorage.setItem('torno.dataRef', this.value);
                carregarGridTorno();
                checkMemoObs(); // Verifica se h√° observa√ß√£o memorizada para esta nova data+torno
            });

            App.utils.$('#torno_torno')?.addEventListener('change', function () {
                TORNO_STATE.torno = this.value;
                checkMemoObs(); // Verifica se h√° observa√ß√£o memorizada para este novo torno+data
            });

            App.utils.$('#torno_obs')?.addEventListener('input', saveObsMemo);

            // Bot√µes
            App.utils.$('#torno_confirm')?.addEventListener('click', registrarProducaoTorno);
            App.utils.$('#torno_limpar')?.addEventListener('click', limparFormTornoCompleto);

            // Adicionar bot√£o para replicar observa√ß√µes (ap√≥s o bot√£o limpar)
            const btnLimpar = App.utils.$('#torno_limpar');
            if (btnLimpar) {
                const btnReplicar = document.createElement('button');
                btnReplicar.className = 'btn btn-info';
                btnReplicar.textContent = 'Replicar Observa√ß√£o';
                btnReplicar.style.marginLeft = '0.5rem';
                btnReplicar.onclick = replicarObsTorno;
                btnLimpar.parentNode.insertBefore(btnReplicar, btnLimpar.nextSibling);
            }

            // Ctrl+Enter para salvar (apenas quando a aba estiver ativa)
            document.addEventListener('keydown', function (e) {
                if (e.ctrlKey && e.key === 'Enter' && App.utils.$('#torno').classList.contains('active')) {
                    e.preventDefault();
                    registrarProducaoTorno();
                }
            });

            // Auto-tab para navega√ß√£o por Enter
            [
                ['torno_data', 'torno_torno'],
                ['torno_torno', 'torno_especie'],
                ['torno_especie', 'torno_diametro'],
                ['torno_diametro', 'torno_comp'],
                ['torno_comp', 'torno_larg'],
                ['torno_larg', 'torno_esp'],
                ['torno_esp', 'torno_m3'],
                ['torno_m3', 'torno_parada'],
                ['torno_parada', 'torno_obs'],
                ['torno_obs', 'torno_confirm']
            ].forEach(([from, to]) => {
                const fromEl = App.utils.$(`#${from}`);
                if (fromEl) {
                    fromEl.addEventListener('keydown', function (e) {
                        if (e.key === 'Enter' && !e.ctrlKey) {
                            e.preventDefault();
                            App.utils.$(`#${to}`)?.focus();
                        }
                    });
                }
            });
        });

        // Expor fun√ß√µes para uso global
        window.editarTorno = editarTorno;
        window.excluirTorno = excluirTorno;
        window.replicarObsTorno = replicarObsTorno;
        // =========== IN√çCIO: SISTEMA ESTOQUE TAB ===========

        // Estado global para a aba de estoque. Os dados agora ser√£o carregados do servidor.
        const ESTOQUE_STATE = {
            isInitialized: false,
            activeTab: 'painel',
            products: [], // Ser√° populado com os produtos do servidor via App.state.cache.produtos
            cargas: [], // Armazena as cargas dispon√≠veis vindas do servidor
            painelCarga: [], // Futuramente, vir√° do servidor
            estoquePorData: [], // Futuramente, vir√° do servidor
            movimentations: [], // Futuramente, vir√° do servidor
            painelData: {
                codigo: '',
                quantidade: '',
                nome: '',
                comprimento: '',
                largura: '',
                bitola: '',
                familia: '',
                qualidade: '',
                data: new Date().toISOString().split('T')[0],
                movimento: "ENTRADA",
                ordemProducao: "",
                ordemProducaoOrigem: '', // Novo campo para transfer√™ncia
                ordemProducaoDestino: '', // Novo campo para transfer√™ncia
                cubagem: ''
            },
            searchTerm: '',
            filterQuality: '',
            importedCargasPreview: null, // Armazena os dados da carga importada para pr√©-visualiza√ß√£o
            estoquePorData_startDate: '', // Data de in√≠cio para o filtro da aba Estoque por Data
            estoquePorData_endDate: '', // Data de fim para o filtro
            relatorios_selectedCarga: '', // Carga selecionada para o relat√≥rio
            relatorios_cargaProdutos: [], // Produtos da carga selecionada
            movimentacoes_filterDate: '', // Data para filtrar a tela de movimenta√ß√µes
        };

        /**
         * Calcula a cubagem total com base nas dimens√µes do produto e na quantidade.
         * Atualiza o estado 'painelData.cubagem'.
         */
        function calcularCubagemEstoque() {
            const p = ESTOQUE_STATE.painelData;
            const quantidade = parseInt(p.quantidade || 0);

            if (p.comprimento && p.largura && p.bitola && quantidade > 0) {
                const cubagemTotal = quantidade * parseFloat(p.comprimento) * parseFloat(p.largura) * parseFloat(p.bitola);
                // Usar 6 casas decimais para consist√™ncia com a aba de produ√ß√£o
                p.cubagem = cubagemTotal.toFixed(6);
            } else {
                p.cubagem = '';
            }
        }


        /**
         * Carrega os dados iniciais para o m√≥dulo de estoque.
         * Puxa os produtos e as cargas do servidor e prepara o estado.
         */
        async function loadEstoqueData() {
            // Garante que o cache de produtos do app principal est√° dispon√≠vel
            if (!window.App || !App.state.cache.produtos || App.state.cache.produtos.length === 0) {
                App.ui.showNotification("Carregando cat√°logo de produtos do servidor...", "info");
                await App.logic.loadProdutos();
            }

            // Mapeia os produtos do cache principal para o formato do estado de estoque
            ESTOQUE_STATE.products = App.state.cache.produtos.map(p => {
                const familia = App.state.cache.familias.find(f => f.FamiliaID === p.FamiliaID);
                return {
                    codigo: p.Codigo,
                    nome: p.Descricao,
                    comprimento: (p.Comprimento_m || 0).toFixed(3),
                    largura: (p.Largura_m || 0).toFixed(3),
                    bitola: (p.Bitola_m || 0).toFixed(3),
                    familia: familia ? familia.FamiliaNome : 'N/A',
                    qualidade: '1¬∫ QUALIDADE',
                    estoque: 0
                };
            });

            // Carrega as Cargas/Ordens de Produ√ß√£o do servidor usando o novo endpoint
            try {
                const cargasFromServer = await App.utils.apiCall('/api/cargas/completa');
                ESTOQUE_STATE.cargas = cargasFromServer || [];
                console.log(`${ESTOQUE_STATE.cargas.length} cargas carregadas do servidor.`);
            } catch (error) {
                console.error("Falha ao carregar Cargas/OPs do servidor:", error);
                App.ui.showNotification("N√£o foi poss√≠vel carregar as Ordens de Produ√ß√£o.", "warning");
                ESTOQUE_STATE.cargas = []; // Garante que seja um array vazio em caso de erro
            }

            console.log("M√≥dulo de estoque carregado com " + ESTOQUE_STATE.products.length + " produtos.");
        }


        async function initEstoqueTab() {
            if (ESTOQUE_STATE.isInitialized) {
                renderEstoqueApp();
                return;
            }

            // Define as datas padr√£o para os filtros
            const today = new Date().toISOString().split('T')[0];
            const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];

            ESTOQUE_STATE.estoquePorData_startDate = firstDayOfMonth;
            ESTOQUE_STATE.estoquePorData_endDate = today;
            ESTOQUE_STATE.movimentacoes_filterDate = today;

            await loadEstoqueData();

            renderEstoqueApp();
            ESTOQUE_STATE.isInitialized = true;
        }

        function renderEstoqueApp() {
            const container = document.getElementById('estoque-container');
            if (!container) return;

            const tabs = [
                { id: 'painel', name: 'Painel Lan√ßamento' },
                { id: 'produtos', name: 'Consulta Produtos' },
                { id: 'movimentacoes', name: 'Movimenta√ß√µes' },
                { id: 'carga', name: 'Painel Carga' },
                { id: 'estoque-data', name: 'Estoque por Data' },
                { id: 'relatorios', name: 'Relat√≥rios' }
            ];

            let activeContent = '';
            switch (ESTOQUE_STATE.activeTab) {
                case 'painel': activeContent = renderPainelEstoque(); break;
                case 'produtos': activeContent = renderProdutosEstoque(); break;
                case 'movimentacoes': activeContent = renderMovimentacoesEstoque(); break;
                case 'carga': activeContent = renderPainelCargaEstoque(); break;
                case 'estoque-data': activeContent = renderEstoquePorData(); break;
                case 'relatorios': activeContent = renderRelatoriosEstoque(); break;
                default: activeContent = `<div>Aba n√£o encontrada</div>`;
            }

            container.innerHTML = `
        <div class="card" style="padding: 1rem; margin-bottom: 1rem; border-top: none;">
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                ${tabs.map(tab => `
                    <button
                        onclick="setEstoqueActiveTab('${tab.id}')"
                        class="btn ${ESTOQUE_STATE.activeTab === tab.id ? 'btn-primary' : 'btn-secondary'}"
                    >
                        ${tab.name}
                    </button>
                `).join('')}
            </div>
        </div>
        <div>
            ${activeContent}
        </div>
    `;
            setupEstoqueEventListeners();
        }

        function setEstoqueActiveTab(tabId) {
            ESTOQUE_STATE.activeTab = tabId;
            ESTOQUE_STATE.importedCargasPreview = null; // Limpa a pr√©-visualiza√ß√£o ao trocar de aba
            renderEstoqueApp();
        }

        /**
         * Atualiza apenas a √°rea de preview do produto no painel, sem redesenhar a tela toda.
         */
        function updatePainelProdutoPreview() {
            const p = ESTOQUE_STATE.painelData;
            const previewContainer = document.getElementById('painel_produto_preview');
            if (!previewContainer) return;

            if (p.nome) {
                previewContainer.className = 'alert alert-info';
                previewContainer.style.marginTop = '1rem';
                previewContainer.innerHTML = `
            <h4 style="margin-bottom: 0.5rem; font-weight: bold;">PRODUTO SELECIONADO:</h4>
            <p><strong>Nome:</strong> ${p.nome}</p>
            <p><strong>Fam√≠lia:</strong> ${p.familia} | <strong>Qualidade:</strong> ${p.qualidade}</p>
            <p><strong>Dimens√µes:</strong> ${p.comprimento} √ó ${p.largura} √ó ${p.bitola}</p>
        `;
            } else if (p.codigo) { // Se o c√≥digo foi digitado mas n√£o achou produto
                previewContainer.className = 'alert alert-warning';
                previewContainer.style.marginTop = '1rem';
                previewContainer.innerHTML = `<p>Produto com c√≥digo <strong>${p.codigo}</strong> n√£o encontrado.</p>`;
            } else {
                previewContainer.className = '';
                previewContainer.style.marginTop = '';
                previewContainer.innerHTML = '';
            }
        }


        // Fun√ß√µes de renderiza√ß√£o com CSS adaptado
        function renderPainelEstoque() {
            const p = ESTOQUE_STATE.painelData;
            const isTransferencia = p.movimento === 'TRANSFER√äNCIA';

            const formEntradaSaida = `
        <div class="form-row">
            <div class="form-group">
                <label for="painel_op">ORDEM DE PRODU√á√ÉO</label>
                <input type="text" id="painel_op" list="cargas-list" value="${p.ordemProducao || ''}" placeholder="(Selecione da lista ou digite)" autocomplete="off">
            </div>
            <div class="form-group">
                <label for="painel_cubagem">CUBAGEM (m¬≥)</label>
                <input type="number" step="0.001" id="painel_cubagem" value="${p.cubagem || ''}" readonly style="background-color: #e9ecef;">
            </div>
            <div class="form-group" style="align-self: flex-end;">
                <button id="btn_salvar_mov" class="btn btn-success" style="width: 100%;">SALVAR</button>
            </div>
        </div>
    `;

            const formTransferencia = `
         <div class="form-row">
            <div class="form-group">
                <label for="painel_op_origem">ORIGEM</label>
                <input type="text" id="painel_op_origem" list="cargas-list-origem" value="${p.ordemProducaoOrigem || ''}" placeholder="ESTOQUE ou Carga de Origem" autocomplete="off">
                 <datalist id="cargas-list-origem">
                    <option value="ESTOQUE"></option>
                    ${(ESTOQUE_STATE.cargas || []).map(carga => `<option value="${carga.CargaCompleta}"></option>`).join('')}
                </datalist>
            </div>
            <div class="form-group">
                <label for="painel_op_destino">DESTINO</label>
                <input type="text" id="painel_op_destino" list="cargas-list-destino" value="${p.ordemProducaoDestino || ''}" placeholder="ESTOQUE ou Carga de Destino" autocomplete="off">
                <datalist id="cargas-list-destino">
                    <option value="ESTOQUE"></option>
                     ${(ESTOQUE_STATE.cargas || []).map(carga => `<option value="${carga.CargaCompleta}"></option>`).join('')}
                </datalist>
            </div>
            <div class="form-group" style="align-self: flex-end;">
                <button id="btn_salvar_mov" class="btn btn-success" style="width: 100%;">SALVAR TRANSFER√äNCIA</button>
            </div>
        </div>
    `;


            return `
    <div class="card">
        <h3>Registrar Movimenta√ß√£o de Estoque</h3>
        <div class="form-row">
            <div class="form-group">
                <label for="painel_codigo">C√ìDIGO</label>
                <input type="number" id="painel_codigo" value="${p.codigo || ''}">
            </div>
            <div class="form-group">
                <label for="painel_quantidade">QUANTIDADE</label>
                <input type="number" id="painel_quantidade" value="${p.quantidade || ''}">
            </div>
            <div class="form-group">
                <label for="painel_movimento">MOVIMENTO</label>
                <select id="painel_movimento">
                    <option value="ENTRADA" ${p.movimento === 'ENTRADA' ? 'selected' : ''}>ENTRADA</option>
                    <option value="SA√çDA" ${p.movimento === 'SA√çDA' ? 'selected' : ''}>SA√çDA</option>
                    <option value="TRANSFER√äNCIA" ${p.movimento === 'TRANSFER√äNCIA' ? 'selected' : ''}>TRANSFER√äNCIA</option>
                    <option value="REPROCESSO" ${p.movimento === 'REPROCESSO' ? 'selected' : ''}>REPROCESSO</option>
                </select>
            </div>
            <div class="form-group">
                <label for="painel_data">DATA</label>
                <input type="date" id="painel_data" value="${p.data}">
            </div>
        </div>
        
        <div id="form-container">
            ${isTransferencia ? formTransferencia : formEntradaSaida}
        </div>

        <datalist id="cargas-list">
             ${(ESTOQUE_STATE.cargas || []).map(carga => `<option value="${carga.CargaCompleta}"></option>`).join('')}
        </datalist>

        <div id="painel_produto_preview">
            ${p.nome ? `
            <div class="alert alert-info" style="margin-top: 1rem;">
                <h4 style="margin-bottom: 0.5rem; font-weight: bold;">PRODUTO SELECIONADO:</h4>
                <p><strong>Nome:</strong> ${p.nome}</p>
                <p><strong>Fam√≠lia:</strong> ${p.familia} | <strong>Qualidade:</strong> ${p.qualidade}</p>
                <p><strong>Dimens√µes:</strong> ${p.comprimento} √ó ${p.largura} √ó ${p.bitola}</p>
            </div>` : ''}
        </div>
    </div>`;
        }

        function renderProdutosEstoque() {
            const filteredProducts = ESTOQUE_STATE.products.filter(p => {
                const s = ESTOQUE_STATE.searchTerm.toLowerCase();
                const q = ESTOQUE_STATE.filterQuality;
                return (p.nome.toLowerCase().includes(s) || p.codigo.toString().includes(s)) && (!q || p.qualidade === q);
            });

            return `
    <div class="card">
        <h3>Consulta de Produtos em Estoque</h3>
        <div class="form-row">
            <div class="form-group">
                <label for="search_produto">Buscar por Nome ou C√≥digo</label>
                <input type="text" id="search_produto" placeholder="Digite para buscar..." value="${ESTOQUE_STATE.searchTerm}">
            </div>
            <div class="form-group">
                <label for="filter_qualidade">Filtrar por Qualidade</label>
                <select id="filter_qualidade">
                    <option value="">Todas as qualidades</option>
                    <option value="1¬∫ QUALIDADE" ${ESTOQUE_STATE.filterQuality === '1¬∫ QUALIDADE' ? 'selected' : ''}>1¬∫ QUALIDADE</option>
                    <option value="2¬∫ QUALIDADE" ${ESTOQUE_STATE.filterQuality === '2¬∫ QUALIDADE' ? 'selected' : ''}>2¬∫ QUALIDADE</option>
                </select>
            </div>
        </div>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>C√≥digo</th>
                        <th>Nome</th>
                        <th>Dimens√µes</th>
                        <th>Qualidade</th>
                        <th>Estoque</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredProducts.map(p => `
                    <tr>
                        <td>#${p.codigo}</td>
                        <td>${p.nome}</td>
                        <td>${p.comprimento}√ó${p.largura}√ó${p.bitola}</td>
                        <td>${p.qualidade}</td>
                        <td><strong>${p.estoque}</strong></td>
                    </tr>`).join('')}
                </tbody>
            </table>
        </div>
    </div>`;
        }

        function renderMovimentacoesEstoque() {
            const filterDate = ESTOQUE_STATE.movimentacoes_filterDate;

            const filteredMovimentations = ESTOQUE_STATE.movimentations.filter(m => {
                if (!filterDate) return true; // Se n√£o houver data, mostra tudo
                return m.isoDate === filterDate;
            }).sort((a, b) => b.id - a.id); // Ordena pela mais recente

            const dateFilterUI = `
        <div class="form-row" style="margin-bottom: 1.5rem; justify-content: flex-start;">
            <div class="form-group" style="max-width: 250px;">
                <label for="movimentacoes_filter_date">Filtrar por Dia</label>
                <input type="date" id="movimentacoes_filter_date" value="${filterDate}">
            </div>
        </div>
    `;

            return `
    <div class="card">
        <h3>Hist√≥rico de Movimenta√ß√µes</h3>
        ${dateFilterUI}
        <div class="table-container">
            <table class="table">
                <thead><tr><th>Data/Hora</th><th>C√≥digo</th><th>Produto</th><th>Qtd.</th><th>Movimento</th><th>OP</th><th>Observa√ß√£o</th></tr></thead>
                <tbody>
                    ${filteredMovimentations.length > 0 ? filteredMovimentations.map(m => `
                    <tr>
                        <td>${m.dataHora}</td>
                        <td>#${m.codigo}</td>
                        <td>${m.nome}</td>
                        <td>${m.quantidade}</td>
                        <td><span style="background-color: ${m.movimento.toUpperCase().includes('ENTRADA') ? 'var(--success-color)' : m.movimento.toUpperCase() === 'TRANSFER√äNCIA' ? 'var(--info-color)' : 'var(--warning-color)'}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">${m.movimento}</span></td>
                        <td>${m.ordemProducao}</td>
                        <td>${m.observacao}</td>
                    </tr>`).join('') : `<tr><td colspan="7" style="text-align: center;">Nenhuma movimenta√ß√£o encontrada para esta data.</td></tr>`}
                </tbody>
            </table>
        </div>
    </div>`;
        }

        function renderPainelCargaEstoque() {
            // Bot√£o de importa√ß√£o
            const importSection = `
        <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
             <button class="btn btn-info" id="btn_trigger_import">Importar Cargas (.csv/.xlsx)</button>
             <input type="file" id="carga_file_input" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" style="display: none;" />
             <span style="font-size: 0.9rem; color: #555;">Importe um arquivo com as colunas "C√≥digo" e "Descri√ß√£o".</span>
        </div>
    `;

            // Pr√©-visualiza√ß√£o dos dados importados
            let previewSection = '';
            if (ESTOQUE_STATE.importedCargasPreview) {
                previewSection = `
            <div class="card" style="margin-top: 1rem; border-top-color: var(--warning-color);">
                <h4>Pr√©-visualiza√ß√£o da Importa√ß√£o (${ESTOQUE_STATE.importedCargasPreview.length} registros)</h4>
                <p>Apenas as duas primeiras colunas (C√≥digo e Descri√ß√£o) ser√£o enviadas ao servidor.</p>
                <div class="table-container" style="max-height: 300px; margin-top: 1rem;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>C√≥digo da Carga</th>
                                <th>Descri√ß√£o da Carga</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ESTOQUE_STATE.importedCargasPreview.map(item => `
                                <tr>
                                    <td>${item.CargaCodigo}</td>
                                    <td>${item.CargaDescricao}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 1rem; text-align: right;">
                    <button class="btn btn-secondary" onclick="cancelCargaImport()">Cancelar</button>
                    <button class="btn btn-success" id="btn_send_import">Confirmar e Enviar ao Servidor</button>
                </div>
            </div>
        `;
            }

            // Tabela principal de cargas (do estado)
            const mainTable = `
        <div class="table-container">
            <table class="table">
                <thead><tr><th>C√≥digo</th><th>Nome</th><th>Fam√≠lia</th><th>Qtd.</th><th>Cubagem (m¬≥)</th><th>OP</th><th>Data</th></tr></thead>
                <tbody>
                    ${ESTOQUE_STATE.painelCarga.length > 0 ? ESTOQUE_STATE.painelCarga.map(item => `
                    <tr>
                        <td>#${item.codigo}</td>
                        <td>${item.nome}</td>
                        <td>${item.familia}</td>
                        <td>${item.quantidade}</td>
                        <td>${item.cubagem.toFixed(3)}</td>
                        <td>${item.ordemProducao}</td>
                        <td>${new Date(item.data + 'T12:00:00').toLocaleDateString('pt-BR')}</td>
                    </tr>`).join('') : `<tr><td colspan="7" style="text-align: center;">Nenhuma carga no painel.</td></tr>`}
                </tbody>
            </table>
        </div>
    `;

            return `
    <div class="card">
        <h3>Painel de Carga - Controle por OP</h3>
        ${importSection}
        ${previewSection}
        ${!previewSection ? mainTable : ''}
    </div>`;
        }

        function renderEstoquePorData() {
            // Fun√ß√£o auxiliar para converter data BR (dd/MM/yyyy) para objeto Date
            const parseDateBR = (dateStr) => {
                const [day, month, year] = dateStr.split('/');
                return new Date(`${year}-${month}-${day}T12:00:00`); // Adiciona hora para evitar problemas de fuso
            };

            const startDate = new Date(ESTOQUE_STATE.estoquePorData_startDate + 'T00:00:00');
            const endDate = new Date(ESTOQUE_STATE.estoquePorData_endDate + 'T23:59:59');

            // Filtra as datas a serem exibidas com base no intervalo selecionado
            const allDates = [...new Set(ESTOQUE_STATE.estoquePorData.flatMap(item => Object.keys(item.movimentos)))]
                .filter(dateStr => {
                    const date = parseDateBR(dateStr);
                    return date >= startDate && date <= endDate;
                })
                .sort((a, b) => parseDateBR(b) - parseDateBR(a)); // Ordena da mais recente para a mais antiga

            const dateFilterUI = `
        <div class="form-row" style="margin-bottom: 1.5rem; align-items: flex-end;">
            <div class="form-group">
                <label for="estoque_data_inicio">Data de In√≠cio</label>
                <input type="date" id="estoque_data_inicio" value="${ESTOQUE_STATE.estoquePorData_startDate}">
            </div>
            <div class="form-group">
                <label for="estoque_data_fim">Data de Fim</label>
                <input type="date" id="estoque_data_fim" value="${ESTOQUE_STATE.estoquePorData_endDate}">
            </div>
        </div>
    `;

            return `
    <div class="card">
        <h3>Estoque 1¬∫ - Controle por Data</h3>
        ${dateFilterUI}
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>C√≥digo</th>
                        <th>Nome</th>
                        <th>Estoque Inicial</th>
                        <th>Estoque Final</th>
                        ${allDates.map(data => `<th>${data}<br>ENTRADA</th><th>${data}<br>SA√çDA</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${ESTOQUE_STATE.estoquePorData.map(item => `
                    <tr>
                        <td>#${item.codigo}</td>
                        <td>${item.nome}</td>
                        <td>${item.estoqueInicial}</td>
                        <td><strong>${item.estoqueAtual}</strong></td>
                        ${allDates.map(data => `
                            <td style="background-color: #f0fff4;">${item.movimentos[data]?.entrada || 0}</td>
                            <td style="background-color: #fff5f5;">${item.movimentos[data]?.saida || 0}</td>
                        `).join('')}
                    </tr>`).join('')}
                </tbody>
            </table>
        </div>
    </div>`;
        }

        function renderRelatoriosEstoque() {
            const summaryCards = `
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">${ESTOQUE_STATE.products.filter(p => p.qualidade === '1¬∫ QUALIDADE').length}</div>
                <div>Produtos de 1¬™ Qualidade</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, var(--warning-color), #f59e0b);">
                 <div class="stat-value">${ESTOQUE_STATE.products.filter(p => p.qualidade === '2¬∫ QUALIDADE').length}</div>
                <div>Produtos de 2¬™ Qualidade</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, var(--info-color), #0e7490);">
                <div class="stat-value">${ESTOQUE_STATE.painelCarga.length}</div>
                <div>Itens em Carga</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, var(--dark-color), #374151);">
                <div class="stat-value">${ESTOQUE_STATE.painelCarga.reduce((s, p) => s + p.cubagem, 0).toFixed(3)} m¬≥</div>
                <div>Cubagem Total em Carga</div>
            </div>
        </div>
    `;

            let reportResultTable = '';
            if (ESTOQUE_STATE.relatorios_selectedCarga) {
                if (ESTOQUE_STATE.relatorios_cargaProdutos.length > 0) {
                    reportResultTable = `
                <div class="table-container" style="margin-top: 1rem;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Nome do Produto</th>
                                <th>Quantidade</th>
                                <th>Cubagem (m¬≥)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ESTOQUE_STATE.relatorios_cargaProdutos.map(item => `
                                <tr>
                                    <td>#${item.codigo}</td>
                                    <td>${item.nome}</td>
                                    <td><strong>${item.quantidade}</strong></td>
                                    <td>${item.cubagem.toFixed(3)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
                } else {
                    reportResultTable = `<div class="alert alert-warning" style="margin-top: 1rem;">Nenhum produto encontrado para a carga selecionada.</div>`;
                }
            } else {
                reportResultTable = `<div class="alert alert-info" style="margin-top: 1rem;">Selecione uma carga para visualizar os produtos.</div>`;
            }


            const cargaReportSection = `
        <div class="card" style="margin-top: 2rem;">
            <h3>Relat√≥rio por Carga</h3>
            <div class="form-group">
                <label for="relatorio_carga_select">Selecione a Carga / Ordem de Produ√ß√£o</label>
                <select id="relatorio_carga_select">
                    <option value="">-- Selecione --</option>
                    ${(ESTOQUE_STATE.cargas || []).map(carga => `
                        <option value="${carga.CargaCompleta}" ${ESTOQUE_STATE.relatorios_selectedCarga === carga.CargaCompleta ? 'selected' : ''}>
                            ${carga.CargaCompleta}
                        </option>
                    `).join('')}
                </select>
            </div>
            ${reportResultTable}
        </div>
    `;


            return `
        ${summaryCards}
        ${cargaReportSection}
    `;
        }

        /**
         * Helper para criar um timestamp padronizado para as movimenta√ß√µes.
         * @returns {{display: string, isoDate: string}}
         */
        function getFormattedDateTime() {
            const now = new Date();
            const YYYY = now.getFullYear();
            const MM = String(now.getMonth() + 1).padStart(2, '0');
            const DD = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const mm = String(now.getMinutes()).padStart(2, '0');
            const ss = String(now.getSeconds()).padStart(2, '0');
            return {
                display: `${DD}/${MM}/${YYYY} ${hh}:${mm}:${ss}`,
                isoDate: `${YYYY}-${MM}-${DD}`
            };
        }


        // L√≥gica de salvamento e atualiza√ß√£o com notifica√ß√µes
        function salvarMovimentacaoEstoque() {
            try {
                const movimento = ESTOQUE_STATE.painelData.movimento;

                if (movimento === 'TRANSFER√äNCIA') {
                    processarTransferencia();
                } else {
                    processarEntradaSaida();
                }

                // Limpeza do formul√°rio ap√≥s sucesso
                const painelData = ESTOQUE_STATE.painelData;
                painelData.codigo = '';
                painelData.quantidade = '';
                painelData.cubagem = '';
                painelData.ordemProducao = '';
                painelData.ordemProducaoOrigem = '';
                painelData.ordemProducaoDestino = '';
                painelData.nome = '';

                App.ui.showNotification('Movimenta√ß√£o registrada com sucesso!', 'success');
                renderEstoqueApp();
                document.getElementById('painel_codigo').focus();

            } catch (error) {
                console.error('Erro ao salvar:', error);
                App.ui.showNotification(error.message || 'Erro ao processar movimenta√ß√£o!', 'error');
            }
        }

        function processarEntradaSaida() {
            const { codigo, quantidade, ordemProducao } = ESTOQUE_STATE.painelData;
            if (!codigo || !quantidade) {
                throw new Error('C√≥digo e Quantidade s√£o obrigat√≥rios!');
            }
            const produto = ESTOQUE_STATE.products.find(p => p.codigo.toString() === codigo.toString());
            if (!produto) {
                throw new Error('Produto n√£o encontrado!');
            }
            const op = ordemProducao.trim() || "ESTOQUE";

            // A l√≥gica de Entrada/Sa√≠da afeta o estoque total
            atualizarEstoque1Q(produto);
            atualizarPainelCarga(produto, op);
            registrarMovimentacao(produto, op);
        }

        function processarTransferencia() {
            const { codigo, quantidade, ordemProducaoOrigem, ordemProducaoDestino } = ESTOQUE_STATE.painelData;

            if (!codigo || !quantidade) throw new Error('C√≥digo e Quantidade s√£o obrigat√≥rios!');
            const produto = ESTOQUE_STATE.products.find(p => p.codigo.toString() === codigo.toString());
            if (!produto) throw new Error('Produto n√£o encontrado!');

            const origem = ordemProducaoOrigem.trim();
            const destino = ordemProducaoDestino.trim();

            if (!origem || !destino) throw new Error('Origem e Destino s√£o obrigat√≥rios para transfer√™ncia.');
            if (origem === destino) throw new Error('Origem e Destino n√£o podem ser iguais.');

            const qtd = parseInt(quantidade);
            const cubagemTotal = parseFloat(ESTOQUE_STATE.painelData.cubagem);

            // L√≥gica de Origem
            if (origem !== 'ESTOQUE') {
                const itemIndex = ESTOQUE_STATE.painelCarga.findIndex(item => item.codigo === produto.codigo && item.ordemProducao === origem);
                if (itemIndex === -1) throw new Error(`Carga de Origem (${origem}) n√£o encontrada no painel.`);

                const itemOrigem = ESTOQUE_STATE.painelCarga[itemIndex];
                if (qtd > itemOrigem.quantidade) throw new Error(`Quantidade a transferir (${qtd}) maior que o saldo na origem (${itemOrigem.quantidade}).`);

                const cubagemPorUnidade = itemOrigem.cubagem / itemOrigem.quantidade;
                itemOrigem.quantidade -= qtd;
                itemOrigem.cubagem -= cubagemPorUnidade * qtd;
                if (itemOrigem.quantidade <= 0) {
                    ESTOQUE_STATE.painelCarga.splice(itemIndex, 1);
                }
            }

            // L√≥gica de Destino
            if (destino !== 'ESTOQUE') {
                let itemDestino = ESTOQUE_STATE.painelCarga.find(item => item.codigo === produto.codigo && item.ordemProducao === destino);
                if (itemDestino) {
                    itemDestino.quantidade += qtd;
                    itemDestino.cubagem += cubagemTotal;
                } else {
                    ESTOQUE_STATE.painelCarga.push({
                        codigo: produto.codigo,
                        nome: produto.nome,
                        familia: produto.familia,
                        quantidade: qtd,
                        cubagem: cubagemTotal,
                        ordemProducao: destino,
                        data: ESTOQUE_STATE.painelData.data
                    });
                }
            }

            // Registrar a movimenta√ß√£o de transfer√™ncia
            const timestamp = getFormattedDateTime();
            const newId = (ESTOQUE_STATE.movimentations[0]?.id || 0) + 1;
            ESTOQUE_STATE.movimentations.unshift({
                id: newId,
                dataHora: timestamp.display,
                isoDate: timestamp.isoDate,
                codigo: produto.codigo,
                nome: produto.nome,
                quantidade: qtd,
                movimento: 'TRANSFER√äNCIA',
                ordemProducao: `DE: ${origem} / PARA: ${destino}`, // Campo OP usado para descri√ß√£o
                observacao: `TRANSFER√äNCIA ENTRE CARGAS`
            });
        }


        function atualizarEstoque1Q(produto) {
            const dataKey = new Date(ESTOQUE_STATE.painelData.data + 'T12:00:00').toLocaleDateString('pt-BR');
            const isEntrada = ESTOQUE_STATE.painelData.movimento.toUpperCase().includes('ENTRADA');
            const quantidade = parseInt(ESTOQUE_STATE.painelData.quantidade);

            let itemEstoque = ESTOQUE_STATE.estoquePorData.find(item => item.codigo === produto.codigo);
            if (!itemEstoque) {
                itemEstoque = { codigo: produto.codigo, nome: produto.nome, familia: produto.familia, estoqueInicial: 0, estoqueAtual: produto.estoque || 0, movimentos: {} };
                ESTOQUE_STATE.estoquePorData.push(itemEstoque);
            }

            if (!itemEstoque.movimentos[dataKey]) {
                itemEstoque.movimentos[dataKey] = { entrada: 0, saida: 0 };
            }

            if (isEntrada) {
                itemEstoque.movimentos[dataKey].entrada += quantidade;
                itemEstoque.estoqueAtual += quantidade;
            } else {
                if (itemEstoque.estoqueAtual < quantidade) {
                    throw new Error(`Estoque insuficiente para ${produto.nome}. Saldo: ${itemEstoque.estoqueAtual}`);
                }
                itemEstoque.movimentos[dataKey].saida += quantidade;
                itemEstoque.estoqueAtual -= quantidade;
            }

            const productIndex = ESTOQUE_STATE.products.findIndex(p => p.codigo === produto.codigo);
            if (productIndex !== -1) {
                ESTOQUE_STATE.products[productIndex].estoque = itemEstoque.estoqueAtual;
            }
        }

        function atualizarPainelCarga(produto, ordemProducao) {
            const quantidade = parseInt(ESTOQUE_STATE.painelData.quantidade);
            const cubagem = parseFloat(ESTOQUE_STATE.painelData.cubagem) || 0;
            const isEntrada = ESTOQUE_STATE.painelData.movimento.toUpperCase().includes('ENTRADA');

            if (ordemProducao === 'ESTOQUE') return;

            if (isEntrada) {
                if (cubagem <= 0) {
                    App.ui.showNotification('CUBAGEM n√£o informada para ENTRADA em Ordem de Produ√ß√£o.', 'warning');
                    throw new Error("Cubagem inv√°lida para OP");
                }
                let itemCarga = ESTOQUE_STATE.painelCarga.find(item => item.codigo === produto.codigo && item.ordemProducao === ordemProducao);
                if (itemCarga) {
                    itemCarga.quantidade += quantidade;
                    itemCarga.cubagem += cubagem;
                } else {
                    ESTOQUE_STATE.painelCarga.push({ codigo: produto.codigo, nome: produto.nome, familia: produto.familia, quantidade, cubagem, ordemProducao, data: ESTOQUE_STATE.painelData.data });
                }
            } else {
                const itemIndex = ESTOQUE_STATE.painelCarga.findIndex(item => item.codigo === produto.codigo && item.ordemProducao === ordemProducao);
                if (itemIndex === -1) {
                    App.ui.showNotification(`SA√çDA bloqueada: item (C√ìDIGO ${produto.codigo} + OP ${ordemProducao}) n√£o encontrado no Painel Carga.`, 'error');
                    throw new Error("Item de carga n√£o encontrado");
                }
                const itemCarga = ESTOQUE_STATE.painelCarga[itemIndex];
                if (quantidade > itemCarga.quantidade) {
                    App.ui.showNotification(`SA√çDA bloqueada: quantidade (${quantidade}) maior que o saldo (${itemCarga.quantidade}).`, 'error');
                    throw new Error("Quantidade insuficiente");
                }
                const perUnit = itemCarga.cubagem / itemCarga.quantidade;
                itemCarga.quantidade -= quantidade;
                itemCarga.cubagem -= perUnit * quantidade;
                if (itemCarga.quantidade <= 0) {
                    ESTOQUE_STATE.painelCarga.splice(itemIndex, 1);
                }
            }
        }

        function registrarMovimentacao(produto, ordemProducao) {
            const movimento = ESTOQUE_STATE.painelData.movimento.toUpperCase();
            let observacao = `OP: ${ordemProducao}`;
            if (movimento.includes('ENTRADA')) {
                observacao = `ORIGEM: PRODU√á√ÉO | DESTINO: ${ordemProducao}`;
            } else {
                observacao = `ORIGEM: ${ordemProducao} | DESTINO: CARREGAMENTO`;
            }

            const newId = (ESTOQUE_STATE.movimentations[0]?.id || 0) + 1;
            const timestamp = getFormattedDateTime();

            ESTOQUE_STATE.movimentations.unshift({
                id: newId,
                dataHora: timestamp.display,
                isoDate: timestamp.isoDate,
                codigo: produto.codigo,
                nome: produto.nome,
                quantidade: parseInt(ESTOQUE_STATE.painelData.quantidade),
                movimento: ESTOQUE_STATE.painelData.movimento,
                ordemProducao,
                observacao
            });
        }

        // --- NOVAS FUN√á√ïES PARA IMPORTA√á√ÉO DE CARGA ---

        function triggerCargaImport() { App.utils.$('#carga_file_input').click(); }
        function cancelCargaImport() {
            ESTOQUE_STATE.importedCargasPreview = null;
            App.utils.$('#carga_file_input').value = '';
            renderEstoqueApp();
        }
        function handleCargaFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    if (jsonData.length < 2) throw new Error("O arquivo est√° vazio ou n√£o cont√©m dados.");
                    const header = jsonData[0], firstColName = header[0], secondColName = header[1];
                    const dataRows = XLSX.utils.sheet_to_json(worksheet);
                    const extractedData = dataRows.map(row => ({ CargaCodigo: row[firstColName] || '', CargaDescricao: row[secondColName] || '' })).filter(item => item.CargaCodigo);
                    if (extractedData.length === 0) throw new Error("Nenhuma linha com c√≥digo de carga foi encontrada no arquivo.");
                    ESTOQUE_STATE.importedCargasPreview = extractedData;
                    renderEstoqueApp();
                } catch (error) {
                    console.error("Erro ao importar arquivo de carga:", error);
                    App.ui.showNotification(`Erro ao ler o arquivo: ${error.message}`, "error");
                    cancelCargaImport();
                }
            };
            reader.readAsArrayBuffer(file);
        }
        async function sendImportedCargas() {
            const dataToSend = ESTOQUE_STATE.importedCargasPreview;
            if (!dataToSend || dataToSend.length === 0) {
                App.ui.showNotification("N√£o h√° dados de carga para enviar.", "warning"); return;
            }
            try {
                const response = await App.utils.apiCall('/api/cargas/import', { method: 'POST', body: JSON.stringify(dataToSend) });
                App.ui.showNotification(response.message || "Cargas importadas com sucesso!", "success");
                await loadEstoqueData();
                cancelCargaImport();
            } catch (error) {
                console.error("Falha ao enviar cargas para o servidor:", error);
                App.ui.showNotification(`Erro no servidor: ${error.message}`, "error");
            }
        }

        // --- NOVA FUN√á√ÉO PARA O RELAT√ìRIO POR CARGA ---
        function handleCargaReportFilter(event) {
            const selectedCarga = event.target.value;
            ESTOQUE_STATE.relatorios_selectedCarga = selectedCarga;
            if (!selectedCarga) {
                ESTOQUE_STATE.relatorios_cargaProdutos = [];
            } else {
                ESTOQUE_STATE.relatorios_cargaProdutos = ESTOQUE_STATE.painelCarga.filter(item => item.ordemProducao === selectedCarga);
            }
            renderEstoqueApp();
        }

        // Event Listeners
        function setupEstoqueEventListeners() {
            const codigoInput = App.utils.$('#painel_codigo');
            if (codigoInput) {
                // CORRE√á√ÉO: Usar onblur para evitar redesenho durante a digita√ß√£o
                codigoInput.onblur = (e) => {
                    const codigo = e.target.value;
                    // Se o c√≥digo n√£o mudou, n√£o faz nada
                    if (codigo === ESTOQUE_STATE.painelData.codigo) return;

                    const produto = ESTOQUE_STATE.products.find(p => p.codigo.toString() === codigo);
                    const painelData = ESTOQUE_STATE.painelData;
                    painelData.codigo = codigo;
                    painelData.nome = produto?.nome || '';
                    painelData.familia = produto?.familia || '';
                    painelData.qualidade = produto?.qualidade || '';
                    painelData.comprimento = produto?.comprimento || '';
                    painelData.largura = produto?.largura || '';
                    painelData.bitola = produto?.bitola || '';

                    calcularCubagemEstoque();

                    // ATUALIZA√á√ÉO CIR√öRGICA: Apenas atualiza a √°rea de preview e cubagem
                    updatePainelProdutoPreview();
                    const cubagemEl = App.utils.$('#painel_cubagem');
                    if (cubagemEl) cubagemEl.value = ESTOQUE_STATE.painelData.cubagem;
                };
                codigoInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        e.target.blur(); // Dispara o onblur para carregar os dados do produto
                        document.getElementById('painel_quantidade').focus();
                    }
                });
            }

            const quantidadeInput = App.utils.$('#painel_quantidade');
            if (quantidadeInput) {
                quantidadeInput.oninput = e => {
                    ESTOQUE_STATE.painelData.quantidade = e.target.value;
                    calcularCubagemEstoque();
                    const cubagemEl = App.utils.$('#painel_cubagem');
                    if (cubagemEl) cubagemEl.value = ESTOQUE_STATE.painelData.cubagem;
                };
                quantidadeInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') document.getElementById('painel_movimento').focus(); });
            }

            const movimentoSelect = App.utils.$('#painel_movimento');
            if (movimentoSelect) {
                movimentoSelect.onchange = e => {
                    ESTOQUE_STATE.painelData.movimento = e.target.value;
                    renderEstoqueApp(); // Re-renderiza para mostrar o formul√°rio correto
                };
            }

            const dataInput = App.utils.$('#painel_data');
            if (dataInput) {
                dataInput.onchange = e => ESTOQUE_STATE.painelData.data = e.target.value;
                dataInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') document.getElementById('painel_op')?.focus() || document.getElementById('painel_op_origem')?.focus(); });
            }

            // Listeners para os diferentes formul√°rios
            const opInput = App.utils.$('#painel_op');
            if (opInput) {
                opInput.onchange = e => ESTOQUE_STATE.painelData.ordemProducao = e.target.value;
                opInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') document.getElementById('btn_salvar_mov').focus(); });
            }
            const opOrigemInput = App.utils.$('#painel_op_origem');
            if (opOrigemInput) {
                opOrigemInput.onchange = e => ESTOQUE_STATE.painelData.ordemProducaoOrigem = e.target.value;
                opOrigemInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') document.getElementById('painel_op_destino').focus(); });
            }
            const opDestinoInput = App.utils.$('#painel_op_destino');
            if (opDestinoInput) {
                opDestinoInput.onchange = e => ESTOQUE_STATE.painelData.ordemProducaoDestino = e.target.value;
                opDestinoInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') document.getElementById('btn_salvar_mov').focus(); });
            }

            const btnSalvar = App.utils.$('#btn_salvar_mov');
            if (btnSalvar) {
                btnSalvar.onclick = salvarMovimentacaoEstoque;
                btnSalvar.addEventListener('keydown', (e) => { if (e.key === 'Enter') salvarMovimentacaoEstoque(); });
            }

            const searchInput = App.utils.$('#search_produto');
            if (searchInput) searchInput.oninput = e => { ESTOQUE_STATE.searchTerm = e.target.value; renderEstoqueApp(); };
            const filterQualidade = App.utils.$('#filter_qualidade');
            if (filterQualidade) filterQualidade.onchange = e => { ESTOQUE_STATE.filterQuality = e.target.value; renderEstoqueApp(); };

            const btnTriggerImport = App.utils.$('#btn_trigger_import');
            if (btnTriggerImport) btnTriggerImport.onclick = triggerCargaImport;
            const fileInput = App.utils.$('#carga_file_input');
            if (fileInput) fileInput.onchange = handleCargaFileSelect;
            const btnSendImport = App.utils.$('#btn_send_import');
            if (btnSendImport) btnSendImport.onclick = sendImportedCargas;

            const startDateInput = App.utils.$('#estoque_data_inicio');
            if (startDateInput) startDateInput.onchange = e => { ESTOQUE_STATE.estoquePorData_startDate = e.target.value; renderEstoqueApp(); };
            const endDateInput = App.utils.$('#estoque_data_fim');
            if (endDateInput) endDateInput.onchange = e => { ESTOQUE_STATE.estoquePorData_endDate = e.target.value; renderEstoqueApp(); };

            const relatorioCargaSelect = App.utils.$('#relatorio_carga_select');
            if (relatorioCargaSelect) relatorioCargaSelect.onchange = handleCargaReportFilter;

            const movimentacoesDateInput = App.utils.$('#movimentacoes_filter_date');
            if (movimentacoesDateInput) movimentacoesDateInput.onchange = e => { ESTOQUE_STATE.movimentacoes_filterDate = e.target.value; renderEstoqueApp(); };
        }

        // Adiciona o event listener para a aba de estoque no menu principal
        document.addEventListener('DOMContentLoaded', function () {
            const mainApp = window.App || {};
            const utils = mainApp.utils || { $: (s) => document.querySelector(s) };
            const estoqueTabButton = utils.$('[data-tab="estoque"]');
            if (estoqueTabButton) {
                estoqueTabButton.addEventListener('click', () => initEstoqueTab());
            }
        });

        // =========== FIM: SISTEMA ESTOQUE TAB ===========





    </script>
</body>

</html>